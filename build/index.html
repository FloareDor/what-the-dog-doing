<!doctype html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover"><title>Scotty Survival</title><style>:root{--bg:#0a0d12;--sky:#1a2940;--ink:#ecf3ff;--red:#ef4f6c;--mint:#69f0c9;--gold:#ffd56d;--line:#2f4868}*{box-sizing:border-box}html,body{margin:0;width:100%;height:100%;overflow:hidden;background:var(--bg);color:var(--ink);font-family:Trebuchet MS,Avenir Next,Segoe UI,sans-serif}body{touch-action:none}canvas{display:block;width:100%;height:100%}</style></head><body><canvas id="c"></canvas><script>
(()=>{
  const c=document.getElementById('c'),x=c.getContext('2d');
  let W=360,H=740,DPR=1,last=0;

  const MAP_W=2600,MAP_H=1800;
  const MID_X=MAP_W*.5,MID_Y=MAP_H*.5;
  const HOME={x:260,y:MAP_H*.5,r:170};
  const SAFE_BUILDINGS=[
    {id:'home',n:'Cohon Centre',x:HOME.x,y:HOME.y,r:HOME.r,c:'#8ec0ff'},
    {id:'nsh',n:'NSH',x:980,y:460,r:170,c:'#79d7ff'},
    {id:'mel',n:'Mellon Inst',x:1880,y:1260,r:185,c:'#ffd58f'}
  ];
  const WHO=['i need to go out','these things are scary','may lord help us','can we ever go out?'];
  const WHI=['a dog?','scotty??','what the dog doing?'];
  const JOY_CENTER_SNAP=10;
  const JOY_INPUT_DEAD=.12;
  const JOY_EDGE_PAD=16;
  const JOY_SMOOTH=22;
  const JOY_VIS_SMOOTH=16;
  const MAX_Z=180,MAX_FOOD=260,MAX_FX=420,MAX_PUDD=18,MAX_B=260,MAX_REACT=14;
  const FIRST_BOSS_MIN_KILLS=35;
  const FIRST_BOSS_TRIGGER_KILLS=45;
  const FIRST_BOSS_TRIGGER_TIME=72;
  const LAB_REFRESH_KILLS=50;
  const NSH_THIRD_BOT_INTEL_COST=4;
  const SLINGSHOT_CHARGE_TRIGGER=.25;
  const SLINGSHOT_DASH_MIN=.3;
  const SLINGSHOT_DASH_MAX=.58;
  const SLINGSHOT_DASH_SPEED=560;
  const SLINGSHOT_RECALL_TIME=.42;
  const SLINGSHOT_RECALL_HOME_RATE=7.2;
  const SLINGSHOT_RECALL_BURST_RADIUS=132;
  const SLINGSHOT_PERFECT_WINDOW=.24;
  const SLINGSHOT_AIM_DOT=.82;
  const SLINGSHOT_TRIPLE_BURST_RADIUS=165;

  const imgs={};
  function load(n){const i=new Image();i.src='black_scottish_terrier_dog_with_red_scarf/rotations/'+n+'.png';return i}
  imgs.e=load('east');imgs.w=load('west');imgs.ne=load('north-east');imgs.nw=load('north-west');imgs.se=load('south-east');imgs.sw=load('south-west');

  let audio=0;
  function beep(f,d,t,v){if(!audio)return;const o=audio.createOscillator(),g=audio.createGain();o.type=t||'triangle';o.frequency.value=f;g.gain.value=v||.02;g.gain.exponentialRampToValueAtTime(.0001,audio.currentTime+d);o.connect(g).connect(audio.destination);o.start();o.stop(audio.currentTime+d)}
  let memeT=0;
  function playMeme(){
    if(!g.start)return;
    const now=performance.now();
    if(now-memeT<1200)return;
    memeT=now;
    beep(392,.07,'square',.02);
    beep(523,.08,'triangle',.014);
  }

  const g={
    start:0,dead:0,lvup:0,t:0,time:0,kills:0,
    spawnT:0,nextSpawn:.8,
    msg:'',msgT:0,
    level:1,xp:0,nextXp:24,
    stop:0,shake:0,xpPulse:0,cardT:0,
    best:+localStorage.ss_best||0,
    choices:[],
    homeNeed:3,homeGot:0,
    sch:{nsh:0,mel:0}, // 0 not started, 1 active, 2 done
    pz:0,
    uq:[],
    inB:'',bs:0,bd:0,bs2:0,bd2:0,b2At:0,
    bossDownT:0,
    botMask:0,chemMask:0,
    labStep:0,labBank:0,labFlip:0,
    labNsh:0,labMel:0,
    labNshRuns:0,labMelRuns:0,
    stormCd:0,
    labCd:0
  };

  const p={x:260,y:MAP_H*.5,vx:0,vy:0,r:15,hp:100,maxHp:100,speed:185,fireCd:0,fireRate:.46,dmg:12,range:400,shots:1,magnet:88,face:1,rx:0,ry:0,flash:0,gx:1,gy:0,zc:0,zr:0,zt:0,zx:1,zy:0,zcd:0,zDur:1,zSpd:2.1,zLoad:1.5,zCool:5.5,zDmg:24,zDr:.55,zb:0,zp:0,mkOn:0,mkT:0,mkI:8.8,mkS:0,mkD:14,mkR:54,mkSl:.54,chDo:14,chBurst:10,chHeal:8,chHealCd:0,chHealI:.85,cat:0,catM:0,catType:0,bot:0,botCount:0,botSlots:0,bType:0,bAtk:1,bAuraR:0,bAuraSl:0,bHealCd:0,bHealI:10,bHealAmt:10,bHealFx:0,triA:0,triFx:0,slCharge:0,slFocus:0,slT:0,slRecallT:0,slRecallPulse:0,slCarryVx:0,slCarryVy:0,slPow:0,slWave:0,slComboFx:0,slHitMask:0,slPerfect:0,slDx:1,slDy:0,bx:0,by:0,ba:0,bcd:0,bRate:1.9,bDmg:1.15,bRange:480,bFetch:95,bPull:195,bCarry:0,bCarryMax:2,bGrabCd:0,bGrabI:.38,bPier:4,bSize:6};
  const keys={l:0,r:0,u:0,d:0,gr:0};
  let touchId=-1,touchMove=0;
  const joy={x:78,y:0,r:42,kr:16,tx:0,ty:0,ax:0,ay:0,ttx:0,tty:0,tax:0,tay:0,show:0,act:0};

  const z=[];      // zombies
  const b=[];      // bullets
  const food=[];   // xp drops and static mints
  const pudd=[];   // territory puddles
  const fx=[];     // particles/text dots
  const bots=[];   // companion bot states
  const react=[];  // fused reaction puddles

  function rnd(a,b){return a+Math.random()*(b-a)}
  function clamp(v,a,b){return v<a?a:v>b?b:v}
  function segDist2(px,py,ax,ay,bx,by){
    const dx=bx-ax,dy=by-ay,den=dx*dx+dy*dy||1;
    let t=((px-ax)*dx+(py-ay)*dy)/den;
    t=clamp(t,0,1);
    const cx=ax+dx*t,cy=ay+dy*t,ex=px-cx,ey=py-cy;
    return ex*ex+ey*ey;
  }
  function eob(t){const c1=1.70158,c3=c1+1,u=t-1;return 1+c3*u*u*u+c1*u*u}
  function rr(px,py,pw,ph,pr){
    const r=Math.max(0,Math.min(pr,Math.min(pw,ph)*.5));
    x.beginPath();
    x.moveTo(px+r,py);
    x.lineTo(px+pw-r,py);
    x.quadraticCurveTo(px+pw,py,px+pw,py+r);
    x.lineTo(px+pw,py+ph-r);
    x.quadraticCurveTo(px+pw,py+ph,px+pw-r,py+ph);
    x.lineTo(px+r,py+ph);
    x.quadraticCurveTo(px,py+ph,px,py+ph-r);
    x.lineTo(px,py+r);
    x.quadraticCurveTo(px,py,px+r,py);
    x.closePath();
  }
  function getChoiceLayout(){
    const mobile=W<560;
    const bw=mobile?W-14:Math.min(W-20,620);
    const bh=mobile?clamp(H*.48,296,390):clamp(H*.4,268,340);
    const bx=(W-bw)*.5,by=H-bh-12;
    const rects=[];
    if(mobile){
      const gap=8,cw=bw-22,ch=Math.max(74,Math.min(100,(bh-84-gap*2)/3));
      const sy=by+50;
      for(let i=0;i<3;i++)rects.push({x:bx+14,y:sy+i*(ch+gap),w:cw,h:ch});
    }else{
      const gap=10,cw=(bw-32-gap*2)/3,ch=Math.max(102,Math.min(130,bh-82));
      const sy=by+52;
      for(let i=0;i<3;i++)rects.push({x:bx+16+i*(cw+gap),y:sy,w:cw,h:ch});
    }
    return {mobile,bx,by,bw,bh,rects};
  }
  function drawWrap(txt,px,py,maxW,lineH,maxLines){
    const ws=txt.split(' ');
    let line='',row=0;
    for(let i=0;i<ws.length;i++){
      const test=line?line+' '+ws[i]:ws[i];
      if(x.measureText(test).width<=maxW){line=test;continue;}
      x.fillText(line,px,py+row*lineH);
      row++;
      if(row>=maxLines)return;
      line=ws[i];
    }
    if(row<maxLines&&line)x.fillText(line,px,py+row*lineH);
  }
  function upIcon(n){
    if(n.includes('Buddy')||n.includes('Bot'))return 'ðŸ¤–';
    if(n.includes('Catalyst')||n.includes('Chemical')||n.includes('Acidic'))return 'ðŸ§ª';
    if(n.includes('Heal')||n.includes('Tough'))return 'â¤ï¸';
    if(n.includes('Shock')||n.includes('Zoomies')||n.includes('Rapid')||n.includes('Speed'))return 'âš¡';
    if(n.includes('Magnet'))return 'ðŸ§²';
    if(n.includes('Shot'))return 'ðŸŽ¯';
    if(n.includes('Territory')||n.includes('Puddle')||n.includes('Gravity'))return 'ðŸ’§';
    if(n.includes('Bite'))return 'ðŸ¦´';
    return 'ðŸ› ï¸';
  }
  function school(id){for(let i=0;i<SAFE_BUILDINGS.length;i++)if(SAFE_BUILDINGS[i].id===id)return SAFE_BUILDINGS[i];return 0}
  function safeBuildingAt(px,py,pad){
    const extra=pad||0;
    for(let i=0;i<SAFE_BUILDINGS.length;i++){
      const b=SAFE_BUILDINGS[i],dx=px-b.x,dy=py-b.y;
      if(dx*dx+dy*dy<(b.r+extra)*(b.r+extra))return b;
    }
    return 0;
  }
  function pushOutsideSafe(o,pad){
    const extra=pad||0;
    let hit=0;
    for(let i=0;i<SAFE_BUILDINGS.length;i++){
      const b=SAFE_BUILDINGS[i];
      let dx=o.x-b.x,dy=o.y-b.y,ln=Math.hypot(dx,dy)||1;
      const rr=b.r+extra;
      if(ln<rr){
        if(ln<.001){const a=Math.random()*Math.PI*2;dx=Math.cos(a);dy=Math.sin(a);ln=1;}
        o.x=b.x+dx/ln*rr;
        o.y=b.y+dy/ln*rr;
        hit=1;
      }
    }
    return hit;
  }
  function puzzleLayout(){
    const bw=Math.min(W-24,420),bh=Math.min(H-130,260);
    const bx=(W-bw)*.5,by=(H-bh)*.5+24;
    const gap=10,bw3=(bw-36-gap*2)/3,by2=by+bh-72;
    return{
      bx,by,bw,bh,
      btn:[
        {x:bx+18,y:by2,w:bw3,h:46},
        {x:bx+18+bw3+gap,y:by2,w:bw3,h:46},
        {x:bx+18+(bw3+gap)*2,y:by2,w:bw3,h:46}
      ]
    };
  }
  function puzzleSeq(len){
    const seq=[];
    let prev=-1;
    for(let i=0;i<len;i++){
      let n=(Math.random()*3)|0;
      if(n===prev)n=(n+1+((Math.random()*2)|0))%3;
      seq.push(n);
      prev=n;
    }
    return seq;
  }
  function startPuzzle(id,mode){
    if(g.pz)return;
    if(mode==='lab'&&id==='nsh'){
      const tier=((g.labNshRuns/2)|0)+1;
      const len=4+Math.min(2,tier-1);
      g.pz={id:'nsh',seq:puzzleSeq(len),step:0,lab:1,trial:g.labNshRuns+1,tier};
      g.msg='research';g.msgT=1.2;
    }else if(mode==='lab'&&id==='mel'){
      const tier=((g.labMelRuns/2)|0)+1;
      const len=5+Math.min(2,tier-1);
      g.pz={id:'mel',seq:puzzleSeq(len),step:0,lab:1,trial:g.labMelRuns+1,tier};
      g.msg='research';g.msgT=1.2;
    }else if(id==='nsh'){
      g.pz={id:'nsh',seq:puzzleSeq(3),step:0};
      g.msg='research';g.msgT=1.2;
    }else if(id==='mel'){
      g.pz={id:'mel',seq:puzzleSeq(4),step:0};
      g.msg='research';g.msgT=1.2;
    }
  }
  function puzzleInput(n){
    if(!g.pz)return;
    const z2=g.pz;
    const ok=n===z2.seq[z2.step];
    if(ok){
      z2.step++;
      beep(620+z2.step*70,.04,'triangle',.018);
      if(z2.step>=z2.seq.length){
        const id=z2.id;
        g.pz=0;
        unlockSchool(id);
        if(z2.lab){
          if(id==='nsh')g.labNshRuns++;
          else if(id==='mel')g.labMelRuns++;
        }
      }
    }else{
      z2.step=0;
      trauma(.03);
      beep(180,.06,'square',.02);
      g.msg='retry';g.msgT=.55;
    }
  }
  function beginSchool(id){
    if(id==='nsh'&&g.sch.nsh===0){
      g.sch.nsh=1;playMeme();startPuzzle('nsh');
      g.msg='help';g.msgT=1.4;beep(640,.05,'triangle',.02);
    }else if(id==='mel'&&g.sch.mel===0){
      g.sch.mel=1;playMeme();startPuzzle('mel');
      g.msg='help';g.msgT=1.4;beep(680,.05,'triangle',.02);
    }
  }
  function unlockSchool(id){
    if(id==='nsh'&&g.sch.nsh!==2){
      g.sch.nsh=2;queueUnlock('nsh');
      g.msg='nsh';g.msgT=2.1;trauma(.12);burst(p.x,p.y,'#79d7ff',16,95);beep(760,.07,'square',.024);
    }else if(id==='nsh'&&g.labNsh>0){
      g.labNsh--;
      queueUnlock('nsh');
      g.msg='nsh prototype ready';
      g.msgT=1.8;
      trauma(.12);
      burst(p.x,p.y,'#9de6ff',12,72);
      beep(740,.06,'triangle',.022);
    }else if(id==='mel'&&g.sch.mel!==2){
      g.sch.mel=2;queueUnlock('mel');
      g.msg='mel';g.msgT=2.1;trauma(.12);burst(p.x,p.y,'#ffd58f',16,95);beep(720,.07,'square',.024);
    }else if(id==='mel'&&g.labMel>0){
      g.labMel--;
      queueUnlock('mel');
      g.msg='mellon prototype ready';
      g.msgT=1.8;
      trauma(.12);
      burst(p.x,p.y,'#b6ef9d',12,72);
      beep(720,.06,'triangle',.022);
    }
    queueLabMilestoneRewards();
    g.labCd=3;
  }
  function chemLabel(){
    const n=knownVariants(g.chemMask);
    if(n>=3)return 'triple burst';
    if(n===2)return 'dual burst';
    if(g.chemMask&1)return 'acid';
    if(g.chemMask&2)return 'heal';
    if(g.chemMask&4)return 'grav';
    return 'chem';
  }
  function chemColor(){
    const n=knownVariants(g.chemMask);
    if(n>=3)return '#5ccba0';
    if(n===2)return '#7ae88a';
    if(g.chemMask&1)return '#8fdd73';
    if(g.chemMask&2)return '#7ad8cd';
    if(g.chemMask&4)return '#8fb6ff';
    return '#f4d96e';
  }
  function toggleCatalyst(){
    if(!p.cat)return;
    g.msg='brew: '+chemLabel();
    g.msgT=1.1;
    beep(520,.04,'triangle',.016);
  }
  function objectiveText(){
    if(!p.mkOn)return 'collect mints '+g.homeGot+'/'+g.homeNeed;
    if(g.bd2)return 'campus secured';
    if(g.bs2&&knownVariants(g.chemMask)>=3)return 'triple burst! overlap all 3 puddles to storm apex!';
    if(g.bs2)return 'defeat apex boss';
    if(g.bd)return 'apex signal rising';
    if(g.bs)return 'defeat boss';
    if(g.pz&&g.pz.id==='nsh')return 'solve nsh puzzle';
    if(g.pz&&g.pz.id==='mel')return 'solve mellon puzzle';
    if(g.sch.nsh===0)return 'find nsh';
    if(g.sch.nsh===1)return 'solve nsh puzzle';
    if(g.sch.mel===0)return 'find mellon institute';
    if(g.sch.mel===1)return 'solve mellon puzzle';
    if(g.labNsh>0&&g.labMel>0)return 'visit nsh / mellon for prototype upgrades';
    if(g.labNsh>0)return 'visit nsh for buddy prototype';
    if(g.labMel>0)return 'visit mellon institute for catalyst prototype';
    if(g.sch.mel===2&&g.kills<FIRST_BOSS_MIN_KILLS)return 'defeat '+FIRST_BOSS_MIN_KILLS+' enemies to summon boss';
    return 'survive phase 2';
  }
  function queueUnlock(id){
    if(g.uq.indexOf(id)<0)g.uq.push(id);
  }
  function knownVariants(mask){
    return ((mask&1)?1:0)+((mask&2)?1:0)+((mask&4)?1:0);
  }
  function ownedBotTypes(){
    const out=[];
    for(let i=1;i<=3;i++)if(g.botMask&(1<<(i-1)))out.push(i);
    return out;
  }
  const BOT_REF={rate:1.9,dmg:1.15,range:480,fetch:95,pull:195,carry:2,grab:.38,pier:4,size:6};
  const BOT_BASE={
    1:{rate:1.15,dmg:1.6,range:620,fetch:72,pull:150,carry:1,grab:.42,pier:5,size:7.2,auraR:0,auraSl:0,healI:0,healAmt:0,pulse:1,col:'#9de6ff',body:'#93d8ff',ring:'#d0efff'},
    2:{rate:1.72,dmg:.95,range:520,fetch:118,pull:198,carry:2,grab:.34,pier:0,size:3.8,auraR:0,auraSl:0,healI:18,healAmt:10,pulse:0,col:'#7ae8a3',body:'#74de95',ring:'#d9ffe5'},
    3:{rate:2.45,dmg:.95,range:390,fetch:110,pull:205,carry:2,grab:.34,pier:2,size:8.5,auraR:124,auraSl:.46,healI:0,healAmt:0,pulse:1,col:'#ffd48c',body:'#ffd48c',ring:'#fff0c7'}
  };
  function botStats(t){
    const b=BOT_BASE[t]||BOT_BASE[1];
    const carryBonus=Math.max(0,p.bCarryMax-BOT_REF.carry);
    return {
      rate:Math.max(.5,b.rate*(p.bRate/BOT_REF.rate)),
      dmg:b.dmg*(p.bDmg/BOT_REF.dmg),
      range:b.range*(p.bRange/BOT_REF.range),
      fetch:b.fetch*(p.bFetch/BOT_REF.fetch),
      pull:b.pull*(p.bPull/BOT_REF.pull),
      carry:Math.max(1,b.carry+carryBonus),
      grab:Math.max(.14,b.grab*(p.bGrabI/BOT_REF.grab)),
      pier:Math.max(0,Math.round(b.pier+(p.bPier-BOT_REF.pier))),
      size:Math.max(2.8,b.size*(p.bSize/BOT_REF.size)),
      auraR:b.auraR,
      auraSl:b.auraSl,
      healI:b.healI,
      healAmt:b.healAmt,
      pulse:b.pulse,
      col:b.col,
      body:b.body,
      ring:b.ring
    };
  }
  function remainingVariants(mask){
    const rem=[];
    for(let i=1;i<=3;i++)if(!(mask&(1<<(i-1))))rem.push(i);
    return rem;
  }
  function botName(t){
    return t===1?'Volt Buddy':t===2?'Medic Buddy':'Guard Buddy';
  }
  function chemName(t){
    return t===1?'Acidic Puddle':t===2?'Heal Puddle':'Gravity Puddle';
  }
  function botChoiceCard(t){
    if(t===1)return {n:'Volt Buddy',d:'striker bot: rapid shock pulses, low cargo',f:()=>setBotVariant(1),bg:'rgba(29,53,79,.96)',st:'rgba(147,216,255,.88)',tx:'#f1f9ff',sub:'#b3d4ee'};
    if(t===2)return {n:'Medic Buddy',d:'green rounds + heals Scotty every 18s',f:()=>setBotVariant(2),bg:'rgba(24,72,44,.96)',st:'rgba(148,232,171,.9)',tx:'#e9ffef',sub:'#b9e5c6'};
    return {n:'Guard Buddy',d:'warden bot: slowing aura + sturdy pulse',f:()=>setBotVariant(3),bg:'rgba(73,50,27,.96)',st:'rgba(255,205,138,.9)',tx:'#fff4df',sub:'#e6cda5'};
  }
  function chemChoiceCard(t){
    if(t===1)return {n:'Acidic Puddle',d:'corrosive zone: burst + damage over time',f:()=>setChemVariant(1),bg:'rgba(33,75,34,.96)',st:'rgba(160,236,146,.88)',tx:'#edffe9',sub:'#bce2b3'};
    if(t===2)return {n:'Heal Puddle',d:'restorative zone: heals Scotty while inside',f:()=>setChemVariant(2),bg:'rgba(22,79,72,.96)',st:'rgba(151,242,228,.9)',tx:'#e8fffb',sub:'#b6e7df'};
    return {n:'Gravity Puddle',d:'black hole zone: drags enemies from far outside',f:()=>setChemVariant(3),bg:'rgba(30,45,86,.96)',st:'rgba(156,190,255,.9)',tx:'#edf3ff',sub:'#bfd1f0'};
  }
  function queueLabMilestoneRewards(){
    while(g.kills>=(g.labStep+1)*LAB_REFRESH_KILLS){
      g.labStep++;
      g.labBank++;
      g.msg='new prototype intel';
      g.msgT=1.25;
      beep(620,.04,'triangle',.018);
    }
    while(g.labBank>0){
      const nshQueued=g.uq.indexOf('nsh')>=0?1:0;
      const melQueued=g.uq.indexOf('mel')>=0?1:0;
      const nshKnown=knownVariants(g.botMask);
      const melKnown=knownVariants(g.chemMask);
      const nshProgress=nshKnown+g.labNsh+nshQueued;
      const nshCost=nshProgress===2?NSH_THIRD_BOT_INTEL_COST:1;
      const needNsh=g.sch.nsh===2&&nshKnown>=1&&nshProgress<3&&g.labBank>=nshCost;
      const needMel=g.sch.mel===2&&melKnown>=1&&(melKnown+g.labMel+melQueued)<3;
      if(!needNsh&&!needMel)break;
      let id='';
      if(needNsh&&needMel){g.labFlip^=1;id=g.labFlip?'nsh':'mel';}
      else id=needNsh?'nsh':'mel';
      if(id==='nsh'){
        g.labNsh++;
        g.msg='nsh: prototype bench ready';
        g.msgT=1.6;
        beep(700,.05,'triangle',.02);
        g.labBank-=nshCost;
      }else{
        g.labMel++;
        g.msg='mellon: catalyst bench ready';
        g.msgT=1.6;
        beep(680,.05,'triangle',.02);
        g.labBank--;
      }
    }
  }
  function claimLabVisit(id){
    if(g.lvup||g.pz||g.uq.length||g.labCd>0)return;
    if(id==='nsh'&&g.labNsh>0){
      startPuzzle('nsh','lab');
      g.msg='nsh: run prototype trial';
      g.msgT=1.35;
      beep(700,.05,'triangle',.02);
    }else if(id==='mel'&&g.labMel>0){
      startPuzzle('mel','lab');
      g.msg='mellon: run prototype trial';
      g.msgT=1.35;
      beep(680,.05,'triangle',.02);
    }
  }
  function syncBots(){
    const types=ownedBotTypes();
    const want=p.bot?Math.max(1,Math.min(p.botCount|0,types.length||1)):0;
    while(bots.length<want){
      const t=types[Math.min(types.length-1,bots.length)]||1;
      bots.push({x:p.x,y:p.y,t,cd:rnd(.05,.3),grabCd:rnd(.03,.22),slx:0,sly:0,vx:0,vy:0});
    }
    while(bots.length>want)bots.pop();
    for(let i=0;i<bots.length;i++)bots[i].t=types[Math.min(types.length-1,i)]||bots[i].t||1;
    if(p.botSlots!==want){
      const rr=40;
      for(let i=0;i<bots.length;i++){
        const a=p.ba+i*(Math.PI*2/Math.max(1,bots.length));
        bots[i].x=p.x+Math.cos(a)*rr;
        bots[i].y=p.y+Math.sin(a)*rr;
        bots[i].cd=rnd(.05,.3);
        bots[i].grabCd=rnd(.03,.22);
        bots[i].slx=0;
        bots[i].sly=0;
        bots[i].vx=0;
        bots[i].vy=0;
      }
      p.botSlots=want;
    }
    if(!bots.length){
      p.bx=p.x+20;
      p.by=p.y+4;
      p.botSlots=0;
    }
  }
  function setBotVariant(t){
    const first=!p.bot;
    p.bot=1;p.bType=t;
    p.bx=p.x+20;p.by=p.y+4;p.ba=0;
    if(first){
      p.bcd=.45;p.bRate=BOT_REF.rate;p.bDmg=BOT_REF.dmg;p.bRange=BOT_REF.range;p.bFetch=BOT_REF.fetch;p.bPull=BOT_REF.pull;
      p.bCarry=0;p.bCarryMax=BOT_REF.carry;p.bGrabCd=0;p.bGrabI=BOT_REF.grab;p.bPier=BOT_REF.pier;p.bSize=BOT_REF.size;
      p.bAtk=1;p.bAuraR=0;p.bAuraSl=0;p.bHealCd=0;p.bHealI=10;p.bHealAmt=10;p.bHealFx=0;
    }
    g.botMask|=(1<<(t-1));
    p.botCount=Math.max(1,knownVariants(g.botMask));
    syncBots();
    queueLabMilestoneRewards();
  }
  function setChemVariant(t){
    p.cat=1;p.catType=t;p.catM=0;
    p.chDo=14;p.chBurst=10;p.chHeal=8;p.chHealCd=0;p.chHealI=.85;
    if(t===1){
      p.chDo=20;p.chBurst=13;
    }else if(t===2){
      p.chHeal=10;p.chHealI=.85;
    }else{
      p.mkSl=Math.max(p.mkSl,.6);
    }
    g.chemMask|=(1<<(t-1));
    queueLabMilestoneRewards();
  }
  function popUnlockBook(){
    if(g.lvup||g.dead||g.pz||!g.uq.length)return;
    const id=g.uq.shift();
    g.choices=[];
    if(id==='nsh'){
      const rem=remainingVariants(g.botMask);
      if(rem.length===1){
        const t=rem[0];
        setBotVariant(t);
        g.msg='nsh: '+botName(t)+' calibrated';
        g.msgT=1.6;
        burst(p.x,p.y,'#9de6ff',14,84);
        beep(760,.06,'triangle',.025);
        return;
      }
      if(rem.length===2){
        g.choices=[
          botChoiceCard(rem[0]),
          botChoiceCard(rem[1]),
          {n:'Wildcard Buddy',d:'installs one of the remaining buddy prototypes',f:()=>setBotVariant(rem[(Math.random()*rem.length)|0]),bg:'rgba(42,63,95,.96)',st:'rgba(167,207,255,.86)',tx:'#eef7ff',sub:'#c3d8ef'}
        ];
      }else if(rem.length===3){
        g.choices=[botChoiceCard(1),botChoiceCard(2),botChoiceCard(3)];
      }
    }else if(id==='mel'){
      const rem=remainingVariants(g.chemMask);
      if(rem.length===1){
        const t=rem[0];
        setChemVariant(t);
        g.msg='mellon: '+chemName(t)+' calibrated';
        g.msgT=1.6;
        burst(p.x,p.y,'#b6ef9d',14,84);
        beep(740,.06,'triangle',.025);
        return;
      }
      if(rem.length===2){
        g.choices=[
          chemChoiceCard(rem[0]),
          chemChoiceCard(rem[1]),
          {n:'Wildcard Catalyst',d:'mixes one of the remaining catalyst variants',f:()=>setChemVariant(rem[(Math.random()*rem.length)|0]),bg:'rgba(38,76,56,.96)',st:'rgba(159,236,184,.88)',tx:'#eaffef',sub:'#c2ebd0'}
        ];
      }else if(rem.length===3){
        g.choices=[chemChoiceCard(1),chemChoiceCard(2),chemChoiceCard(3)];
      }
    }
    if(!g.choices.length)return;
    g.lvup=1;
    g.cardT=0;
    g.msg='up';
    g.msgT=1.4;
    beep(760,.07,'triangle',.028);
  }
  function territoryBoxHit(sx,sy){
    const ab=44,abGap=8,abX=W-18-ab,tY=14+ab+abGap;
    return sx>=abX&&sx<=abX+ab&&sy>=tY&&sy<=tY+ab;
  }
  function trauma(v){g.shake=clamp(g.shake+v,0,1.3)}
  function hitStop(v){g.stop=Math.max(g.stop,v)}

  function resize(){
    DPR=Math.max(1,Math.min(2,devicePixelRatio||1));W=Math.max(320,innerWidth|0);H=Math.max(560,innerHeight|0);c.width=(W*DPR)|0;c.height=(H*DPR)|0;x.setTransform(DPR,0,0,DPR,0,0);x.imageSmoothingEnabled=false;
    const pad=joy.r+JOY_EDGE_PAD;
    if(joy.act){joy.x=clamp(joy.x,pad,W-pad);joy.y=clamp(joy.y,pad,H-pad);}
    else{joy.x=78;joy.y=H-88;}
  }
  function joyStart(cx,cy){
    const pad=joy.r+JOY_EDGE_PAD;
    joy.x=clamp(cx,pad,W-pad);
    joy.y=clamp(cy,pad,H-pad);
    joy.tx=0;joy.ty=0;joy.ax=0;joy.ay=0;
    joy.ttx=0;joy.tty=0;joy.tax=0;joy.tay=0;
    joy.act=1;
  }
  function joySet(cx,cy){
    let dx=cx-joy.x,dy=cy-joy.y;
    const ln=Math.hypot(dx,dy)||1,m=joy.r;
    if(ln<JOY_CENTER_SNAP){dx=0;dy=0;}
    else if(ln>m){dx=dx/ln*m;dy=dy/ln*m}
    joy.ttx=dx;joy.tty=dy;joy.tax=dx/m;joy.tay=dy/m;
  }
  function joyTick(dt){
    const s=1-Math.exp(-dt*JOY_SMOOTH),v=1-Math.exp(-dt*JOY_VIS_SMOOTH);
    joy.tx+=(joy.ttx-joy.tx)*s;joy.ty+=(joy.tty-joy.ty)*s;
    joy.ax+=(joy.tax-joy.ax)*s;joy.ay+=(joy.tay-joy.ay)*s;
    joy.show+=((joy.act?1:0)-joy.show)*v;
    if(!joy.act&&joy.show<.003)joy.show=0;
  }
  function joyReset(hard){
    joy.act=0;
    joy.ttx=0;joy.tty=0;joy.tax=0;joy.tay=0;
    if(hard){joy.tx=0;joy.ty=0;joy.ax=0;joy.ay=0;joy.show=0;}
  }

  function pushFx(v){if(fx.length>=MAX_FX)return;fx.push(v)}
  function pushFood(v){
    if(food.length>=MAX_FOOD)return;
    food.push(v);
  }
  function pushBullet(v){
    if(b.length>=MAX_B)return;
    b.push(v);
  }
  function burst(px,py,col,n,s){
    const q=z.length>130?.5:z.length>90?.7:1;
    const cnt=Math.max(1,(n*q)|0);
    for(let i=0;i<cnt;i++){
      const a=Math.random()*Math.PI*2,sp=(s||70)*(0.4+Math.random());
      pushFx({x:px,y:py,vx:Math.cos(a)*sp,vy:Math.sin(a)*sp,t:rnd(.2,.6),c:col});
    }
  }
  function killZombie(i,col,n,s,mode){
    const m=z[i];
    const light=!!mode;
    if(m.k===3){
      g.bd=1;g.bs=0;g.b2At=g.t+10;
      g.msg='boss down: apex incoming';g.msgT=2.6;
      g.bossDownT=2.4;
      hitStop(.09);
      trauma(.55);
      burst(m.x,m.y,'#ffe38f',44,210);
      burst(m.x,m.y,'#9de6ff',26,150);
      beep(200,.12,'sawtooth',.038);
      beep(320,.12,'triangle',.024);
      beep(500,.14,'square',.02);
    }
    else if(m.k===4){g.bd2=1;g.bs2=0;g.msg='apex down';g.msgT=1.8;trauma(.32);beep(210,.16,'sawtooth',.04);}
    g.kills++;
    queueLabMilestoneRewards();
    if(!light){
      hitStop(.03);
      trauma(.08);
      burst(m.x,m.y,col||'#ff9675',n||9,s||70);
      beep(280,.03,'square',.012);
    }else{
      burst(m.x,m.y,col||'#ff9675',Math.max(2,((n||9)*.35)|0),Math.max(20,(s||70)*.6));
    }
    const dropRoom=MAX_FOOD-food.length;
    if(dropRoom>0){
      const drops=light?(Math.random()<.25?1:0):(1+(Math.random()<.4?1:0));
      for(let k=0;k<Math.min(drops,dropRoom);k++){
        pushFood({x:m.x+rnd(-7,7),y:m.y+rnd(-7,7),v:rnd(5,8)|0,m:1,t:0});
      }
    }
    z.splice(i,1);
  }
  function placeBurstPuddle(type){
    if(pudd.length>=MAX_PUDD)pudd.shift();
    pudd.push({x:p.x+p.gx*4,y:p.y+8,r:p.mkR,t:p.mkD,d:p.mkD,m:type});
    const label=type===1?'acid':type===2?'heal':type===3?'grav':'territory';
    const col=type===1?'#8fdd73':type===2?'#7ad8cd':type===3?'#8fb6ff':'#ffd56d';
    g.msg=label;g.msgT=.5;
    burst(p.x,p.y+8,col,8,38);
    beep(type===1?540:type===2?600:type===3?480:560,.03,'triangle',.018);
    hitStop(.015);trauma(.035);
  }
  function startBurst(){
    const types=[];
    if(p.cat){for(let i=1;i<=3;i++)if(g.chemMask&(1<<(i-1)))types.push(i);}
    if(!types.length)types.push(0);
    placeBurstPuddle(types[0]);
    p.mkS=.32;
    p.mkBurstQ=types.slice(1);
    p.mkBurst=p.mkBurstQ.length;
    p.mkBurstT=p.mkBurst>0?.5:0;
    if(p.mkBurst<=0)p.mkT=p.mkI;
  }
  function reactionNear(k,px,py,r){
    for(let i=0;i<react.length;i++){
      const q=react[i],dx=px-q.x,dy=py-q.y;
      if(q.k===k&&dx*dx+dy*dy<(r+q.r)*(r+q.r)*.22)return 1;
    }
    return 0;
  }
  function reactionMsg(k){
    if(k===1)return 'vortex: pull + melt';
    if(k===2)return 'sanctuary: heal + slow';
    if(k===3)return 'toxic bloom: chip + regen';
    return 'campus storm!';
  }
  function reactionColor(k){
    if(k===1)return '#95f0b8';
    if(k===2)return '#89ffe8';
    if(k===3)return '#ccff9b';
    return '#c8f3ff';
  }
  function addReaction(k,px,py,r,dur){
    if(reactionNear(k,px,py,r))return;
    if(react.length>=MAX_REACT)react.shift();
    react.push({k,x:px,y:py,r,t:dur,d:dur,pcd:0});
    g.msg=reactionMsg(k);
    g.msgT=k===4?1.55:1.2;
    burst(px,py,reactionColor(k),k===4?24:14,k===4?126:84);
    beep(k===4?820:k===1?700:k===2?640:680,.06,'triangle',.022);
  }
  function consumePuddles(a,b,c){
    if(pudd[a])pudd[a].t=Math.min(pudd[a].t,.05);
    if(pudd[b])pudd[b].t=Math.min(pudd[b].t,.05);
    if(c!==undefined&&pudd[c])pudd[c].t=Math.min(pudd[c].t,.05);
  }
  function brewReactions(){
    const chem=[];
    for(let i=0;i<pudd.length;i++){
      const pd=pudd[i];
      if(pd.t>.08&&pd.m>=1&&pd.m<=3)chem.push(i);
    }
    if(chem.length<2)return;
    if(g.stormCd<=0&&chem.length>=3){
      for(let a=0;a<chem.length-2;a++){
        const pa=pudd[chem[a]];
        for(let b=a+1;b<chem.length-1;b++){
          const pb=pudd[chem[b]];
          for(let c=b+1;c<chem.length;c++){
            const pc=pudd[chem[c]];
            const mask=(1<<pa.m)|(1<<pb.m)|(1<<pc.m);
            if(mask!==14)continue;
            const dab=Math.hypot(pa.x-pb.x,pa.y-pb.y),dbc=Math.hypot(pb.x-pc.x,pb.y-pc.y),dca=Math.hypot(pc.x-pa.x,pc.y-pa.y);
            if(dab>(pa.r+pb.r)*.8||dbc>(pb.r+pc.r)*.8||dca>(pc.r+pa.r)*.8)continue;
            const px=(pa.x+pb.x+pc.x)/3,py=(pa.y+pb.y+pc.y)/3;
            const rr=Math.min(152,(pa.r+pb.r+pc.r)/3+36);
            addReaction(4,px,py,rr,6);
            g.stormCd=8;
            consumePuddles(chem[a],chem[b],chem[c]);
            for(let ri=react.length-1;ri>=0;ri--){
              const ar=react[ri];
              if(ar.k===5){
                const dd=Math.hypot(ar.x-px,ar.y-py);
                if(dd<rr+ar.r+80){burst(ar.x,ar.y,'#8effdc',12,72);react.splice(ri,1);}
              }
            }
            for(let zi=z.length-1;zi>=0;zi--){
              const m=z[zi],dx=m.x-px,dy=m.y-py,d2=dx*dx+dy*dy;
              if(m.k===4&&d2<(rr*1.8)*(rr*1.8)){
                m.hp-=(p.chBurst*4.5+p.chDo*3.5);m.ht=.3;m.s*=.45;
                m.apStormCd=Math.max(m.apStormCd||0,4);
                const ln2=Math.hypot(dx,dy)||1;
                m.vx+=dx/ln2*520;m.vy+=dy/ln2*520;
                burst(m.x,m.y,'#8effdc',26,160);
                g.msg='campus storm: apex vulnerable!';g.msgT=1.8;
                beep(860,.08,'triangle',.03);
                if(m.hp<=0){killZombie(zi,'#8effdc',18,130,1);continue;}
              }
              if(d2<rr*rr*1.2){
                const ln=Math.hypot(dx,dy)||1;
                m.hp-=p.chBurst*2.8+p.chDo*1.5;m.ht=.2;
                m.vx+=dx/ln*360;m.vy+=dy/ln*360;
                if(m.hp<=0)killZombie(zi,'#c8f3ff',12,96,1);
              }
            }
            return;
          }
        }
      }
    }
    const used={};
    for(let a=0;a<chem.length-1;a++){
      const ia=chem[a];if(used[ia])continue;
      const pa=pudd[ia];
      for(let b=a+1;b<chem.length;b++){
        const ib=chem[b];if(used[ib])continue;
        const pb=pudd[ib];
        if(pa.m===pb.m)continue;
        const d=Math.hypot(pa.x-pb.x,pa.y-pb.y);
        if(d>(pa.r+pb.r)*.7)continue;
        const m1=Math.min(pa.m,pb.m),m2=Math.max(pa.m,pb.m);
        const k=(m1===1&&m2===3)?1:(m1===2&&m2===3)?2:3;
        const px=(pa.x+pb.x)*.5,py=(pa.y+pb.y)*.5;
        const rr=Math.min(122,(pa.r+pb.r)*.44+18);
        const dur=k===1?5.4:k===2?6.1:5.8;
        addReaction(k,px,py,rr,dur);
        consumePuddles(ia,ib);
        used[ia]=1;used[ib]=1;
        break;
      }
    }
  }

  function reset(full){
    g.dead=0;g.lvup=0;g.t=0;g.time=0;g.spawnT=0;g.nextSpawn=.8;g.kills=0;g.msg='';g.msgT=0;g.level=1;g.xp=0;g.nextXp=24;g.stop=0;g.shake=0;g.xpPulse=0;g.cardT=0;g.choices=[];g.homeGot=0;g.sch.nsh=0;g.sch.mel=0;g.pz=0;g.uq.length=0;g.inB='';g.bs=0;g.bd=0;g.bs2=0;g.bd2=0;g.b2At=0;g.bossDownT=0;g.botMask=0;g.chemMask=0;g.labStep=0;g.labBank=0;g.labFlip=0;g.labNsh=0;g.labMel=0;g.labNshRuns=0;g.labMelRuns=0;g.stormCd=0;g.labCd=0;
    p.x=260;p.y=MAP_H*.5;p.vx=0;p.vy=0;p.hp=100;p.maxHp=100;p.speed=185;p.fireCd=0;p.fireRate=.46;p.dmg=12;p.range=400;p.shots=1;p.magnet=88;p.face=1;p.rx=0;p.ry=0;p.flash=0;p.gx=1;p.gy=0;p.zc=0;p.zr=0;p.zt=0;p.zx=1;p.zy=0;p.zcd=0;p.zDur=1;p.zSpd=2.1;p.zLoad=1.5;p.zCool=5.5;p.zDmg=24;p.zDr=.55;p.zb=0;p.zp=0;p.mkOn=0;p.mkT=0;p.mkI=8.8;p.mkS=0;p.mkD=14;p.mkR=54;p.mkSl=.54;p.mkBurst=0;p.mkBurstT=0;p.mkBurstQ=[];p.chDo=14;p.chBurst=10;p.chHeal=8;p.chHealCd=0;p.chHealI=.85;p.cat=0;p.catM=0;p.catType=0;p.bot=0;p.botCount=0;p.botSlots=0;p.bType=0;p.bAtk=1;p.bAuraR=0;p.bAuraSl=0;p.bHealCd=0;p.bHealI=10;p.bHealAmt=10;p.bHealFx=0;p.triA=0;p.triFx=0;p.slCharge=0;p.slFocus=0;p.slT=0;p.slRecallT=0;p.slRecallPulse=0;p.slCarryVx=0;p.slCarryVy=0;p.slPow=0;p.slWave=0;p.slComboFx=0;p.slHitMask=0;p.slPerfect=0;p.slDx=1;p.slDy=0;p.bx=p.x+20;p.by=p.y+4;p.ba=0;p.bcd=.45;p.bRate=1.9;p.bDmg=1.15;p.bRange=480;p.bFetch=95;p.bPull=195;p.bCarry=0;p.bCarryMax=2;p.bGrabCd=0;p.bGrabI=.38;p.bPier=4;p.bSize=6;
    z.length=0;b.length=0;food.length=0;pudd.length=0;fx.length=0;bots.length=0;react.length=0;
    keys.l=keys.r=keys.u=keys.d=keys.gr=0;touchMove=0;joyReset(1);
    g.msg='home: unlock';
    g.msgT=1.6;
    if(full){
      // middle mint patch
      for(let i=0;i<24;i++)pushFood({x:MID_X+rnd(-120,120),y:MID_Y+rnd(-120,120),v:7,m:1,t:0});
      // early trail to teach collection
      for(let i=0;i<10;i++)pushFood({x:330+i*58,y:MAP_H*.5+rnd(-60,60),v:5,m:1,t:0});
    }
  }

  function spawnZombie(){
    if(z.length>=MAX_Z)return;
    const a=Math.random()*Math.PI*2;
    const d=rnd(360,560);
    const base=1+g.time*.045;
    let hp=22+base*8+rnd(-4,8),sp=56+base*6+rnd(-6,10),r=rnd(12,18),dmg=8+base*.9,k=0;
    if(g.time>8&&Math.random()<.24){k=1;sp*=1.65;hp*=.66;r*=.82;dmg*=.82;}
    if(g.time>18&&Math.random()<.18){k=2;sp*=.74;hp*=2.15;r*=1.35;dmg*=1.28;}
    let zx=clamp(p.x+Math.cos(a)*d,20,MAP_W-20);
    let zy=clamp(p.y+Math.sin(a)*d,20,MAP_H-20);
    const sb=safeBuildingAt(zx,zy,10);
    if(sb){
      const dx=zx-sb.x,dy=zy-sb.y,ln=Math.hypot(dx,dy)||1;
      zx=sb.x+dx/ln*(sb.r+18);
      zy=sb.y+dy/ln*(sb.r+18);
    }
    z.push({x:zx,y:zy,r,hp,s:sp,dmg,vx:0,vy:0,ht:0,sl:0,ce:0,bm:0,bt:0,bi:'',k});
  }
  function spawnBoss(){
    if(g.bs||g.bd||g.bs2||g.bd2||z.length>=MAX_Z)return;
    const a=Math.random()*Math.PI*2,d=520,m={x:clamp(p.x+Math.cos(a)*d,40,MAP_W-40),y:clamp(p.y+Math.sin(a)*d,40,MAP_H-40),r:35,hp:640+g.time*11,s:46,dmg:24,vx:0,vy:0,ht:0,sl:0,ce:0,bm:0,bt:0,bi:'',k:3};
    pushOutsideSafe(m,28);z.push(m);g.bs=1;g.msg='boss!';g.msgT=1.2;beep(170,.15,'sawtooth',.03);trauma(.2);
  }
  function spawnApexAdds(src,count,phase){
    if(z.length>=MAX_Z-1)return;
    const tier=Math.max(1,phase|0);
    for(let s=0;s<count&&z.length<MAX_Z;s++){
      const aa=Math.random()*Math.PI*2,dd=rnd(30,82);
      const mx=clamp(src.x+Math.cos(aa)*dd,20,MAP_W-20);
      const my=clamp(src.y+Math.sin(aa)*dd,20,MAP_H-20);
      const kind=(tier>=3&&Math.random()<.34)?2:1;
      const hp=kind===2?(86+g.time*4.8+rnd(-8,10)):(54+g.time*3.4+rnd(-6,8));
      const sp=kind===2?(70+rnd(-8,10)):(96+rnd(-10,18));
      const dmg=kind===2?(18+g.time*.28):(13+g.time*.24);
      const add={x:mx,y:my,r:kind===2?rnd(14,19):rnd(11,16),hp,s:sp,dmg,vx:0,vy:0,ht:0,sl:0,ce:0,bm:0,bt:0,bi:'',k:kind};
      pushOutsideSafe(add,10);
      z.push(add);
    }
  }
  function addApexStorm(px,py,r,dur){
    if(react.length>=MAX_REACT)react.shift();
    react.push({k:5,x:px,y:py,r,t:dur,d:dur,pcd:0,ap:1});
    burst(px,py,'#d4b8ff',10,64);
    beep(260,.04,'sawtooth',.014);
  }
  function spawnApexBoss(){
    if(g.bs2||g.bd2||z.length>=MAX_Z)return;
    const a=Math.random()*Math.PI*2,d=560;
    const hp=2280+g.time*30;
    const m={x:clamp(p.x+Math.cos(a)*d,44,MAP_W-44),y:clamp(p.y+Math.sin(a)*d,44,MAP_H-44),r:42,hp,s:62,dmg:42,vx:0,vy:0,ht:0,sl:0,ce:0,bm:0,bt:0,bi:'',k:4,apMax:hp,apBaseS:62,apCd:rnd(1.4,2.2),apTele:0,apTeleD:0,apAimX:0,apAimY:0,apBurstLeft:0,apBurstSpd:860,apPhase:1,apStormCd:rnd(2.6,3.8),apSummonCd:rnd(3.4,4.8),apEvadeCd:0,apImpactCd:0};
    pushOutsideSafe(m,36);z.push(m);g.bs2=1;g.msg='apex boss! phase omega';g.msgT=1.7;beep(120,.2,'sawtooth',.04);trauma(.34);
  }
  function nearestZombie(){
    let best=0,bd=1e9;
    for(let i=0;i<z.length;i++){
      const dz=z[i],dx=dz.x-p.x,dy=dz.y-p.y,d=dx*dx+dy*dy;
      if(d<bd){bd=d;best=dz}
    }
    return best;
  }

  function shoot(){
    const t=nearestZombie();
    if(!t)return;
    let dx=t.x-p.x,dy=t.y-p.y,ln=Math.hypot(dx,dy)||1;
    if(ln>p.range)return;
    dx/=ln;dy/=ln;
    const n=p.shots,spread=.18;
    for(let i=0;i<n;i++){
      const off=n===1?0:(i-(n-1)/2)*spread;
      const cs=Math.cos(off),sn=Math.sin(off);
      const sx=dx*cs-dy*sn,sy=dx*sn+dy*cs;
      pushBullet({x:p.x,y:p.y,vx:sx*520,vy:sy*520,d:p.dmg,life:1.05,pier:1});
    }
    p.gx=dx;p.gy=dy;
    p.rx-=dx*6;p.ry-=dy*4;
    p.flash=.07;
    p.face=dx>=0?1:-1;
    burst(p.x+dx*16,p.y+dy*10,'#ffd56d',3,35);
    trauma(.025);
    beep(640,.04,'square',.018);
  }

  function addXp(v){
    g.xp+=v;
    while(g.xp>=g.nextXp){
      g.xp-=g.nextXp;
      g.level++;
      g.nextXp=(g.nextXp*1.36+9)|0;
      rollChoices();
      g.lvup=1;
      g.cardT=0;
      g.xpPulse=.65;
      g.msg='upgrade';
      g.msgT=2.1;
      hitStop(.06);
      trauma(.2);
      beep(860,.08,'triangle',.03);
      break;
    }
  }
  function collectMint(i,src){
    const f=food[i];
    if(!f)return;
    if(f.bc&&p.bCarry>0)p.bCarry--;
    addXp(f.v);
    food.splice(i,1);
    g.xpPulse=Math.min(.5,g.xpPulse+.11);
    let ox=p.x,oy=p.y;
    if(src==='bot'){
      const bi=(f.bc|0)-1;
      const bt=bi>=0&&bi<bots.length?bots[bi]:0;
      ox=bt?bt.x:p.bx;
      oy=bt?bt.y:p.by;
    }
    burst(ox,oy,'#69f0c9',4,40);
    if(!p.mkOn){
      g.homeGot++;
      if(g.homeGot>=g.homeNeed){
        p.mkOn=1;p.mkT=.25;
        g.msg='open';
        g.msgT=2.2;
        beep(820,.07,'triangle',.028);
        burst(p.x,p.y,'#ffd56d',16,95);
      }
    }
  }

  const UPS=[
    {n:'Rapid Fire',d:'shoot faster',f:()=>p.fireRate=Math.max(.15,p.fireRate*.8),req:()=>1},
    {n:'Big Bites',d:'more damage',f:()=>p.dmg+=8,req:()=>1},
    {n:'Speed Paws',d:'move faster',f:()=>p.speed+=30,req:()=>1},
    {n:'Extra Shot',d:'+1 projectile',f:()=>p.shots=Math.min(5,p.shots+1),req:()=>1},
    {n:'Snack Magnet',d:'pickup range up',f:()=>p.magnet+=40,req:()=>1},
    {n:'Tough Fur',d:'+max hp +heal',f:()=>{p.maxHp+=32;p.hp=Math.min(p.maxHp,p.hp+32)},req:()=>1},
    {n:'Quick Heal',d:'heal now',f:()=>p.hp=Math.min(p.maxHp,p.hp+45),req:()=>1},
    {n:'Zoomies Time',d:'zoomies lasts longer',f:()=>p.zDur=Math.min(2.6,p.zDur+.32),req:()=>1},
    {n:'Zoomies CD',d:'zoomies cooldown down',f:()=>p.zCool=Math.max(1.4,p.zCool-.85),req:()=>1},
    {n:'Zoomies Speed',d:'zoomies speed up',f:()=>p.zSpd=Math.min(4,p.zSpd+.45),req:()=>1},
    {n:'Zoomies Charge',d:'zoomies charge faster',f:()=>p.zLoad=Math.max(.55,p.zLoad-.24),req:()=>1},
    {n:'Territory CD',d:'territory cooldown down',f:()=>p.mkI=Math.max(3.2,p.mkI-.68),req:()=>p.mkOn},
    {n:'Territory Radius',d:'territory area bigger',f:()=>p.mkR=Math.min(110,p.mkR+16),req:()=>p.mkOn},
    {n:'Territory Duration',d:'territory lasts longer',f:()=>p.mkD=Math.min(40,p.mkD+5),req:()=>p.mkOn},
    {n:'Territory Slow',d:'territory slows more',f:()=>p.mkSl=Math.min(.88,p.mkSl+.12),req:()=>p.mkOn},
    {n:'Chemical Puddle',d:'chem damage up',f:()=>{p.chDo=Math.min(58,p.chDo+10);p.chBurst=Math.min(42,p.chBurst+8)},req:()=>p.cat},
    {n:'Chemical Radius',d:'chem area bigger',f:()=>p.mkR=Math.min(120,p.mkR+13),req:()=>p.cat},
    {n:'Chemical Tempo',d:'chem cooldown down',f:()=>p.mkI=Math.max(2.6,p.mkI-.58),req:()=>p.cat},
    {n:'Bot Fetch',d:'bot grabs mints farther away',f:()=>p.bFetch=Math.min(220,p.bFetch+34),req:()=>p.bot},
    {n:'Bot Cargo',d:'bot carries more mints',f:()=>p.bCarryMax=Math.min(5,p.bCarryMax+1),req:()=>p.bot},
    {n:'Shock Tempo',d:'shock pulse cooldown down',f:()=>p.bRate=Math.max(.62,p.bRate*.82),req:()=>p.bot&&p.bAtk},
    {n:'Shock Pierce',d:'pulse pierces more + wider',f:()=>{p.bPier=Math.min(8,p.bPier+1);p.bSize=Math.min(18,p.bSize+1.4)},req:()=>p.bot&&p.bAtk},
    {n:'Shock Power',d:'shock pulse damage up',f:()=>p.bDmg=Math.min(2.8,p.bDmg+.33),req:()=>p.bot&&p.bAtk},
  ];

  function rollChoices(){
    const pool=UPS.filter(u=>!u.req||u.req());
    g.choices=[];
    for(let i=0;i<3&&pool.length;i++){
      const k=(Math.random()*pool.length)|0;
      g.choices.push(pool[k]);
      pool.splice(k,1);
    }
  }

  function takeChoice(i){
    if(!g.lvup||!g.choices[i])return;
    g.choices[i].f();
    g.lvup=0;
    g.msg=g.choices[i].n+' applied';
    g.msgT=1.4;
    g.xpPulse=.25;
    g.labCd=Math.max(g.labCd,3);
    trauma(.08);
    burst(p.x,p.y,'#69f0c9',12,90);
    popUnlockBook();
  }

  function hitPlayer(d){
    if(p.zt>0)d*=p.zDr;
    p.hp-=d;
    trauma(.03);
    if(p.hp<=0){
      p.hp=0;g.dead=1;g.start=1;
      if(g.kills>g.best){g.best=g.kills|0;localStorage.ss_best=g.best}
      g.msg='swarmed';g.msgT=999;
      hitStop(.09);
      trauma(.42);
      beep(120,.22,'sawtooth',.05);
      burst(p.x,p.y,'#ff6f89',26,130);
    }
  }

  function update(dt){
    const rdt=dt;
    joyTick(rdt);
    if(g.msgT>0)g.msgT-=rdt;
    if(g.bossDownT>0)g.bossDownT=Math.max(0,g.bossDownT-rdt);
    if(g.stormCd>0)g.stormCd=Math.max(0,g.stormCd-rdt);
    if(g.labCd>0)g.labCd=Math.max(0,g.labCd-rdt);
    if(g.stop>0){g.stop=Math.max(0,g.stop-rdt);dt*=.06;}
    if(g.shake>0)g.shake=Math.max(0,g.shake-rdt*2.2);
    if(g.xpPulse>0)g.xpPulse=Math.max(0,g.xpPulse-rdt*1.7);
    if(p.flash>0)p.flash=Math.max(0,p.flash-rdt*7);
    if(p.zb>0)p.zb=Math.max(0,p.zb-rdt);
    if(p.zp>0)p.zp=Math.max(0,p.zp-rdt);
    p.rx*=Math.max(0,1-rdt*18);
    p.ry*=Math.max(0,1-rdt*18);
    if(p.zcd>0)p.zcd=Math.max(0,p.zcd-rdt);
    if(p.mkS>0)p.mkS=Math.max(0,p.mkS-rdt);
    if(p.mkT>0&&p.zt<=0)p.mkT=Math.max(0,p.mkT-rdt);
    if(p.bHealFx>0)p.bHealFx=Math.max(0,p.bHealFx-rdt);
    if(p.triFx>0)p.triFx=Math.max(0,p.triFx-rdt*(p.slT>0?1:1.7));
    if(p.slWave>0)p.slWave=Math.max(0,p.slWave-rdt*2.6);
    if(p.slComboFx>0)p.slComboFx=Math.max(0,p.slComboFx-rdt*2.1);
    for(let i=pudd.length-1;i>=0;i--){const pd=pudd[i];pd.t-=dt;if(pd.t<=0)pudd.splice(i,1);}
    for(let i=react.length-1;i>=0;i--){const rc=react[i];rc.t-=dt;if(rc.pcd>0)rc.pcd=Math.max(0,rc.pcd-dt);if(rc.t<=0)react.splice(i,1);}
    for(let i=fx.length-1;i>=0;i--){const f=fx[i];f.t-=dt;f.x+=f.vx*dt;f.y+=f.vy*dt;f.vy+=480*dt;if(f.t<=0)fx.splice(i,1)}

    if(!g.start||g.dead)return;
    if(g.lvup){g.cardT=Math.min(.9,g.cardT+rdt);return;}
    if(g.pz){g.t+=dt;return;}
    g.t+=dt;

    const nsh=school('nsh'),mel=school('mel');
    if(p.mkOn&&g.sch.nsh===0&&Math.hypot(p.x-nsh.x,p.y-nsh.y)<nsh.r)beginSchool('nsh');
    if(g.sch.nsh===2&&g.sch.mel===0&&Math.hypot(p.x-mel.x,p.y-mel.y)<mel.r)beginSchool('mel');
    if(g.sch.nsh===2&&g.labNsh>0&&Math.hypot(p.x-nsh.x,p.y-nsh.y)<nsh.r)claimLabVisit('nsh');
    if(g.sch.mel===2&&g.labMel>0&&Math.hypot(p.x-mel.x,p.y-mel.y)<mel.r)claimLabVisit('mel');
    popUnlockBook();

    // movement (keyboard + touch)
    const kx=(keys.r?1:0)-(keys.l?1:0),ky=(keys.d?1:0)-(keys.u?1:0);
    const joyMag=Math.hypot(joy.ax,joy.ay);
    let mx=kx,my=ky;
    if(touchMove&&joyMag>JOY_INPUT_DEAD){mx+=joy.ax;my+=joy.ay}
    let ln=Math.hypot(mx,my);
    if(ln>1){mx/=ln;my/=ln;}

    const hasInput=(Math.hypot(kx,ky)>.05||(touchMove&&joyMag>JOY_INPUT_DEAD))&&p.mkS<=0;
    const pSafeChargeZone=safeBuildingAt(p.x,p.y,-6);
    if(p.mkOn&&p.mkT<=0&&p.mkS<=0&&p.zt<=0&&p.zr<=0&&p.zc<=0&&p.mkBurst<=0)startBurst();
    if(p.mkBurst>0){
      p.mkBurstT=Math.max(0,p.mkBurstT-dt);
      if(p.mkBurstT<=0&&p.mkBurstQ.length>0){
        placeBurstPuddle(p.mkBurstQ.shift());
        p.mkBurst--;
        if(p.mkBurst>0)p.mkBurstT=.5;
        else p.mkT=p.mkI;
      }
    }
    brewReactions();
    if(p.zt<=0){
      if(!pSafeChargeZone&&!hasInput&&p.zcd<=0&&p.mkS<=0){
        p.zc=Math.min(p.zLoad,p.zc+dt);
        if(p.zc>.25){
          const q=p.zc/p.zLoad;
          p.rx+=(Math.random()*2-1)*.9*q*60*dt;
          p.ry+=(Math.random()*2-1)*.9*q*60*dt;
          trauma(.0007*q*60*dt);
        }
        if(p.zc>=p.zLoad&&!p.zr){
          p.zr=1;
          g.msg='zoomies ready';
          g.msgT=1.1;
          trauma(.08);
          beep(760,.05,'triangle',.024);
        }
      }else{
        if(p.zr){
          p.zt=p.zDur;
          p.zr=0;
          p.zc=0;
          const l2=ln||1;
          p.zx=mx/l2;
          p.zy=my/l2;
          p.slCharge=0;
          p.slFocus=0;
          p.slPow=0;
          p.slHitMask=0;
          p.slPerfect=0;
          hitStop(.04);
          trauma(.28);
          p.flash=.09;
          p.gx=p.zx;p.gy=p.zy;
          burst(p.x,p.y,'#9dffea',18,120);
          beep(980,.06,'square',.028);
        }else{
          p.zc=0;
        }
      }
    }

    if(p.zt>0){
      p.zt=Math.max(0,p.zt-dt);
      if(hasInput){
        p.zx=p.zx*.85+mx*.15;
        p.zy=p.zy*.85+my*.15;
        const n=Math.hypot(p.zx,p.zy)||1;
        p.zx/=n;p.zy/=n;
      }
      const zb=p.zb>0?1.35:1;
      p.vx=p.zx*p.speed*p.zSpd*zb+p.slCarryVx;
      p.vy=p.zy*p.speed*p.zSpd*zb+p.slCarryVy;
      p.face=p.vx>=0?1:-1;
      p.rx-=p.zx*8*dt*60;
      p.ry-=p.zy*6*dt*60;
      if(Math.random()<.65)pushFx({x:p.x-rnd(-6,6),y:p.y-rnd(-6,6),vx:-p.vx*.12+rnd(-35,35),vy:-p.vy*.12+rnd(-35,35),t:rnd(.1,.25),c:'#8fffe5'});
      if(p.zt<=0){
        if(p.bot&&bots.length>=3&&p.slCharge>=SLINGSHOT_CHARGE_TRIGGER){
          const perfect=p.slPerfect&&p.slFocus>=.98?1:0;
          const q=Math.min(1,p.slCharge*(perfect?1.12:1));
          p.slT=SLINGSHOT_DASH_MIN+(SLINGSHOT_DASH_MAX-SLINGSHOT_DASH_MIN)*q;
          p.slRecallT=0;
          p.slRecallPulse=0;
          p.slCarryVx=0;
          p.slCarryVy=0;
          p.slPow=.68+.48*q+.34*perfect;
          p.slDx=p.zx;
          p.slDy=p.zy;
          p.slWave=1;
          p.triFx=1;
          p.slHitMask=0;
          p.slComboFx=Math.max(p.slComboFx,perfect?.95:0);
          const baseSp=SLINGSHOT_DASH_SPEED*(.78+.58*q+.32*perfect);
          for(let bi=0;bi<3&&bi<bots.length;bi++){
            const bt=bots[bi];
            const spread=(bi-1)*.34;
            const cs=Math.cos(spread),sn=Math.sin(spread);
            const dx=p.zx*cs-p.zy*sn,dy=p.zx*sn+p.zy*cs;
            const sp=baseSp*(1-Math.abs(bi-1)*.08);
            bt.slx=dx*sp;
            bt.sly=dy*sp;
            burst(bt.x,bt.y,'#b6f6ff',6,50+q*44);
          }
          hitStop(.05+.025*q);
          trauma(.2+.14*q);
          burst(p.x,p.y,'#8eefff',14,92+q*58);
          g.msg=perfect?'perfect slingshot':'slingshot pack';
          g.msgT=.82;
          beep(perfect?1020:940,.05,'square',.026);
          beep(perfect?1350:1220,.04,'triangle',.018);
          p.slPerfect=0;
          p.slFocus=0;
        }else{
          p.slCharge=0;
          p.slFocus=0;
          p.slPerfect=0;
          p.slRecallT=0;
          p.slRecallPulse=0;
          p.slCarryVx=0;
          p.slCarryVy=0;
          p.slHitMask=0;
          g.msg='zoomies cd';
          g.msgT=.65;
          beep(420,.04,'triangle',.016);
        }
        p.zcd=p.zCool;
      }
    }else{
      p.vx=mx*p.speed+p.slCarryVx;p.vy=my*p.speed+p.slCarryVy;
      if(Math.abs(p.vx)>.5)p.face=p.vx>0?1:-1;
      if(p.mkS>0){
        p.rx+=Math.sin(g.t*45)*.5;
        if(Math.random()<.7)pushFx({x:p.x+rnd(-5,5),y:p.y+10+rnd(-3,3),vx:rnd(-14,14),vy:rnd(6,30),t:rnd(.12,.26),c:'#ffd56d'});
      }
    }

    p.x=clamp(p.x+p.vx*dt,12,MAP_W-12);
    p.y=clamp(p.y+p.vy*dt,12,MAP_H-12);
    if(p.zt>0&&p.zp<=0){
      for(let i=0;i<pudd.length;i++){
        const pd=pudd[i],dx=p.x-pd.x,dy=p.y-pd.y;
        if(dx*dx+dy*dy<pd.r*pd.r){
          p.zp=.22;p.zb=.48;
          burst(p.x,p.y,'#8fffe5',8,95);
          beep(740,.03,'triangle',.02);
          for(let j=z.length-1;j>=0;j--){
            const m=z[j],ex=m.x-pd.x,ey=m.y-pd.y;
            if(ex*ex+ey*ey<pd.r*pd.r){
              m.hp-=p.zDmg*2.2;m.ht=.13;m.vx+=p.zx*260;m.vy+=p.zy*260;
              if(m.hp<=0)killZombie(j,'#8fffe5',10,80,1);
            }
          }
          break;
        }
      }
    }
    const pSafeNow=safeBuildingAt(p.x,p.y,-6);
    if(!pSafeNow)g.time+=dt;
    const bid=pSafeNow?pSafeNow.id:'';
    g.inB=bid;
    if(p.cat){
      if(p.chHealCd>0)p.chHealCd=Math.max(0,p.chHealCd-dt);
      let healPad=0;
      for(let i=0;i<pudd.length;i++){
        const pd=pudd[i],dx=p.x-pd.x,dy=p.y-pd.y;
        if(pd.m===2&&dx*dx+dy*dy<pd.r*pd.r){healPad=1;break;}
      }
      if(healPad&&p.chHealCd<=0&&p.hp<p.maxHp){
        const heal=Math.min(p.chHeal,p.maxHp-p.hp);
        p.hp+=heal;
        p.chHealCd=p.chHealI;
        burst(p.x,p.y,'#7fe8dd',8,52);
        g.msg='heal +'+(heal|0);
        g.msgT=.65;
      }
    }
    let inBloom=0,inStorm=0;
    let well=0;
    let apexZone=0;
    for(let i=0;i<react.length;i++){
      const rc=react[i],dx=p.x-rc.x,dy=p.y-rc.y;
      if(dx*dx+dy*dy<rc.r*rc.r){
        if(rc.k===2){
          if(!well||rc.t>well.t)well=rc;
        }else if(rc.k===3)inBloom=1;
        else if(rc.k===4)inStorm=1;
        else if(rc.k===5)apexZone=rc;
      }
    }
    if(well&&well.pcd<=0&&p.hp<p.maxHp){
      const heal=Math.min(10,p.maxHp-p.hp);
      p.hp+=heal;
      well.pcd=1.6;
      burst(p.x,p.y,'#95ffe8',10,70);
      g.msg='well +'+(heal|0);
      g.msgT=.6;
    }
    if(inBloom&&p.hp<p.maxHp){
      const heal=Math.min(p.maxHp-p.hp,1.6*dt);
      if(heal>0)p.hp+=heal;
    }
    if(inStorm&&p.hp<p.maxHp){
      const heal=Math.min(p.maxHp-p.hp,8*dt);
      if(heal>0)p.hp+=heal;
    }
    if(apexZone&&!pSafeNow){
      const adx=apexZone.x-p.x,ady=apexZone.y-p.y,adl=Math.hypot(adx,ady)||1;
      const pull=55+((apexZone.d-apexZone.t)/apexZone.d)*25;
      p.x=clamp(p.x+adx/adl*pull*dt,12,MAP_W-12);
      p.y=clamp(p.y+ady/adl*pull*dt,12,MAP_H-12);
      hitPlayer(11*dt);
      if(Math.random()<.35)pushFx({x:p.x+rnd(-8,8),y:p.y+rnd(-8,8),vx:rnd(-18,18),vy:rnd(-30,10),t:rnd(.08,.18),c:'#d4b8ff'});
    }

    let triMode=0;
    if(p.bot&&p.botCount>0){
      syncBots();
      triMode=p.zt>0&&bots.length>=3;
      if(triMode){
        const aimDot=hasInput?Math.max(0,mx*p.zx+my*p.zy):0;
        const pullGain=.6+aimDot*.95;
        p.slCharge=Math.min(1,p.slCharge+dt*pullGain);
        if(p.zt<=SLINGSHOT_PERFECT_WINDOW){
          if(hasInput&&aimDot>SLINGSHOT_AIM_DOT){
            p.slFocus=Math.min(1,p.slFocus+dt*4.5);
            if(p.slFocus>=1&&!p.slPerfect){
              p.slPerfect=1;
              p.slComboFx=Math.max(p.slComboFx,.55);
              g.msg='perfect line';
              g.msgT=.45;
              beep(1180,.03,'triangle',.014);
            }
          }else if(!p.slPerfect){
            p.slFocus=Math.max(0,p.slFocus-dt*3.8);
          }
        }else if(!p.slPerfect){
          p.slFocus=Math.max(0,p.slFocus-dt*1.6);
        }
        p.triFx=Math.min(1,p.triFx+dt*(p.slPerfect?4.1:3.2));
      }else if(p.slT<=0&&p.slRecallT<=0&&(p.slCharge>0||p.slFocus>0||p.slPerfect)){
        p.slCharge=Math.max(0,p.slCharge-dt*2.6);
        p.slFocus=Math.max(0,p.slFocus-dt*2.8);
        if(p.slFocus<=.02)p.slPerfect=0;
      }
      if(p.slT>0){
        p.slT=Math.max(0,p.slT-dt);
        if(p.slT<=0){
          if(bots.length>=3&&p.slPow>.08){
            p.slRecallT=SLINGSHOT_RECALL_TIME*(.86+.28*Math.min(1,p.slPow));
            p.slRecallPulse=0;
            g.msg='recall strike';
            g.msgT=.52;
            beep(860,.03,'triangle',.014);
          }else{
            p.slHitMask=0;
          }
        }
      }else if(p.slRecallT>0){
        p.slRecallT=Math.max(0,p.slRecallT-dt);
        if(p.slRecallT<=0){
          p.slRecallPulse=1;
          p.slHitMask=0;
        }
      }
      p.ba+=dt*((triMode||p.slT>0||p.slRecallT>0)?4.9:2.3);
      p.triA+=dt*(triMode?9.2:4.2);
      let carryMode=0,carryFx=0,carryFy=0,carryN=0,carryGain=.18;
      if(bots.length>=3){
        if(p.slT>0){carryMode=2;carryGain=.46;}
        else if(p.slRecallT>0){carryMode=3;carryGain=.33;}
        else if(triMode){carryMode=1;carryGain=.18;}
      }
      for(let bi=0;bi<bots.length;bi++){
        const bt=bots[bi];
        const px0=bt.x,py0=bt.y;
        const dtt=Math.max(.001,dt);
        if(p.slT>0&&bi<3){
          bt.x=clamp(bt.x+bt.slx*dt,16,MAP_W-16);
          bt.y=clamp(bt.y+bt.sly*dt,16,MAP_H-16);
          const drag=Math.max(0,1-dt*(4.8+2.2*p.slPow));
          bt.slx*=drag;
          bt.sly*=drag;
        }else{
          let tx=0,ty=0;
          if(p.slRecallT>0&&bi<3){
            const rq=clamp(p.slRecallT/SLINGSHOT_RECALL_TIME,0,1);
            const front=16+10*rq;
            const side=(bi-1)*(18+10*rq);
            tx=p.x+p.slDx*front-p.slDy*side;
            ty=p.y+p.slDy*front+p.slDx*side;
            const k=24+18*(1-rq);
            bt.vx+=(tx-bt.x)*k*dt;
            bt.vy+=(ty-bt.y)*k*dt;
            const damp=Math.max(0,1-dt*(SLINGSHOT_RECALL_HOME_RATE+1.8*(1-rq)));
            bt.vx*=damp;
            bt.vy*=damp;
            bt.x=clamp(bt.x+bt.vx*dt,16,MAP_W-16);
            bt.y=clamp(bt.y+bt.vy*dt,16,MAP_H-16);
          }else if(triMode&&bi<3){
            const back=94+34*p.slCharge;
            const side=(bi-1)*(34+12*p.slCharge);
            const sway=Math.sin(g.t*18+bi*1.6)*(4+8*p.slCharge);
            tx=p.x-p.zx*back-p.zy*side;
            ty=p.y-p.zy*back+p.zx*side+sway;
            const k=18+20*p.slCharge;
            bt.vx+=(tx-bt.x)*k*dt;
            bt.vy+=(ty-bt.y)*k*dt;
            const damp=Math.max(0,1-dt*(7.4+1.8*p.slCharge));
            bt.vx*=damp;
            bt.vy*=damp;
            bt.x=clamp(bt.x+bt.vx*dt,16,MAP_W-16);
            bt.y=clamp(bt.y+bt.vy*dt,16,MAP_H-16);
          }else{
            const a=p.ba+bi*(Math.PI*2/bots.length);
            const rr=38+Math.sin(g.t*2+bi*.7)*2;
            tx=p.x+Math.cos(a)*rr;
            ty=p.y+Math.sin(a)*rr;
            bt.x+=(tx-bt.x)*Math.min(1,dt*8);
            bt.y+=(ty-bt.y)*Math.min(1,dt*8);
          }
          bt.slx*=Math.max(0,1-dt*7.8);
          bt.sly*=Math.max(0,1-dt*7.8);
        }
        bt.vx=(bt.x-px0)/dtt;
        bt.vy=(bt.y-py0)/dtt;
        if(!(p.slT>0&&bi<3)){
          bt.slx=bt.slx*.74+bt.vx*.26;
          bt.sly=bt.sly*.74+bt.vy*.26;
        }
        if(carryMode&&bi<3){
          let ivx=0,ivy=0;
          if(carryMode===2){
            ivx=bt.vx*.6+bt.slx*.4;
            ivy=bt.vy*.6+bt.sly*.4;
          }else if(carryMode===3){
            const hx=p.x-bt.x,hy=p.y-bt.y,hl=Math.hypot(hx,hy)||1;
            const pull=190+110*p.slPow;
            ivx=hx/hl*pull+bt.vx*.45+bt.slx*.2;
            ivy=hy/hl*pull+bt.vy*.45+bt.sly*.2;
          }else{
            ivx=bt.vx*.72+bt.slx*.25;
            ivy=bt.vy*.72+bt.sly*.25;
          }
          carryFx+=ivx;
          carryFy+=ivy;
          carryN++;
        }
        if(bt.grabCd>0)bt.grabCd=Math.max(0,bt.grabCd-dt);
      }
      if(carryN>0){
        const targetVx=carryFx/carryN*carryGain;
        const targetVy=carryFy/carryN*carryGain;
        const blend=Math.min(1,dt*(carryMode===2?9.2:carryMode===3?8.4:6.8));
        p.slCarryVx+=(targetVx-p.slCarryVx)*blend;
        p.slCarryVy+=(targetVy-p.slCarryVy)*blend;
      }else{
        const drag=Math.max(0,1-dt*8.5);
        p.slCarryVx*=drag;
        p.slCarryVy*=drag;
        if(Math.abs(p.slCarryVx)+Math.abs(p.slCarryVy)<.5){
          p.slCarryVx=0;
          p.slCarryVy=0;
        }
      }
      if(p.slT>0||p.slRecallT>0)p.triFx=Math.min(1,p.triFx+dt*4.1);
      else if(!triMode&&p.slPow>0)p.slPow=Math.max(0,p.slPow-dt*2.2);
      if(p.slT<=0&&p.slRecallT<=0&&p.slWave<=0&&p.slPow<.01){
        p.slPow=0;
        p.triFx=Math.max(0,p.triFx-dt*2.2);
      }
      p.bx=bots[0].x;
      p.by=bots[0].y;
      let medic=0,medicI=18,medicAmt=10;
      for(let bi=0;bi<bots.length;bi++){
        const bt=bots[bi];
        if((bt.t|0)===2){
          const bs=botStats(2);
          medic=1;
          medicI=Math.min(medicI,bs.healI||18);
          medicAmt=Math.max(medicAmt,bs.healAmt||10);
        }
      }
      if(medic){
        if(p.bHealCd>0)p.bHealCd=Math.max(0,p.bHealCd-dt);
        if(p.bHealCd<=0&&p.hp<p.maxHp){
          const heal=Math.min(medicAmt,p.maxHp-p.hp);
          p.hp+=heal;
          p.bHealCd=medicI;
          p.bHealFx=.7;
          g.msg='medic +'+(heal|0);
          g.msgT=.9;
          burst(p.x,p.y,'#84f0a6',10,62);
          beep(760,.05,'triangle',.018);
        }
      }
      if(!pSafeNow&&p.bAtk){
        for(let bi=0;bi<bots.length;bi++){
          const bt=bots[bi];
          const bs=botStats(bt.t|0||1);
          bt.cd-=dt;
          if(bt.cd>0)continue;
          let t=0,bd=bs.range*bs.range;
          for(let i=0;i<z.length;i++){
            const m=z[i],dx=m.x-bt.x,dy=m.y-bt.y,d2=dx*dx+dy*dy;
            if(d2<bd){bd=d2;t=m;}
          }
          if(t){
            const ln2=Math.hypot(t.x-bt.x,t.y-bt.y)||1;
            const pulse=!!bs.pulse,col=bs.col,pier=bs.pier;
            pushBullet({x:bt.x,y:bt.y,vx:(t.x-bt.x)/ln2*420,vy:(t.y-bt.y)/ln2*420,d:p.dmg*bs.dmg,life:1.35,pier,c:col,r:bs.size,pulse});
            bt.cd=bs.rate;
            burst(bt.x,bt.y,col,4,36);
          }else bt.cd=.35;
        }
      }
    }else{
      bots.length=0;
      p.bCarry=0;
      p.botSlots=0;
      triMode=0;
      p.slCharge=0;
      p.slFocus=0;
      p.slT=0;
      p.slRecallT=0;
      p.slRecallPulse=0;
      p.slCarryVx=0;
      p.slCarryVy=0;
      p.slPow=0;
      p.slHitMask=0;
      p.slPerfect=0;
      p.slComboFx=0;
    }

    // auto-shoot
    p.fireCd-=dt;
    if(!pSafeNow&&p.fireCd<=0){p.fireCd=p.fireRate;shoot()}

    // spawn
    g.spawnT-=dt;
    const firstBossReadyByProgress=g.kills>FIRST_BOSS_TRIGGER_KILLS||g.time>FIRST_BOSS_TRIGGER_TIME;
    if(g.sch.mel===2&&!g.bs&&!g.bd&&!g.bs2&&!g.bd2&&g.kills>=FIRST_BOSS_MIN_KILLS&&firstBossReadyByProgress)spawnBoss();
    if(g.bd&&!g.bs2&&!g.bd2&&g.t>=g.b2At)spawnApexBoss();
    if(g.spawnT<=0){
      g.spawnT=g.nextSpawn;
      g.nextSpawn=Math.max(.18,.78-g.time*.018);
      spawnZombie();
      if(!g.bs&&!g.bs2&&g.time>26&&Math.random()<.28)spawnZombie();
    }

    // bullets
    for(let i=b.length-1;i>=0;i--){
      const q=b[i];
      q.life-=dt;q.x+=q.vx*dt;q.y+=q.vy*dt;
      if(q.life<=0||q.x<-20||q.y<-20||q.x>MAP_W+20||q.y>MAP_H+20){b.splice(i,1);continue}
      for(let j=z.length-1;j>=0;j--){
        const m=z[j],dx=m.x-q.x,dy=m.y-q.y;
        const br=q.r||3;
        if(dx*dx+dy*dy<(m.r+br)*(m.r+br)){
          m.hp-=q.d;
          m.ht=q.pulse ? .12 : .09;
          m.vx+=q.vx*(q.pulse ? .11 : .07);
          m.vy+=q.vy*(q.pulse ? .11 : .07);
          if(q.pulse)burst(m.x,m.y,'#9de6ff',3,28);
          q.pier--;
          if(m.hp<=0)killZombie(j,q.pulse?'#9de6ff':'#ff9675',q.pulse?7:9,q.pulse?58:70,q.pulse?1:0);
          if(q.pier<0){b.splice(i,1);break}
        }
      }
    }

    // zombies + contact damage
    let contact=0;
    let zoomHits=0,zoomKills=0;
    let slBurst=0,slBurstPow=0;
    const pSafe=pSafeNow;
    for(let i=z.length-1;i>=0;i--){
      const m=z[i];
      let tx=p.x,ty=p.y;
      if(pSafe){
        if(m.bi!==pSafe.id){m.bi=pSafe.id;m.bm=0;m.bt=rnd(.9,1.7);}
        m.bt-=dt;
        if(m.bt<=0){
          if(m.bm===0){m.bm=1;m.bt=rnd(1.1,2.1);}
          else{m.bm=0;m.bt=rnd(.9,1.7);}
        }
        if(m.bm===0){
          const pdx=p.x-pSafe.x,pdy=p.y-pSafe.y,pl=Math.hypot(pdx,pdy)||1;
          tx=pSafe.x+pdx/pl*(pSafe.r+8);
          ty=pSafe.y+pdy/pl*(pSafe.r+8);
        }else{
          const bx=m.x-pSafe.x,by=m.y-pSafe.y,bl=Math.hypot(bx,by)||1;
          tx=m.x+bx/bl*220+(-by/bl)*Math.sin(g.t*2+i)*30;
          ty=m.y+by/bl*220+(bx/bl)*Math.sin(g.t*2+i)*30;
        }
      }else{
        m.bi='';m.bt=0;m.bm=0;
      }
      if(m.k===4){
        if(!m.apMax)m.apMax=m.hp;
        if(!m.apBaseS)m.apBaseS=m.s;
        if(!m.apCd)m.apCd=rnd(1.4,2.2);
        if(!m.apStormCd)m.apStormCd=rnd(2.6,3.8);
        if(!m.apSummonCd)m.apSummonCd=rnd(3.4,4.8);
        if(!m.apBurstSpd)m.apBurstSpd=860;
        if(!m.apTele)m.apTele=0;
        if(!m.apBurstLeft)m.apBurstLeft=0;
        if(!m.apEvadeCd)m.apEvadeCd=0;
        if(!m.apImpactCd)m.apImpactCd=0;
        const hpR=clamp(m.hp/(m.apMax||1),0,1);
        const phase=hpR>.66?1:(hpR>.33?2:3);
        const rage=phase-1;
        m.apPhase=phase;
        m.s=(m.apBaseS||62)*(1+.14*rage+(p.zt>0?.18:0));
        m.apCd-=dt;
        m.apStormCd-=dt;
        m.apSummonCd-=dt;
        if(m.apEvadeCd>0)m.apEvadeCd=Math.max(0,m.apEvadeCd-dt);
        if(m.apImpactCd>0)m.apImpactCd=Math.max(0,m.apImpactCd-dt);
        const qx=p.x-m.x,qy=p.y-m.y,ql=Math.hypot(qx,qy)||1;
        const pred=phase===1?.34:phase===2?.52:.72;
        const aimX=clamp(p.x+p.vx*pred+(p.zx||0)*28,20,MAP_W-20);
        const aimY=clamp(p.y+p.vy*pred+(p.zy||0)*28,20,MAP_H-20);
        if(!pSafeNow&&p.zt>0&&m.apEvadeCd<=0){
          const side=Math.random()<.5?-1:1;
          const evade=260+rage*70;
          m.vx+=(-p.zy)*side*evade;
          m.vy+=(p.zx)*side*evade;
          m.apEvadeCd=.65-rage*.08;
          if(phase>=3&&Math.random()<.45){
            addApexStorm(
              clamp(m.x+(-p.zy)*side*54,24,MAP_W-24),
              clamp(m.y+(p.zx)*side*54,24,MAP_H-24),
              58+rage*10,
              1.8+rage*.35
            );
          }
          burst(m.x,m.y,'#d7c1ff',10,70);
          beep(176,.05,'sawtooth',.02);
        }
        if(m.apTele>0){
          m.apTele=Math.max(0,m.apTele-dt);
          m.vx*=Math.max(0,1-dt*13);
          m.vy*=Math.max(0,1-dt*13);
          if(Math.random()<.6){
            pushFx({x:m.x+rnd(-8,8),y:m.y+rnd(-8,8),vx:rnd(-26,26),vy:rnd(-26,26),t:rnd(.1,.2),c:'#dab9ff'});
          }
          if(Math.random()<.55){
            pushFx({x:m.apAimX+rnd(-10,10),y:m.apAimY+rnd(-10,10),vx:rnd(-20,20),vy:rnd(-20,20),t:rnd(.08,.18),c:'#f4dcff'});
          }
          if(m.apTele<=0){
            const lx=m.apAimX-m.x,ly=m.apAimY-m.y,ll=Math.hypot(lx,ly)||1;
            const burstSp=(m.apBurstSpd||860)+rage*140+rnd(-45,60);
            m.vx+=lx/ll*burstSp;
            m.vy+=ly/ll*burstSp;
            m.ht=Math.max(m.ht,.18);
            trauma(.2+.05*rage);
            hitStop(.03);
            burst(m.x,m.y,'#c7a9ff',20,140);
            addApexStorm(clamp(m.apAimX+rnd(-22,22),24,MAP_W-24),clamp(m.apAimY+rnd(-22,22),24,MAP_H-24),68+rage*12,2.2+rage*.5);
            if(phase>=2&&Math.random()<.7)spawnApexAdds(m,phase===3?3:2,phase);
            m.apBurstLeft=(m.apBurstLeft|0)-1;
            if(m.apBurstLeft>0){
              m.apTeleD=Math.max(.18,.34-rage*.04);
              m.apTele=m.apTeleD;
              m.apAimX=clamp(p.x+p.vx*(pred*.7)+rnd(-30,30),20,MAP_W-20);
              m.apAimY=clamp(p.y+p.vy*(pred*.7)+rnd(-30,30),20,MAP_H-20);
            }else{
              m.apCd=rnd(Math.max(.44,1.25-rage*.26),Math.max(.8,1.95-rage*.3));
            }
            beep(145-rage*8,.07,'sawtooth',.032);
          }
        }else if(m.apCd<=0){
          const close=ql<180,far=ql>360;
          let bursts=phase===1?1:(phase===2?2:3);
          if(close&&phase>=2)bursts++;
          if(far&&phase===1)bursts=2;
          m.apBurstLeft=bursts;
          m.apTeleD=Math.max(.24,.52-rage*.08-(close?.08:0));
          m.apTele=m.apTeleD;
          m.apAimX=aimX;
          m.apAimY=aimY;
          m.apBurstSpd=820+rage*150+(far?90:0);
          if(Math.random()<.4+rage*.2){
            const side=Math.random()<.5?-1:1;
            m.apAimX=clamp(m.apAimX+(-qy/ql)*side*(70+rage*40),20,MAP_W-20);
            m.apAimY=clamp(m.apAimY+(qx/ql)*side*(70+rage*40),20,MAP_H-20);
          }
          g.msg=phase===3?'apex frenzy':'apex charging';
          g.msgT=.5;
          burst(m.x,m.y,'#b59bff',12+phase*4,90+phase*18);
          beep(190-rage*10,.05,'square',.02);
          if(phase>=2&&m.apSummonCd<=0){
            spawnApexAdds(m,phase,phase);
            m.apSummonCd=rnd(Math.max(1.2,3-rage*.6),Math.max(1.8,4.1-rage*.7));
          }
        }
        if(m.apStormCd<=0&&!pSafeNow){
          addApexStorm(clamp(p.x+p.vx*.32+rnd(-36,36),24,MAP_W-24),clamp(p.y+p.vy*.32+rnd(-36,36),24,MAP_H-24),62+phase*10,2.0+phase*.45);
          if(phase>=3&&Math.random()<.3){
            addApexStorm(clamp(m.x+rnd(-120,120),24,MAP_W-24),clamp(m.y+rnd(-120,120),24,MAP_H-24),56+phase*8,1.8+phase*.35);
          }
          m.apStormCd=rnd(Math.max(1.8,3.8-rage*.5),Math.max(2.6,4.8-rage*.55));
        }
        if(!pSafeNow){
          const px=m.x-p.x,py=m.y-p.y,pl=Math.hypot(px,py)||1;
          const pullR=300+phase*40;
          if(pl<pullR){
            const pull=(1-pl/pullR)*(110+phase*38);
            p.x=clamp(p.x+px/pl*pull*dt,12,MAP_W-12);
            p.y=clamp(p.y+py/pl*pull*dt,12,MAP_H-12);
            p.rx-=px/pl*(1.5+phase*.35);
            p.ry-=py/pl*(1.3+phase*.3);
          }
        }
      }
      const dx=tx-m.x,dy=ty-m.y,ln=Math.hypot(dx,dy)||1;
      let sf=1,inPad=0,padMode=0,reactDot=0;
      let inPlayerStorm=0;
      for(let r=0;r<react.length;r++){
        const rc=react[r],rx=m.x-rc.x,ry=m.y-rc.y,d2=rx*rx+ry*ry;
        if(rc.k===5){
          if(d2<rc.r*rc.r&&m.k!==4)sf=Math.min(sf,1.15);
          continue;
        }
        if(rc.k===1){
          const gr=rc.r*1.9;
          if(d2<gr*gr){
            const gd=Math.sqrt(d2)||1,q=1-gd/gr,pull=120+q*q*390;
            m.vx+=(-rx/gd)*pull*dt;
            m.vy+=(-ry/gd)*pull*dt;
            sf=Math.min(sf,.8);
            if(d2<rc.r*rc.r){
              sf=Math.min(sf,.48);
              reactDot+=p.chDo*.95+7;
            }
          }
          continue;
        }
        if(d2>=rc.r*rc.r)continue;
        if(rc.k===2){
          sf=Math.min(sf,.5);
        }else if(rc.k===3){
          sf=Math.min(sf,.72);
          reactDot+=p.chDo*.75+4;
        }else if(rc.k===4){
          const gd=Math.sqrt(d2)||1,q=1-gd/rc.r,pull=170+q*q*420;
          m.vx+=(-rx/gd)*pull*dt;
          m.vy+=(-ry/gd)*pull*dt;
          sf=Math.min(sf,.28);
          reactDot+=p.chDo*2.1+22;
          inPlayerStorm=1;
          if((m.sc||0)<=0){
            m.sc=.24;
            burst(m.x,m.y,'#c8f3ff',4,34);
          }
        }
      }
      if(m.sc>0)m.sc=Math.max(0,m.sc-dt);
      for(let k=0;k<pudd.length;k++){
        const pd=pudd[k],px=m.x-pd.x,py=m.y-pd.y;
        const d2=px*px+py*py;
        const mode=pd.m|0;
        if(mode===3){
          const gr=pd.r*2.35;
          if(d2<gr*gr){
            const gd=Math.sqrt(d2)||1,q=1-gd/gr;
            const pull=90+q*q*350;
            m.vx+=(-px/gd)*pull*dt;
            m.vy+=(-py/gd)*pull*dt;
            sf=Math.min(sf,.88);
            if(d2<pd.r*pd.r){padMode=3;sf=Math.min(sf,.42);inPad=1;}
          }
          continue;
        }
        if(d2<pd.r*pd.r){
          padMode=mode;
          const slow=mode===1?.3:mode===2?.18:p.mkSl;
          sf=Math.min(sf,1-slow);
          inPad=1;
          if(mode===1&&p.cat&&m.ce<=0){
            m.ce=.55;m.hp-=p.chBurst;
            burst(m.x,m.y,'#ffd58f',5,44);
          }
          break;
        }
      }
      if(p.bot&&bots.length){
        for(let bi=0;bi<bots.length;bi++){
          const bt=bots[bi],bx=m.x-bt.x,by=m.y-bt.y,d2=bx*bx+by*by,bs=botStats(bt.t|0||1);
          if(d2<20*20)sf=Math.min(sf,.65);
          if(bs.auraR>0&&d2<bs.auraR*bs.auraR)sf=Math.min(sf,1-bs.auraSl);
        }
      }
      if(triMode&&bots.length>=3){
        sf=Math.min(sf,.58);
        let tetherHit=0;
        for(let bi=0;bi<3;bi++){
          const bt=bots[bi],hitR=m.r+14;
          if(segDist2(m.x,m.y,p.x,p.y,bt.x,bt.y)<hitR*hitR){
            tetherHit=1;
            break;
          }
        }
        if(tetherHit&&((m.tc||0)<=0)){
          const lash=p.zDmg*(.24+.38*p.slCharge)*(m.k>=3?.82:1);
          m.hp-=lash;
          m.ht=.12;
          const shove=170+120*p.slCharge;
          m.vx+=p.zx*shove;
          m.vy+=p.zy*shove;
          m.tc=.08;
          zoomHits++;
          burst(m.x,m.y,'#95edff',3,34);
          if(m.hp<=0){
            killZombie(i,'#95edff',9,70,1);
            zoomKills++;
            continue;
          }
        }
      }
      if((p.slT>0||p.slRecallT>0)&&bots.length>=3){
        const recallOnly=p.slT<=0&&p.slRecallT>0;
        let slammed=0;
        for(let bi=0;bi<3;bi++){
          const bt=bots[bi],bx=m.x-bt.x,by=m.y-bt.y,hitR=m.r+18;
          if(bx*bx+by*by<hitR*hitR&&((m.tc||0)<=0)){
            const slamMul=(recallOnly?.88:1.25)+(recallOnly?.9:1.35)*p.slPow;
            const slam=p.zDmg*slamMul*(m.k>=3?.82:(recallOnly?1:1.05));
            m.hp-=slam;
            m.ht=.18;
            const bl=Math.hypot(bx,by)||1;
            const dirL=Math.hypot(p.x-bt.x,p.y-bt.y)||1;
            const dirx=recallOnly?(p.x-bt.x)/dirL:p.slDx;
            const diry=recallOnly?(p.y-bt.y)/dirL:p.slDy;
            const push=(recallOnly?180:260)+(recallOnly?150:220)*p.slPow;
            m.vx+=dirx*push+bx/bl*(130+100*p.slPow);
            m.vy+=diry*push+by/bl*(130+100*p.slPow);
            m.tc=recallOnly?.095:.11;
            zoomHits++;
            burst(m.x,m.y,recallOnly?'#bdf7ff':'#8eefff',recallOnly?5:7,recallOnly?52:64);
            slammed=1;
            if(!recallOnly){
              const bit=1<<bi;
              if(!(p.slHitMask&bit))p.slHitMask|=bit;
              if(!slBurst&&p.slHitMask===7){
                slBurst=1;
                slBurstPow=Math.max(slBurstPow,p.slPow);
                p.slWave=Math.max(p.slWave,.95);
                p.slComboFx=Math.max(p.slComboFx,1.2);
                g.msg='triple crack';
                g.msgT=.7;
                beep(1240,.04,'square',.024);
                beep(820,.05,'triangle',.017);
              }
            }
            if(m.hp<=0){
              killZombie(i,recallOnly?'#bdf7ff':'#8eefff',recallOnly?9:12,recallOnly?76:92,1);
              zoomKills++;
              break;
            }
          }
        }
        if(slammed&&m.hp<=0)continue;
      }
      if(m.tc>0)m.tc=Math.max(0,m.tc-dt);
      if(m.k===4){
        const phase=m.apPhase||1;
        if(inPlayerStorm){
          sf=Math.min(sf,.22);
          reactDot+=(p.chDo*3.5+38);
          if((m.sc||0)<=0){m.sc=.18;burst(m.x,m.y,'#8effdc',8,58);}
        }else{
          const floor=phase>=3?.72:phase===2?.62:.54;
          sf=Math.max(sf,floor);
        }
      }
      m.sl=inPad;
      if(inPad){
        const dot=(p.cat&&padMode===1)?p.chDo:0;
        if(dot>0)m.hp-=dot*dt;
        m.ht=Math.max(m.ht,.08);
        if(m.hp<=0){killZombie(i,'#f7d96b',8,60);continue;}
      }
      if(reactDot>0){
        m.hp-=reactDot*dt;
        m.ht=Math.max(m.ht,.11);
        if(m.hp<=0){killZombie(i,'#c8f3ff',10,76,1);continue;}
      }
      if(m.ce>0)m.ce=Math.max(0,m.ce-dt);
      m.vx*=Math.max(0,1-dt*8);
      m.vy*=Math.max(0,1-dt*8);
      m.ht=Math.max(0,m.ht-dt);
      m.x+=(dx/ln*m.s*sf+m.vx)*dt;
      m.y+=(dy/ln*m.s*sf+m.vy)*dt;
      if(pushOutsideSafe(m,6)){
        m.vx*=.4;
        m.vy*=.4;
      }
      const cdx=p.x-m.x,cdy=p.y-m.y,cln=Math.hypot(cdx,cdy)||1;
      if(cln<m.r+p.r-1){
        if(p.zt>0){
          m.hp-=p.zDmg;
          m.ht=.12;
          m.vx+=p.zx*280;
          m.vy+=p.zy*280;
          zoomHits++;
          if(m.hp<=0){
            killZombie(i,'#8fffe5',12,90,1);
            zoomKills++;
            continue;
          }
          contact+=m.dmg*.35;
          continue;
        }
        if(m.k===4&&m.apImpactCd<=0&&!pSafeNow){
          m.apImpactCd=.55;
          addApexStorm(clamp(p.x+rnd(-16,16),24,MAP_W-24),clamp(p.y+rnd(-16,16),24,MAP_H-24),68+(m.apPhase||1)*10,2.2+(m.apPhase||1)*.35);
          burst(p.x,p.y,'#e1c6ff',10,84);
          trauma(.15);
        }
        contact+=m.k===4?m.dmg*1.2:m.dmg;
      }
    }
    if(p.slRecallPulse){
      p.slRecallPulse=0;
      const rr=SLINGSHOT_RECALL_BURST_RADIUS*(.88+.24*Math.min(1,p.slPow));
      const rr2=rr*rr;
      const dmgBase=p.zDmg*(.48+.62*Math.min(1,p.slPow));
      let recallHits=0;
      for(let i=z.length-1;i>=0;i--){
        const m=z[i],dx=m.x-p.x,dy=m.y-p.y,d2=dx*dx+dy*dy;
        if(d2>rr2)continue;
        const d=Math.sqrt(d2)||1,q=1-d/rr;
        m.hp-=dmgBase*(.58+.42*q);
        m.ht=Math.max(m.ht,.13);
        const push=170+220*q*(.7+.3*Math.min(1,p.slPow));
        m.vx+=dx/d*push;
        m.vy+=dy/d*push;
        recallHits++;
        zoomHits++;
        if(Math.random()<.26)burst(m.x,m.y,'#cdf9ff',3,34);
        if(m.hp<=0){
          killZombie(i,'#cdf9ff',10,78,1);
          zoomKills++;
        }
      }
      p.slWave=Math.max(p.slWave,.78);
      p.slComboFx=Math.max(p.slComboFx,.48);
      burst(p.x,p.y,'#cdf9ff',16,104+66*Math.min(1,p.slPow));
      if(recallHits>0){
        g.msg='recall burst';
        g.msgT=.55;
        hitStop(.035+.015*Math.min(1,p.slPow));
        trauma(.08+.07*Math.min(1,p.slPow));
        beep(900,.03,'square',.018);
      }
    }
    if(slBurst){
      const rr=SLINGSHOT_TRIPLE_BURST_RADIUS*(.9+.35*slBurstPow);
      const rr2=rr*rr;
      const dmgBase=p.zDmg*(.7+1.1*slBurstPow);
      for(let i=z.length-1;i>=0;i--){
        const m=z[i],dx=m.x-p.x,dy=m.y-p.y,d2=dx*dx+dy*dy;
        if(d2>rr2)continue;
        const d=Math.sqrt(d2)||1,q=1-d/rr;
        m.hp-=dmgBase*(.55+.45*q);
        m.ht=Math.max(m.ht,.14);
        const push=220+280*slBurstPow*q;
        m.vx+=dx/d*push;
        m.vy+=dy/d*push;
        zoomHits++;
        if(Math.random()<.32)burst(m.x,m.y,'#b8f6ff',3,40);
        if(m.hp<=0){
          killZombie(i,'#b8f6ff',11,86,1);
          zoomKills++;
        }
      }
      hitStop(.06+.03*Math.min(1,slBurstPow));
      trauma(.2+.14*Math.min(1,slBurstPow));
      burst(p.x,p.y,'#b8f6ff',20,130+90*slBurstPow);
    }
    if(zoomHits>0){
      hitStop(Math.min(.04,.012*zoomHits));
      trauma(Math.min(.24,.04*zoomHits));
      g.xpPulse=Math.min(.6,g.xpPulse+.06*zoomHits);
      beep(260,.02,'square',.016);
      if(zoomKills>1)beep(310,.02,'square',.013);
    }
    if(contact>0)hitPlayer(contact*dt);

    // food pickups
    for(let i=food.length-1;i>=0;i--){
      const f=food[i];
      const dx=p.x-f.x,dy=p.y-f.y,ln=Math.hypot(dx,dy)||1;
      if(p.bot&&bots.length){
        if(f.bc){
          const bi=(f.bc|0)-1;
          const bt=bi>=0&&bi<bots.length?bots[bi]:bots[0];
          const bs=botStats(bt.t|0||1);
          const bdx=bt.x-f.x,bdy=bt.y-f.y,bln=Math.hypot(bdx,bdy)||1;
          const sp=Math.min(bs.pull*1.3,bln*13);
          f.x+=bdx/bln*sp*dt;f.y+=bdy/bln*sp*dt;
        }else{
          let carryCap=0;
          for(let bi=0;bi<bots.length;bi++)carryCap+=botStats(bots[bi].t|0||1).carry;
          if(p.bCarry<carryCap&&ln>p.magnet*1.45){
            for(let bi=0;bi<bots.length;bi++){
              const bt=bots[bi];
              if(bt.grabCd>0)continue;
              const bs=botStats(bt.t|0||1);
              const bdx=bt.x-f.x,bdy=bt.y-f.y,bln=Math.hypot(bdx,bdy)||1;
              if(bln<bs.fetch){
                f.x+=bdx/bln*bs.pull*dt;f.y+=bdy/bln*bs.pull*dt;
                if(bln<10){
                  f.bc=bi+1;
                  p.bCarry++;
                  bt.grabCd=bs.grab;
                  burst(f.x,f.y,'#9de6ff',3,24);
                }
                break;
              }
            }
          }
        }
      }
      if(ln<p.magnet){f.x+=dx/ln*240*dt;f.y+=dy/ln*240*dt}
      if(ln<p.r+8){
        collectMint(i,f.bc?'bot':'player');
      }
    }

    if((keys.gr||touchMove)&&Math.random()<.04&&g.time>2){
      pushFood({x:clamp(p.x+rnd(-20,20),12,MAP_W-12),y:clamp(p.y+rnd(-20,20),12,MAP_H-12),v:4,m:1,t:0});
    }
  }

  function cam(){return {x:clamp(p.x-W*.5,0,MAP_W-W),y:clamp(p.y-H*.5,0,MAP_H-H)}}

  function draw(){
    const sk=g.shake*g.shake;
    const sx=(Math.random()*2-1)*10*sk;
    const sy=(Math.random()*2-1)*10*sk;
    x.setTransform(DPR,0,0,DPR,sx,sy);
    const cm=cam();

    // bg
    const g1=x.createLinearGradient(0,0,0,H);g1.addColorStop(0,'#263f60');g1.addColorStop(.55,'#16273f');g1.addColorStop(1,'#0b111a');
    x.fillStyle=g1;x.fillRect(0,0,W,H);

    // grid doodle
    x.strokeStyle='rgba(63,96,132,.35)';x.lineWidth=1;
    const step=56,ox=-(cm.x%step),oy=-(cm.y%step);
    for(let yy=oy;yy<H;yy+=step){x.beginPath();x.moveTo(0,yy|0);x.lineTo(W,yy|0);x.stroke()}
    for(let xx=ox;xx<W;xx+=step){x.beginPath();x.moveTo(xx|0,0);x.lineTo(xx|0,H);x.stroke()}

    // middle mint zone tint
    const mx=MID_X-cm.x,my=MID_Y-cm.y;
    x.fillStyle='rgba(105,240,201,.07)';x.beginPath();x.arc(mx,my,210,0,Math.PI*2);x.fill();

    // school zones (phase 1)
    const inBuild=safeBuildingAt(p.x,p.y,-8);
    for(let i=0;i<SAFE_BUILDINGS.length;i++){
      const s=SAFE_BUILDINGS[i],sx=s.x-cm.x,sy=s.y-cm.y;
      if(sx<-s.r-30||sy<-s.r-30||sx>W+s.r+30||sy>H+s.r+30)continue;
      const done=s.id==='home'?0:g.sch[s.id]===2;
      const active=s.id==='home'?!p.mkOn:(
        g.sch[s.id]===1||
        (s.id==='nsh'&&(g.sch.nsh===0||(g.sch.nsh===2&&g.labNsh>0)))||
        (s.id==='mel'&&((g.sch.nsh===2&&g.sch.mel===0)||(g.sch.mel===2&&g.labMel>0)))
      );
      x.globalAlpha=done?.18:active?.14:.08;
      x.fillStyle=s.c;x.beginPath();x.arc(sx,sy,s.r,0,Math.PI*2);x.fill();
      x.globalAlpha=.65;
      x.strokeStyle=done?'#9effc8':s.c;x.lineWidth=2;x.beginPath();x.arc(sx,sy,s.r,0,Math.PI*2);x.stroke();
      x.globalAlpha=1;
      x.fillStyle='#dce8ff';x.font='600 12px Trebuchet MS,sans-serif';x.fillText(s.n,sx-s.r+10,sy-s.r-8);
      const bw=s.id==='home'?48:44,bh=30,bx=sx-bw*.5,by=sy-bh*.5;
      x.fillStyle='rgba(18,25,37,.9)';x.fillRect(bx,by,bw,bh);
      x.strokeStyle='rgba(165,190,220,.55)';x.lineWidth=1;x.strokeRect((bx+.5)|0,(by+.5)|0,bw-1,bh-1);
      x.fillStyle='rgba(248,234,164,.86)';x.fillRect((bx+6)|0,(by+6)|0,11,8);x.fillRect((bx+bw-17)|0,(by+6)|0,11,8);
      x.fillStyle='rgba(44,56,72,.95)';x.beginPath();x.arc(bx+11+Math.sin(g.t*2+i),by+11,1.7,0,Math.PI*2);x.fill();x.beginPath();x.arc(bx+bw-11+Math.sin(g.t*2+i+1),by+11,1.7,0,Math.PI*2);x.fill();
      if(g.start&&!g.dead){
        const wl=inBuild?WHI:WHO;
        const wt=wl[((g.t*.45+i*2)|0)%wl.length],wy=sy-s.r*.44,ww=wt.length*4.6+12;
        x.fillStyle='rgba(8,12,20,.82)';rr(sx-ww*.5,wy-9,ww,16,7);x.fill();
        x.fillStyle='rgba(220,240,255,.9)';x.font='600 9px Trebuchet MS,sans-serif';x.fillText(wt,sx-ww*.5+6,wy+3);
      }
    }

    // food
    for(let i=0;i<food.length;i++){
      const f=food[i],sx=f.x-cm.x,sy=f.y-cm.y;
      if(sx<-10||sy<-10||sx>W+10||sy>H+10)continue;
      x.fillStyle='#69f0c9';x.beginPath();x.arc(sx,sy,5,0,Math.PI*2);x.fill();
      x.fillStyle='#ceffef';x.fillRect((sx-1)|0,(sy-1)|0,2,2);
    }
    // territory puddles
    for(let i=0;i<pudd.length;i++){
      const pd=pudd[i],sx=pd.x-cm.x,sy=pd.y-cm.y;
      if(sx<-pd.r-20||sy<-pd.r-20||sx>W+pd.r+20||sy>H+pd.r+20)continue;
      const q=pd.t/pd.d;
      x.globalAlpha=.12+.1*q;
      let pf='#f4d96e',ps='#fff0a9';
      if(p.cat){
        if(pd.m===1){pf='#53d93d';ps='#baff87';}
        else if(pd.m===2){pf='#42cdb9';ps='#a8f6ea';}
        else if(pd.m===3){pf='#597fd6';ps='#bdd4ff';}
      }
      x.fillStyle=pf;
      x.beginPath();x.arc(sx,sy,pd.r,0,Math.PI*2);x.fill();
      x.globalAlpha=.2+.2*Math.sin((g.t+i)*5)*q;
      x.strokeStyle=ps;x.lineWidth=1.5;
      x.beginPath();x.arc(sx,sy,pd.r*.68+Math.sin((g.t+i)*4)*2,0,Math.PI*2);x.stroke();
      if(p.cat){
        if(pd.m===3){
          x.globalAlpha=.1+.08*q;
          x.strokeStyle='rgba(175,205,255,.72)';x.lineWidth=1.25;
          x.beginPath();x.arc(sx,sy,pd.r*2.35*(.97+.03*Math.sin(g.t*2+i)),0,Math.PI*2);x.stroke();
          x.globalAlpha=.08+.07*q;
          x.strokeStyle='rgba(140,174,255,.58)';x.lineWidth=1;
          x.beginPath();x.arc(sx,sy,pd.r*1.6*(.96+.04*Math.sin(g.t*2.7+i*.8)),0,Math.PI*2);x.stroke();
        }
        x.globalAlpha=.18+.24*q;
        if(pd.m===1)x.fillStyle='#dbff8f';
        else if(pd.m===2)x.fillStyle='#d8fff7';
        else if(pd.m===3)x.fillStyle='#e1ebff';
        else x.fillStyle='#f1ffb3';
        x.beginPath();x.arc(sx+Math.sin(g.t*4+i)*pd.r*.22,sy-pd.r*.16,2.4+Math.sin(g.t*7+i)*.7,0,Math.PI*2);x.fill();
        x.beginPath();x.arc(sx-pd.r*.18,sy+Math.sin(g.t*3+i*.7)*pd.r*.14,1.9+Math.sin(g.t*8+i*.4)*.5,0,Math.PI*2);x.fill();
        x.beginPath();x.arc(sx+pd.r*.12,sy+pd.r*.2,1.6+Math.sin(g.t*6+i*.5)*.4,0,Math.PI*2);x.fill();
      }
      x.globalAlpha=1;
    }
    // fused reaction puddles
    for(let i=0;i<react.length;i++){
      const rc=react[i],sx=rc.x-cm.x,sy=rc.y-cm.y;
      if(sx<-rc.r-40||sy<-rc.r-40||sx>W+rc.r+40||sy>H+rc.r+40)continue;
      const q=rc.t/rc.d,pulse=.86+.12*Math.sin(g.t*5+i),rr=rc.r*pulse;
      let fill='#95f0b8',stroke='#d6ffea',inner='#6ae9b4';
      if(rc.k===2){fill='#7cf6e7';stroke='#d8fff7';inner='#a0fff0';}
      else if(rc.k===3){fill='#c5f690';stroke='#efffd0';inner='#d9ffab';}
      else if(rc.k===4){fill='#bde9ff';stroke='#f0fbff';inner='#d4f2ff';}
      else if(rc.k===5){fill='#b89edf';stroke='#d8c4f0';inner='#c4a8e8';}
      x.globalAlpha=.14+.16*q;
      x.fillStyle=fill;
      x.beginPath();x.arc(sx,sy,rr,0,Math.PI*2);x.fill();
      x.globalAlpha=.28+.24*q;
      x.strokeStyle=stroke;x.lineWidth=2;
      x.beginPath();x.arc(sx,sy,rr*.78,0,Math.PI*2);x.stroke();
      x.globalAlpha=.2+.2*q;
      x.strokeStyle=inner;x.lineWidth=1.4;
      x.beginPath();x.arc(sx,sy,rr*(1.08+.05*Math.sin(g.t*7+i)),0,Math.PI*2);x.stroke();
      if(rc.k===4){
        for(let n=0;n<3;n++){
          const a=g.t*5.6+n*2.1,px=sx+Math.cos(a)*rr*.62,py=sy+Math.sin(a)*rr*.62;
          x.globalAlpha=.5+.3*q;
          x.fillStyle='#f2fcff';
          x.beginPath();x.arc(px,py,2.3,0,Math.PI*2);x.fill();
        }
      }
      if(rc.k===5){
        for(let n=0;n<4;n++){
          const a=g.t*(-4.2)+n*1.57,px=sx+Math.cos(a)*rr*.55,py=sy+Math.sin(a)*rr*.55;
          x.globalAlpha=.35+.25*q;
          x.fillStyle='#e0c8ff';
          x.beginPath();x.arc(px,py,2,0,Math.PI*2);x.fill();
        }
        x.globalAlpha=.08+.1*q;
        x.strokeStyle='#9b7ccc';x.lineWidth=1.8;
        x.beginPath();x.arc(sx,sy,rr*(.5+.08*Math.sin(g.t*9+i)),0,Math.PI*2);x.stroke();
      }
      x.globalAlpha=1;
    }

    // zombies
    for(let i=0;i<z.length;i++){
      const m=z[i],sx=m.x-cm.x,sy=m.y-cm.y;
      if(sx<-40||sy<-40||sx>W+40||sy>H+40)continue;
      const mc=m.k===4?'#713ce8':m.k===3?'#a789ff':m.k===2?'#665a78':m.k===1?'#5687a1':(m.sl?'#70805a':'#4b667f');
      x.fillStyle=m.ht>0?'#9db4d1':mc;x.beginPath();x.arc(sx,sy,m.r,0,Math.PI*2);x.fill();
      x.fillStyle='#f0627c';x.fillRect((sx-4)|0,(sy-2)|0,3,3);x.fillRect((sx+1)|0,(sy-2)|0,3,3);
      if(m.k===4){
        const hpR=clamp(m.hp/((m.apMax||m.hp)||1),0,1);
        const ringCol=hpR>.66?'#bfa1ff':hpR>.33?'#d8b4ff':'#ffb6f2';
        const vsp=Math.hypot(m.vx||0,m.vy||0);
        if(vsp>220){
          const txv=(m.vx||0)/(vsp||1),tyv=(m.vy||0)/(vsp||1);
          x.globalAlpha=.14+.06*Math.sin(g.t*20+i);
          x.fillStyle='rgba(165,126,242,.7)';
          x.beginPath();
          x.ellipse(sx-txv*(18+vsp*.02),sy-tyv*(18+vsp*.02),m.r*.7,m.r*.44,Math.atan2(tyv,txv),0,Math.PI*2);
          x.fill();
        }
        x.globalAlpha=.25+.12*Math.sin(g.t*8+i);
        x.strokeStyle=ringCol;
        x.lineWidth=2;
        x.beginPath();
        x.arc(sx,sy,m.r+10+Math.sin(g.t*6+i)*2,0,Math.PI*2);
        x.stroke();
        if(m.apTele>0&&m.apAimX!==undefined){
          const tq=1-clamp(m.apTele/(m.apTeleD||.001),0,1);
          const tx2=m.apAimX-cm.x,ty2=m.apAimY-cm.y;
          x.globalAlpha=.22+.5*tq;
          x.strokeStyle='#f2d6ff';
          x.lineWidth=2.2+tq*1.8;
          x.setLineDash([7,6]);
          x.lineDashOffset=-g.t*90;
          x.beginPath();
          x.moveTo(sx,sy);
          x.lineTo(tx2,ty2);
          x.stroke();
          x.setLineDash([]);
          x.beginPath();
          x.arc(tx2,ty2,26+tq*26,0,Math.PI*2);
          x.stroke();
          x.globalAlpha=.12+.3*tq;
          x.fillStyle='rgba(234,203,255,.85)';
          x.beginPath();
          x.arc(tx2,ty2,18+tq*22,0,Math.PI*2);
          x.fill();
          x.fillStyle='rgba(248,232,255,.75)';
          x.beginPath();
          x.arc(tx2,ty2,3.2,0,Math.PI*2);
          x.fill();
        }
        x.globalAlpha=1;
      }
    }

    // bullets
    for(let i=0;i<b.length;i++){
      const q=b[i],sx=q.x-cm.x,sy=q.y-cm.y;
      if(q.pulse){
        const rr=q.r||8;
        x.fillStyle='rgba(157,230,255,.2)';
        x.beginPath();x.arc(sx,sy,rr*1.4,0,Math.PI*2);x.fill();
        x.strokeStyle=q.c||'#9de6ff';x.lineWidth=2;
        x.beginPath();x.arc(sx,sy,rr,0,Math.PI*2);x.stroke();
        x.fillStyle='rgba(224,250,255,.88)';
        x.beginPath();x.arc(sx,sy,rr*.34,0,Math.PI*2);x.fill();
      }else{
        x.fillStyle=q.c||'#ffd56d';
        x.fillRect((sx-2)|0,(sy-2)|0,4,4);
      }
    }

    // player
    const psx=p.x-cm.x+p.rx,psy=p.y-cm.y+p.ry;
    const spr = Math.abs(p.vx)>=Math.abs(p.vy) ? (p.face>0?imgs.e:imgs.w) : (p.vy<0?(p.face>0?imgs.ne:imgs.nw):(p.face>0?imgs.se:imgs.sw));
    x.fillStyle='rgba(0,0,0,.35)';x.beginPath();x.ellipse(psx,psy+14,17,6,0,0,Math.PI*2);x.fill();
    if(spr&&spr.complete)x.drawImage(spr,psx-22,psy-18,44,30); else {x.fillStyle='#0b0f14';x.beginPath();x.arc(psx,psy,12,0,Math.PI*2);x.fill();x.fillStyle='#ef4f6c';x.fillRect((psx+3)|0,(psy-6)|0,7,3)}
    if(p.bHealFx>0){
      const q=Math.min(1,p.bHealFx/.7),ring=24+Math.sin(g.t*18)*2;
      x.globalAlpha=.18+.26*q;
      x.fillStyle='#79f2ad';
      x.beginPath();x.arc(psx,psy,ring+9*q,0,Math.PI*2);x.fill();
      x.globalAlpha=.55+.35*q;
      x.strokeStyle='#bfffd6';x.lineWidth=2.2;
      x.beginPath();x.arc(psx,psy,ring,0,Math.PI*2);x.stroke();
      x.globalAlpha=1;
    }
    if(p.bot&&bots.length){
      for(let bi=0;bi<bots.length;bi++){
        const bs=botStats(bots[bi].t|0||1);
        const body=bs.body,ring=bs.ring;
        const bt=bots[bi],bx=bt.x-cm.x,by=bt.y-cm.y;
        x.fillStyle='rgba(0,0,0,.25)';x.beginPath();x.ellipse(bx,by+8,11,4,0,0,Math.PI*2);x.fill();
        x.fillStyle=body;x.beginPath();x.arc(bx,by,9,0,Math.PI*2);x.fill();
        x.fillStyle='#16314a';x.fillRect((bx-3)|0,(by-2)|0,2,2);x.fillRect((bx+1)|0,(by-2)|0,2,2);
        x.strokeStyle=ring;x.lineWidth=1.2;x.beginPath();x.arc(bx,by,12+Math.sin(g.t*9+bi)*1.5,0,Math.PI*2);x.stroke();
        if(bs.auraR>0){
          x.strokeStyle='rgba(255,231,176,.42)';x.lineWidth=1.5;
          x.beginPath();x.arc(bx,by,bs.auraR*(.84+.08*Math.sin(g.t*4+bi*.7)),0,Math.PI*2);x.stroke();
        }
      }
      if((p.zt>0||p.slT>0||p.slRecallT>0)&&bots.length>=3){
        const q=Math.max(p.triFx,p.slCharge,p.slFocus,p.slPow*((p.slT>0||p.slRecallT>0)?1:0),p.slComboFx*.55);
        const dx=p.zt>0?p.zx:p.slDx,dy=p.zt>0?p.zy:p.slDy;
        const ph=g.t*4.6;
        for(let bi=0;bi<3;bi++){
          const bt=bots[bi],bx=bt.x-cm.x,by=bt.y-cm.y;
          const bend=(bi-1)*(14+10*q);
          const cx=(psx+bx)*.5+(-dy)*bend;
          const cy=(psy+by)*.5+(dx)*bend;
          x.strokeStyle='rgba(150,238,255,'+(0.28+.42*q)+')';
          x.lineWidth=1.8+q*1.6;
          x.beginPath();x.moveTo(psx,psy);x.quadraticCurveTo(cx,cy,bx,by);x.stroke();
          x.strokeStyle='rgba(223,252,255,'+(0.2+.48*q)+')';
          x.lineWidth=.9+q*.9;
          x.beginPath();x.moveTo(psx,psy);x.quadraticCurveTo(cx,cy,bx,by);x.stroke();
          const u=(ph+bi*.27)%1;
          const su=1-u;
          const sx2=su*su*psx+2*su*u*cx+u*u*bx;
          const sy2=su*su*psy+2*su*u*cy+u*u*by;
          x.fillStyle='rgba(219,250,255,'+(0.5+.45*q)+')';
          x.beginPath();x.arc(sx2,sy2,1.9+q*1.1,0,Math.PI*2);x.fill();
          if(p.slT>0){
            const svx=bt.slx||0,svy=bt.sly||0,sl=Math.hypot(svx,svy)||1;
            const tx2=bx-svx/sl*(18+10*q),ty2=by-svy/sl*(18+10*q);
            x.strokeStyle='rgba(167,244,255,'+(0.22+.44*q)+')';
            x.lineWidth=2.2+q*.9;
            x.beginPath();x.moveTo(tx2,ty2);x.lineTo(bx,by);x.stroke();
          }
        }
        if(p.zt>0&&p.slFocus>0){
          const fq=Math.min(1,p.slFocus);
          const rr=30+fq*9+Math.sin(g.t*20)*1.1;
          x.strokeStyle=p.slPerfect?'rgba(255,233,160,.95)':'rgba(196,239,255,'+(0.35+.45*fq)+')';
          x.lineWidth=1.4+fq*1.6;
          x.beginPath();x.arc(psx,psy,rr,-Math.PI*.5,-Math.PI*.5+Math.PI*2*fq);x.stroke();
          if(p.slPerfect){
            x.fillStyle='rgba(255,240,190,.96)';
            x.font='700 10px Trebuchet MS,sans-serif';
            x.fillText('PERFECT',psx-22,psy-28);
          }
        }
      }
      if(p.bCarry>0){
        const bx=bots[0].x-cm.x,by=bots[0].y-cm.y;
        x.fillStyle='rgba(6,10,16,.84)';
        x.beginPath();x.arc(bx+10,by-10,8,0,Math.PI*2);x.fill();
        x.fillStyle='#dfffff';x.font='700 10px Trebuchet MS,sans-serif';
        x.fillText(''+p.bCarry,bx+7,by-7);
      }
    }
    if(p.mkS>0&&p.zt<=0){
      const dir=p.face>0?-1:1;
      const q=clamp(p.mkS/.32,0,1);
      const sx2=psx+dir*13,sy2=psy+8;
      const ex2=sx2+dir*(11+Math.sin(g.t*36)*2.2),ey2=sy2+7+Math.sin(g.t*22)*1.1;
      x.strokeStyle='rgba(248,220,112,'+(0.38+q*.45)+')';
      x.lineWidth=2;
      x.beginPath();
      x.moveTo(sx2,sy2);
      x.quadraticCurveTo((sx2+ex2)*.5,sy2+2,ex2,ey2);
      x.stroke();
      x.fillStyle='rgba(250,214,103,.72)';
      x.beginPath();x.arc(ex2+dir*2,ey2+2,2.1,0,Math.PI*2);x.fill();
      x.fillStyle='rgba(244,205,93,.38)';
      x.beginPath();x.ellipse(ex2+dir*5,ey2+7,5.2,2.7,0,0,Math.PI*2);x.fill();
    }
    if((p.zc>0||p.zcd>0)&&p.zt<=0){
      const q=p.zcd>0?0:Math.min(1,p.zc/p.zLoad),cd=q<=0?Math.max(0,1-p.zcd/p.zCool):0;
      const rr=18+q*8+Math.sin(g.t*22)*1.2;
      x.strokeStyle=p.zr?'#8fffe5':'#ffd56d';
      x.lineWidth=2+q*1.8;
      x.beginPath();x.arc(psx,psy,rr,-Math.PI*.5,-Math.PI*.5+Math.PI*2*q);x.stroke();
      if(p.zcd>0){
        x.strokeStyle='rgba(158,200,255,.7)';
        x.lineWidth=2;
        x.beginPath();x.arc(psx,psy,16,-Math.PI*.5,-Math.PI*.5+Math.PI*2*cd);x.stroke();
      }
    }
    if(p.zt>0||p.slT>0||p.slRecallT>0){
      const q=p.zt>0?p.zt/2:p.slPow*.55;
      const dx=p.zt>0?p.zx:p.slDx,dy=p.zt>0?p.zy:p.slDy;
      x.strokeStyle='rgba(143,255,229,.7)';
      x.lineWidth=2.5;
      x.beginPath();x.arc(psx,psy,20+Math.sin(g.t*30)*2+q*4,0,Math.PI*2);x.stroke();
      x.fillStyle='rgba(143,255,229,.16)';
      x.beginPath();x.ellipse(psx-dx*10,psy-dy*7,20,10,Math.atan2(dy,dx),0,Math.PI*2);x.fill();
    }
    if(p.slWave>0){
      const q=p.slWave,rr=30+(1-q)*88;
      x.globalAlpha=.06+.16*q;
      x.fillStyle='rgba(142,238,255,.95)';
      x.beginPath();x.arc(psx,psy,rr*1.08,0,Math.PI*2);x.fill();
      x.globalAlpha=.74*q;
      x.strokeStyle='rgba(214,250,255,.96)';
      x.lineWidth=2+q*2.4;
      x.beginPath();x.arc(psx,psy,rr,0,Math.PI*2);x.stroke();
      x.globalAlpha=1;
    }
    if(p.slComboFx>0){
      const q=Math.min(1,p.slComboFx),rr=42+(1-q)*58;
      x.globalAlpha=.07+.2*q;
      x.fillStyle='rgba(185,244,255,.95)';
      x.beginPath();x.arc(psx,psy,rr*1.1,0,Math.PI*2);x.fill();
      x.globalAlpha=.2+.45*q;
      x.strokeStyle='rgba(229,251,255,.96)';
      x.lineWidth=1.8+q*1.5;
      x.beginPath();x.arc(psx,psy,rr,0,Math.PI*2);x.stroke();
      x.globalAlpha=1;
    }
    if(p.flash>0){
      x.globalAlpha=p.flash/.07;
      x.fillStyle='#ffe598';
      x.beginPath();
      x.moveTo(psx+p.gx*16,psy+p.gy*8);
      x.lineTo(psx+p.gx*24-p.gy*5,psy+p.gy*24+p.gx*4);
      x.lineTo(psx+p.gx*24+p.gy*5,psy+p.gy*24-p.gx*4);
      x.closePath();
      x.fill();
      x.globalAlpha=1;
    }

    // particles
    for(let i=0;i<fx.length;i++){
      const f=fx[i],sx=f.x-cm.x,sy=f.y-cm.y;
      if(sx<-8||sy<-8||sx>W+8||sy>H+8)continue;
      x.globalAlpha=Math.max(0,Math.min(1,f.t*2.4));
      x.fillStyle=f.c;
      x.fillRect((sx)|0,(sy)|0,3,3);
    }
    x.globalAlpha=1;

    // HUD
    const ab=44,abGap=8,abX=W-18-ab,zY=14,tY=14+ab+abGap,rY=tY+ab+abGap;
    const hudCompact=W<420;
    const hudH=104;
    let hpY=62,xpY=74;
    const barsW=Math.max(96,W-190);
    const hudBottom=10+hudH;
    x.fillStyle='rgba(7,10,16,.76)';x.fillRect(10,10,W-20,hudH);
      x.fillStyle='#eef4ff';x.font='700 17px Trebuchet MS,sans-serif';x.fillText('SCOTTY',20,32);
    if(hudCompact){
      const statsY=52;
      const statRight=abX-8;
      x.font='600 12px Trebuchet MS,sans-serif';
      x.fillStyle='#9ec8ff';x.fillText('Time '+g.time.toFixed(1)+'s',20,statsY);
      x.fillStyle='#ffd56d';x.fillText('Kills '+g.kills,118,statsY);
      x.textAlign='right';
      x.fillStyle='#dce8ff';x.fillText('Best '+g.best,statRight,statsY);
      x.textAlign='left';
      hpY=62;xpY=74;
    }else{
      x.font='600 14px Trebuchet MS,sans-serif';
      x.fillStyle='#9ec8ff';x.fillText('Time '+g.time.toFixed(1)+'s',20,54);
      x.fillStyle='#ffd56d';x.fillText('Kills '+g.kills,150,54);
      x.textAlign='right';
      x.fillStyle='#dce8ff';x.fillText('Best '+g.best,W-24,54);
      x.textAlign='left';
    }

    // hp
    x.fillStyle='#2a3346';x.fillRect(20,hpY,barsW,10);
    x.fillStyle='#ef4f6c';x.fillRect(20,hpY,barsW*(p.hp/p.maxHp),10);
    // xp
    x.fillStyle='#24374d';x.fillRect(20,xpY,barsW,8);
    x.fillStyle='#69f0c9';x.fillRect(20,xpY,barsW*(g.xp/g.nextXp),8);
    let apex=0;
    for(let i=0;i<z.length;i++)if(z[i].k===4){apex=z[i];break;}
    let objectiveY=hudBottom+4;
    if(apex){
      const hpR=clamp(apex.hp/((apex.apMax||apex.hp)||1),0,1);
      const phase=(apex.apPhase||1);
      const phaseName=phase===1?'ALPHA':phase===2?'RAGE':'OMEGA';
      const bw=clamp(W*.58,220,620),bh=12,bx=(W-bw)*.5,by=objectiveY+2;
      x.fillStyle='rgba(10,14,22,.88)';
      rr(bx-10,by-18,bw+20,38,11);
      x.fill();
      const bg=x.createLinearGradient(0,by,0,by+bh);
      bg.addColorStop(0,'rgba(54,71,103,.95)');
      bg.addColorStop(1,'rgba(30,40,63,.95)');
      x.fillStyle=bg;
      x.fillRect(bx,by,bw,bh);
      const fg=x.createLinearGradient(bx,0,bx+bw,0);
      if(phase===1){fg.addColorStop(0,'#9a7dff');fg.addColorStop(1,'#c8b6ff');}
      else if(phase===2){fg.addColorStop(0,'#d28cff');fg.addColorStop(1,'#ffbfd8');}
      else{fg.addColorStop(0,'#ff8bd9');fg.addColorStop(1,'#ffc3f1');}
      x.fillStyle=fg;
      x.fillRect(bx,by,bw*hpR,bh);
      x.strokeStyle='rgba(220,234,255,.65)';
      x.lineWidth=1.2;
      x.strokeRect(bx+.5,by+.5,bw-1,bh-1);
      x.fillStyle='#f4ecff';
      x.font='700 11px Trebuchet MS,sans-serif';
      x.textAlign='center';
      x.fillText('APEX DEAN // '+phaseName,bx+bw*.5,by-7);
      x.textAlign='left';
      objectiveY+=34;
    }
    const ot=objectiveText();
    x.fillStyle='rgba(8,12,19,.62)';
    x.fillRect(14,objectiveY,W-28,26);
    x.fillStyle='#d7ffe8';
    x.font='600 12px Trebuchet MS,sans-serif';
    x.fillText(ot,22,objectiveY+17);
    if(p.bot&&bots.length>=3){
      const slY=objectiveY+30;
      const bw2=W-44;
      const triReady=p.zt>0&&p.slT<=0&&p.slRecallT<=0;
      const prog=triReady?clamp(p.slCharge,0,1):(p.slT>0?clamp(p.slT/SLINGSHOT_DASH_MAX,0,1):(p.slRecallT>0?clamp(p.slRecallT/SLINGSHOT_RECALL_TIME,0,1):0));
      const label=triReady?'triple buddy: momentum rig':(p.slT>0?'triple buddy: carry dash':(p.slRecallT>0?'triple buddy: carry recall':'triple buddy: zoomies to arm'));
      x.fillStyle='rgba(8,12,19,.64)';
      x.fillRect(14,slY,W-28,22);
      x.fillStyle='rgba(48,72,98,.9)';
      x.fillRect(22,slY+8,bw2,8);
      x.fillStyle=p.slRecallT>0?'#c9f7ff':p.slT>0?'#8eefff':'#9fdfff';
      x.fillRect(22,slY+8,bw2*prog,8);
      x.fillStyle='#d5f2ff';
      x.font='600 11px Trebuchet MS,sans-serif';
      x.fillText(label,22,slY+16);
      objectiveY+=26;
    }

    if(g.start&&!g.dead){
      const drawAb=(by,col,prog,active,sec,kind)=>{
        x.fillStyle='rgba(8,12,19,.92)';x.fillRect(abX,by,ab,ab);
        x.strokeStyle=active?col:'rgba(129,157,187,.7)';x.lineWidth=2;x.strokeRect(abX+.5,by+.5,ab-1,ab-1);
        x.strokeStyle='rgba(72,88,109,.85)';x.lineWidth=3;
        x.beginPath();x.arc(abX+ab*.5,by+ab*.5,ab*.34,0,Math.PI*2);x.stroke();
        x.strokeStyle=col;
        x.beginPath();x.arc(abX+ab*.5,by+ab*.5,ab*.34,-Math.PI*.5,-Math.PI*.5+Math.PI*2*clamp(prog,0,1));x.stroke();
        x.fillStyle=col;
        if(kind<1){
          x.beginPath();
          x.moveTo(abX+ab*.49,by+ab*.19);
          x.lineTo(abX+ab*.35,by+ab*.53);
          x.lineTo(abX+ab*.49,by+ab*.53);
          x.lineTo(abX+ab*.39,by+ab*.82);
          x.lineTo(abX+ab*.67,by+ab*.41);
          x.lineTo(abX+ab*.51,by+ab*.41);
          x.closePath();x.fill();
        }else if(kind<2){
          x.beginPath();x.arc(abX+ab*.5,by+ab*.44,ab*.1,0,Math.PI*2);x.fill();
          x.beginPath();
          x.moveTo(abX+ab*.5,by+ab*.2);
          x.bezierCurveTo(abX+ab*.69,by+ab*.45,abX+ab*.64,by+ab*.67,abX+ab*.5,by+ab*.78);
          x.bezierCurveTo(abX+ab*.36,by+ab*.67,abX+ab*.31,by+ab*.45,abX+ab*.5,by+ab*.2);
          x.fill();
        }else{
          x.lineWidth=2;
          x.beginPath();x.arc(abX+ab*.5,by+ab*.5,ab*.12,0,Math.PI*2);x.stroke();
          x.beginPath();x.arc(abX+ab*.5,by+ab*.5,ab*.22,0,Math.PI*2);x.stroke();
        }
        if(sec>0){
          x.fillStyle='#dce8ff';x.font='700 10px Trebuchet MS,sans-serif';
          x.fillText(sec.toFixed(1)+'s',abX+8,by+ab-6);
        }else if(active){
          x.fillStyle='rgba(255,255,255,.8)';x.beginPath();x.arc(abX+ab-8,by+8,3,0,Math.PI*2);x.fill();
        }
      };
      const zp=p.zcd>0?1-p.zcd/p.zCool:(p.zr?1:p.zc/p.zLoad);
      drawAb(zY,'#8fffe5',zp,p.zt>0,p.zcd>0?p.zcd:0,0);
      const tp=p.mkOn?(p.mkT>0?1-p.mkT/p.mkI:1):0;
      drawAb(tY,p.cat?chemColor():'#f4d96e',tp,p.mkS>0,p.mkOn&&p.mkT>0?p.mkT:0,1);
      const rp=p.rf?(p.rfT>0?1-p.rfT/p.rfI:1):0;
      if(p.rf)drawAb(rY,'#a8b8ff',rp,1,p.rfT>0?p.rfT:0,2);
      if(p.cat){
        x.fillStyle='rgba(7,10,16,.75)';
        x.fillRect(abX-56,tY+12,50,20);
        x.fillStyle='#dce8ff';x.font='600 10px Trebuchet MS,sans-serif';
        x.fillText(chemLabel(),abX-50,tY+25);
      }
    }

    if(g.msgT>0){
      x.fillStyle='rgba(8,12,19,.74)';x.fillRect(14,objectiveY+30,W-28,28);
      x.fillStyle='#d7ffe8';x.font='600 13px Trebuchet MS,sans-serif';x.fillText(g.msg,22,objectiveY+49);
    }
    if(g.bossDownT>0){
      const q=clamp(g.bossDownT/2.4,0,1);
      const pop=.96+.08*Math.sin(g.t*18)*q;
      const cx=W*.5,cy=H*.52;
      x.fillStyle='rgba(7,10,16,'+(0.2+0.26*q)+')';
      x.fillRect(0,0,W,H);
      x.save();
      x.translate(cx,cy);x.scale(pop,pop);x.translate(-cx,-cy);
      x.textAlign='center';
      x.fillStyle='rgba(255,227,143,'+(0.44+0.4*q)+')';
      x.font=(W<520?'700 30px':'700 40px')+' Trebuchet MS,sans-serif';
      x.fillText('BOSS DOWN',cx,cy-8);
      x.fillStyle='rgba(209,231,255,'+(0.58+0.32*q)+')';
      x.font=(W<520?'600 13px':'600 15px')+' Trebuchet MS,sans-serif';
      x.fillText('Apex signal detected',cx,cy+20);
      x.restore();
      x.textAlign='left';
    }
    if(g.start&&!g.dead&&!g.lvup&&!g.pz&&joy.show>.01){
      const kx=joy.x+joy.tx,ky=joy.y+joy.ty;
      x.fillStyle='rgba(7,11,17,'+(.42*joy.show)+')';
      x.beginPath();x.arc(joy.x,joy.y,joy.r+8,0,Math.PI*2);x.fill();
      x.strokeStyle='rgba(158,200,255,'+(.45*joy.show)+')';x.lineWidth=2;
      x.beginPath();x.arc(joy.x,joy.y,joy.r,0,Math.PI*2);x.stroke();
      x.fillStyle='rgba(105,240,201,'+((touchMove?.65:.42)*joy.show)+')';
      x.beginPath();x.arc(kx,ky,joy.kr,0,Math.PI*2);x.fill();
      x.strokeStyle='rgba(220,248,255,'+(.65*joy.show)+')';x.lineWidth=1.5;
      x.beginPath();x.arc(kx,ky,joy.kr,0,Math.PI*2);x.stroke();
    }

    if(!g.start){
      const ix=20,iy=H*.16,iw=W-40,ih=H*.68,tx=ix+16;
      x.fillStyle='rgba(6,9,14,.86)';x.fillRect(ix,iy,iw,ih);
      x.fillStyle='#fff';x.font='700 30px Trebuchet MS,sans-serif';x.fillText('Project: Zoomies',tx,iy+42);
      x.fillStyle='#9ec8ff';x.font='600 15px Trebuchet MS,sans-serif';x.fillText('what the dog doing?',tx,iy+64);
      x.fillStyle='#d8e6ff';x.font='600 14px Trebuchet MS,sans-serif';
      drawWrap('Goop swallowed CMU paths. People are trapped inside buildings. Scotty is the only one fast enough to move across campus.',tx,iy+98,iw-32,18,5);
      x.fillStyle='#9ec8ff';x.font='600 13px Trebuchet MS,sans-serif';
      drawWrap('Collaborate with each college, unlock abilities, and defeat the infestation. Overlap different puddles to make combo zones.',tx,iy+200,iw-32,17,3);
      x.fillStyle='#dce8ff';x.font='600 12px Trebuchet MS,sans-serif';
      drawWrap('Controls: drag to move. Remove finger to charge Zoomies, then move to dash. With 3 buddies, slingshot + recall also momentum-carry Scotty like a physical rig. Different puddles can mix into stronger effects.',tx,iy+250,iw-32,16,4);
      x.fillStyle='#69f0c9';x.font='700 23px Trebuchet MS,sans-serif';x.fillText('tap start',tx,iy+ih-22);
    }

    if(g.lvup&&!g.dead){
      x.fillStyle='rgba(6,10,15,.16)';x.fillRect(0,0,W,H);
      const ly=getChoiceLayout(),bx=ly.bx,by=ly.by,bw=ly.bw,bh=ly.bh,rects=ly.rects,mobile=ly.mobile;
      x.fillStyle='rgba(17,29,45,.95)';rr(bx,by,bw,bh,16);x.fill();
      x.strokeStyle='rgba(90,125,163,.8)';x.lineWidth=1.2;rr(bx+.5,by+.5,bw-1,bh-1,16);x.stroke();
      x.fillStyle='#ecf3ff';x.font=(mobile?'700 18px':'700 20px')+' Trebuchet MS,sans-serif';x.fillText('SKILL BOOK',bx+14,by+24);
      x.fillStyle='#9ec8ff';x.font='600 12px Trebuchet MS,sans-serif';x.fillText('choose',bx+14,by+39);

      for(let i=0;i<3;i++){
        const u=g.choices[i],r=rects[i];
        const a=clamp((g.cardT-i*.07)/.28,0,1),sc=.9+.1*eob(a);
        const ox=r.x+r.w*.5,oy=r.y+r.h*.5;
        x.save();
        x.translate(ox,oy);x.scale(sc,sc);x.translate(-ox,-oy);
        const cardBg=u&&u.bg?u.bg:'rgba(27,44,66,.96)';
        const cardSt=u&&u.st?u.st:'rgba(116,150,186,.85)';
        const cardTx=u&&u.tx?u.tx:'#eef5ff';
        const cardSub=u&&u.sub?u.sub:'#a9c3e2';
        x.fillStyle=cardBg;rr(r.x,r.y,r.w,r.h,10);x.fill();
        x.strokeStyle=cardSt;x.lineWidth=1.2;rr(r.x+.5,r.y+.5,r.w-1,r.h-1,10);x.stroke();
        if(u){
          const icon=upIcon(u.n);
          const head=icon+' '+u.n;
          let fs=mobile?16:17;
          for(;fs>12;fs--){
            x.font='700 '+fs+'px Trebuchet MS,sans-serif';
            if(x.measureText(head).width<=r.w-22)break;
          }
          x.fillStyle=cardTx;x.fillText(head,r.x+12,r.y+30);
          x.fillStyle=cardSub;x.font='600 12px Trebuchet MS,sans-serif';
          drawWrap(u.d,r.x+12,r.y+48,r.w-24,14,2);
        }
        x.restore();
      }
      x.fillStyle='#95bce8';x.font='600 12px Trebuchet MS,sans-serif';
      x.fillText('tap 1/2/3',bx+14,by+bh-12);
    }
    if(g.pz&&!g.dead&&!g.lvup&&g.start){
      const l=puzzleLayout(),pz=g.pz;
      x.fillStyle='rgba(5,9,14,.5)';x.fillRect(0,0,W,H);
      x.fillStyle='rgba(16,24,37,.96)';rr(l.bx,l.by,l.bw,l.bh,14);x.fill();
      x.strokeStyle='rgba(106,145,185,.85)';x.lineWidth=1.2;rr(l.bx+.5,l.by+.5,l.bw-1,l.bh-1,14);x.stroke();
      x.fillStyle='#ecf3ff';x.font='700 19px Trebuchet MS,sans-serif';
      x.fillText(pz.id==='nsh'?'NSH lab':'Mellon lab',l.bx+14,l.by+27);
      if(pz.id==='nsh'){
        x.fillStyle='#dce8ff';x.font='600 12px Trebuchet MS,sans-serif';x.fillText('order',l.bx+14,l.by+66);
        for(let i=0;i<pz.seq.length;i++){
          const cx=l.bx+24+i*34,cy=l.by+86,done=i<pz.step;
          x.fillStyle=done?'#8cffc2':'#79d7ff';x.beginPath();x.arc(cx,cy,12,0,Math.PI*2);x.fill();
          x.fillStyle='#12243a';x.font='700 11px Trebuchet MS,sans-serif';x.fillText((pz.seq[i]+1)+'',cx-3,cy+4);
        }
      }else{
        const cols=['#8fd3ff','#ffd58f','#ff9fb7'];
        x.fillStyle='#dce8ff';x.font='600 12px Trebuchet MS,sans-serif';x.fillText('mix',l.bx+14,l.by+66);
        for(let i=0;i<pz.seq.length;i++){
          const cx=l.bx+24+i*30,cy=l.by+86,done=i<pz.step;
          x.fillStyle=cols[pz.seq[i]];x.beginPath();x.arc(cx,cy,10,0,Math.PI*2);x.fill();
          if(done){x.strokeStyle='#8cffc2';x.lineWidth=2;x.beginPath();x.arc(cx,cy,12,0,Math.PI*2);x.stroke();}
        }
      }
      for(let i=0;i<3;i++){
        const bt=l.btn[i];
        x.fillStyle=pz.id==='nsh'?'rgba(37,87,129,.96)':['#3c6588','#9a6f3f','#8e4f64'][i];
        rr(bt.x,bt.y,bt.w,bt.h,10);x.fill();
        x.strokeStyle='rgba(196,223,255,.72)';x.lineWidth=1.1;rr(bt.x+.5,bt.y+.5,bt.w-1,bt.h-1,10);x.stroke();
        x.fillStyle='#eef5ff';x.font='700 13px Trebuchet MS,sans-serif';
        x.fillText(pz.id==='nsh'?'terminal '+(i+1):['blue','amber','rose'][i],bt.x+9,bt.y+28);
      }
      x.fillStyle='#9ec8ff';x.font='600 11px Trebuchet MS,sans-serif';
      x.fillText('tap 1/2/3',l.bx+14,l.by+l.bh-10);
    }

    if(g.dead){
      x.fillStyle='rgba(5,8,13,.86)';x.fillRect(24,H*.24,W-48,H*.5);
      x.fillStyle='#ff8298';x.font='700 33px Trebuchet MS,sans-serif';x.fillText('GAME OVER',W*.5-98,H*.38);
      x.fillStyle='#dce8ff';x.font='600 20px Trebuchet MS,sans-serif';x.fillText('Kills '+g.kills,W*.5-43,H*.47);
      x.fillText('Best '+g.best,W*.5-37,H*.53);
      x.fillStyle='#69f0c9';x.font='700 24px Trebuchet MS,sans-serif';x.fillText('tap retry',W*.5-56,H*.65);
    }
  }

  function frame(ts){if(!last)last=ts;let dt=(ts-last)*.001;last=ts;dt=Math.max(0,Math.min(.034,dt));update(dt);draw();requestAnimationFrame(frame)}

  function maybeStart(){if(!audio)audio=new (window.AudioContext||window.webkitAudioContext)();if(!g.start){g.start=1;reset(1);beep(430,.05,'triangle',.02)}}

  function pointerDown(e){
    if(touchId>=0&&touchId!==e.pointerId)return;
    touchId=e.pointerId;c.setPointerCapture(touchId);
    maybeStart();
    if(g.dead){reset(1);beep(360,.05,'triangle',.02);return}
    if(g.lvup){pickByPos(e.clientX,e.clientY);return}
    if(g.pz){
      const l=puzzleLayout();
      for(let i=0;i<3;i++){
        const bt=l.btn[i];
        if(e.clientX>=bt.x&&e.clientX<=bt.x+bt.w&&e.clientY>=bt.y&&e.clientY<=bt.y+bt.h){puzzleInput(i);return}
      }
      return;
    }
    if(g.start&&!g.dead&&p.cat&&territoryBoxHit(e.clientX,e.clientY)){toggleCatalyst();return}
    if(e.pointerType==='mouse')return;
    touchMove=1;joyStart(e.clientX,e.clientY);joySet(e.clientX,e.clientY);
  }
  function pointerMove(e){if(touchId!==e.pointerId||!g.start||g.dead||g.lvup)return;if(touchMove)joySet(e.clientX,e.clientY)}
  function pointerUp(e){if(touchId!==e.pointerId)return;touchMove=0;joyReset();if(c.hasPointerCapture(touchId))c.releasePointerCapture(touchId);touchId=-1}

  function pickByPos(sx,sy){
    if(!g.lvup)return;
    const rects=getChoiceLayout().rects;
    for(let i=0;i<rects.length;i++){
      const r=rects[i];
      if(sx>=r.x&&sx<=r.x+r.w&&sy>=r.y&&sy<=r.y+r.h){takeChoice(i);break}
    }
  }

  function keyDown(e){
    const k=e.code;
    if(k==='Space'||k==='ArrowUp'||k==='ArrowDown'||k==='ArrowLeft'||k==='ArrowRight')e.preventDefault();
    if(k==='Space'||k==='Enter')maybeStart();
    if(g.dead&&(k==='Space'||k==='Enter'||k==='KeyR')){reset(1);beep(360,.05,'triangle',.02);return}
    if(g.lvup){if(k==='Digit1')takeChoice(0);else if(k==='Digit2')takeChoice(1);else if(k==='Digit3')takeChoice(2);return}
    if(g.pz){
      if(k==='Digit1')puzzleInput(0);
      else if(k==='Digit2')puzzleInput(1);
      else if(k==='Digit3')puzzleInput(2);
      return;
    }
    if(!g.start||g.dead)return;
    if(k==='KeyQ'){toggleCatalyst();return}
    if(k==='KeyA'||k==='ArrowLeft')keys.l=1;
    else if(k==='KeyD'||k==='ArrowRight')keys.r=1;
    else if(k==='KeyW'||k==='ArrowUp')keys.u=1;
    else if(k==='KeyS'||k==='ArrowDown')keys.d=1;
    else if(k==='KeyE'||k==='ShiftLeft'||k==='ShiftRight')keys.gr=1;
  }

  function keyUp(e){
    const k=e.code;
    if(k==='KeyA'||k==='ArrowLeft')keys.l=0;
    else if(k==='KeyD'||k==='ArrowRight')keys.r=0;
    else if(k==='KeyW'||k==='ArrowUp')keys.u=0;
    else if(k==='KeyS'||k==='ArrowDown')keys.d=0;
    else if(k==='KeyE'||k==='ShiftLeft'||k==='ShiftRight')keys.gr=0;
  }

  addEventListener('resize',resize);
  addEventListener('keydown',keyDown);
  addEventListener('keyup',keyUp);
  c.addEventListener('pointerdown',pointerDown,{passive:1});
  c.addEventListener('pointermove',pointerMove,{passive:1});
  c.addEventListener('pointerup',pointerUp,{passive:1});
  c.addEventListener('pointercancel',pointerUp,{passive:1});

  resize();
  reset(1);
  requestAnimationFrame(frame);
})();
</script></body></html>