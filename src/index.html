<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover">
<title>Scotty Survival</title>
<style>
:root{--bg:#0a0d12;--sky:#1a2940;--ink:#ecf3ff;--red:#ef4f6c;--mint:#69f0c9;--gold:#ffd56d;--line:#2f4868}
*{box-sizing:border-box}
html,body{margin:0;width:100%;height:100%;overflow:hidden;background:var(--bg);color:var(--ink);font-family:Trebuchet MS,Avenir Next,Segoe UI,sans-serif}
body{touch-action:none}
canvas{display:block;width:100%;height:100%}
</style>
</head>
<body>
<canvas id="c"></canvas>
<script>
(()=>{
  const c=document.getElementById('c'),x=c.getContext('2d');
  let W=360,H=740,DPR=1,last=0;

  const MAP_W=2600,MAP_H=1800;
  const MID_X=MAP_W*.5,MID_Y=MAP_H*.5;
  const HOME={x:260,y:MAP_H*.5,r:170};
  const SAFE_BUILDINGS=[
    {id:'home',n:'Cohon Centre',x:HOME.x,y:HOME.y,r:HOME.r,c:'#8ec0ff'},
    {id:'nsh',n:'nsh',x:980,y:460,r:170,c:'#79d7ff'},
    {id:'mel',n:'mellon',x:1880,y:1260,r:185,c:'#ffd58f'}
  ];
  const WHO=['i need to go out','these things are scary','may lord help us','can we ever go out?'];
  const WHI=['a dog?','scotty??','what the dog doing?'];
  const JOY_CENTER_SNAP=10;
  const JOY_INPUT_DEAD=.12;
  const MAX_Z=180,MAX_FOOD=260,MAX_FX=420,MAX_PUDD=18,MAX_B=260;

  const imgs={};
  function load(n){const i=new Image();i.src='black_scottish_terrier_dog_with_red_scarf/rotations/'+n+'.png';return i}
  imgs.e=load('east');imgs.w=load('west');imgs.ne=load('north-east');imgs.nw=load('north-west');imgs.se=load('south-east');imgs.sw=load('south-west');

  let audio=0;
  function beep(f,d,t,v){if(!audio)return;const o=audio.createOscillator(),g=audio.createGain();o.type=t||'triangle';o.frequency.value=f;g.gain.value=v||.02;g.gain.exponentialRampToValueAtTime(.0001,audio.currentTime+d);o.connect(g).connect(audio.destination);o.start();o.stop(audio.currentTime+d)}
  let memeT=0;
  function playMeme(){
    if(!g.start)return;
    const now=performance.now();
    if(now-memeT<1200)return;
    memeT=now;
    // Keep this cue fully local/synthesized to avoid runtime asset requests.
    beep(392,.07,'square',.02);
    beep(523,.08,'triangle',.014);
  }

  const g={
    start:0,dead:0,lvup:0,t:0,time:0,kills:0,
    spawnT:0,nextSpawn:.8,
    msg:'',msgT:0,
    level:1,xp:0,nextXp:24,
    stop:0,shake:0,xpPulse:0,cardT:0,
    best:+localStorage.ss_best||0,
    choices:[],
    homeNeed:2,homeGot:0,
    sch:{nsh:0,mel:0}, // 0 not started, 1 active, 2 done
    pz:0,
    uq:[],
    inB:'',bs:0,bd:0
  };

  const p={x:260,y:MAP_H*.5,vx:0,vy:0,r:15,hp:100,maxHp:100,speed:185,fireCd:0,fireRate:.46,dmg:12,range:400,shots:1,magnet:88,face:1,rx:0,ry:0,flash:0,gx:1,gy:0,zc:0,zr:0,zt:0,zx:1,zy:0,zcd:0,zDur:1,zSpd:2.1,zLoad:1.5,zCool:5.5,zDmg:24,zDr:.55,mkOn:0,mkT:0,mkI:8.8,mkS:0,mkD:14,mkR:54,mkSl:.5,chDo:20,chBurst:14,cat:0,catM:0,bot:0,bx:0,by:0,ba:0,bcd:0,bRate:.5,bDmg:.55,bRange:430};
  const keys={l:0,r:0,u:0,d:0,gr:0};
  let touchId=-1,touchMove=0;
  const joy={x:78,y:0,r:42,kr:16,tx:0,ty:0,ax:0,ay:0};

  const z=[];      // zombies
  const b=[];      // bullets
  const food=[];   // xp drops and static mints
  const pudd=[];   // territory puddles
  const fx=[];     // particles/text dots

  function rnd(a,b){return a+Math.random()*(b-a)}
  function clamp(v,a,b){return v<a?a:v>b?b:v}
  function eob(t){const c1=1.70158,c3=c1+1,u=t-1;return 1+c3*u*u*u+c1*u*u}
  function rr(px,py,pw,ph,pr){
    const r=Math.max(0,Math.min(pr,Math.min(pw,ph)*.5));
    x.beginPath();
    x.moveTo(px+r,py);
    x.lineTo(px+pw-r,py);
    x.quadraticCurveTo(px+pw,py,px+pw,py+r);
    x.lineTo(px+pw,py+ph-r);
    x.quadraticCurveTo(px+pw,py+ph,px+pw-r,py+ph);
    x.lineTo(px+r,py+ph);
    x.quadraticCurveTo(px,py+ph,px,py+ph-r);
    x.lineTo(px,py+r);
    x.quadraticCurveTo(px,py,px+r,py);
    x.closePath();
  }
  function getChoiceLayout(){
    const mobile=W<560;
    const bw=mobile?W-14:Math.min(W-20,620);
    const bh=mobile?clamp(H*.48,296,390):clamp(H*.4,268,340);
    const bx=(W-bw)*.5,by=H-bh-12;
    const rects=[];
    if(mobile){
      const gap=8,cw=bw-22,ch=Math.max(74,Math.min(100,(bh-84-gap*2)/3));
      const sy=by+50;
      for(let i=0;i<3;i++)rects.push({x:bx+14,y:sy+i*(ch+gap),w:cw,h:ch});
    }else{
      const gap=10,cw=(bw-32-gap*2)/3,ch=Math.max(102,Math.min(130,bh-82));
      const sy=by+52;
      for(let i=0;i<3;i++)rects.push({x:bx+16+i*(cw+gap),y:sy,w:cw,h:ch});
    }
    return {mobile,bx,by,bw,bh,rects};
  }
  function drawWrap(txt,px,py,maxW,lineH,maxLines){
    const ws=txt.split(' ');
    let line='',row=0;
    for(let i=0;i<ws.length;i++){
      const test=line?line+' '+ws[i]:ws[i];
      if(x.measureText(test).width<=maxW){line=test;continue;}
      x.fillText(line,px,py+row*lineH);
      row++;
      if(row>=maxLines)return;
      line=ws[i];
    }
    if(row<maxLines&&line)x.fillText(line,px,py+row*lineH);
  }
  function upIcon(n){
    if(n.includes('Chemical'))return '🧪';
    if(n.includes('Bot'))return '🤖';
    if(n.includes('Zoomies'))return '⚡';
    if(n.includes('Territory'))return '💧';
    if(n.includes('Rapid Fire'))return '🔥';
    if(n.includes('Big Bites'))return '🦷';
    if(n.includes('Speed Paws'))return '💨';
    if(n.includes('Extra Shot'))return '🎯';
    if(n.includes('Long Reach'))return '📡';
    if(n.includes('Snack Magnet'))return '🧲';
    if(n.includes('Tough Fur'))return '🛡️';
    if(n.includes('Quick Heal'))return '💚';
    return '⭐';
  }
  function school(id){for(let i=0;i<SAFE_BUILDINGS.length;i++)if(SAFE_BUILDINGS[i].id===id)return SAFE_BUILDINGS[i];return 0}
  function safeBuildingAt(px,py,pad){
    const extra=pad||0;
    for(let i=0;i<SAFE_BUILDINGS.length;i++){
      const b=SAFE_BUILDINGS[i],dx=px-b.x,dy=py-b.y;
      if(dx*dx+dy*dy<(b.r+extra)*(b.r+extra))return b;
    }
    return 0;
  }
  function pushOutsideSafe(o,pad){
    const extra=pad||0;
    let hit=0;
    for(let i=0;i<SAFE_BUILDINGS.length;i++){
      const b=SAFE_BUILDINGS[i];
      let dx=o.x-b.x,dy=o.y-b.y,ln=Math.hypot(dx,dy)||1;
      const rr=b.r+extra;
      if(ln<rr){
        if(ln<.001){const a=Math.random()*Math.PI*2;dx=Math.cos(a);dy=Math.sin(a);ln=1;}
        o.x=b.x+dx/ln*rr;
        o.y=b.y+dy/ln*rr;
        hit=1;
      }
    }
    return hit;
  }
  function puzzleLayout(){
    const bw=Math.min(W-24,420),bh=Math.min(H-130,260);
    const bx=(W-bw)*.5,by=(H-bh)*.5+24;
    const gap=10,bw3=(bw-36-gap*2)/3,by2=by+bh-72;
    return{
      bx,by,bw,bh,
      btn:[
        {x:bx+18,y:by2,w:bw3,h:46},
        {x:bx+18+bw3+gap,y:by2,w:bw3,h:46},
        {x:bx+18+(bw3+gap)*2,y:by2,w:bw3,h:46}
      ]
    };
  }
  function startPuzzle(id){
    if(g.pz)return;
    if(id==='nsh'){
      const a=(Math.random()*3)|0,b=(a+1+((Math.random()*2)|0))%3;
      g.pz={id:'nsh',seq:[a,b],step:0};
      g.msg='research task';g.msgT=1.2;
    }else if(id==='mel'){
      g.pz={id:'mel',seq:[(Math.random()*3)|0,(Math.random()*3)|0,(Math.random()*3)|0],step:0};
      g.msg='research task';g.msgT=1.2;
    }
  }
  function puzzleInput(n){
    if(!g.pz)return;
    const z2=g.pz;
    const ok=n===z2.seq[z2.step];
    if(ok){
      z2.step++;
      beep(620+z2.step*70,.04,'triangle',.018);
      if(z2.step>=z2.seq.length){
        const id=z2.id;
        g.pz=0;
        unlockSchool(id);
      }
    }else{
      z2.step=0;
      trauma(.03);
      beep(180,.06,'square',.02);
      g.msg='retry';g.msgT=.55;
    }
  }
  function beginSchool(id){
    if(id==='nsh'&&g.sch.nsh===0){
      g.sch.nsh=1;playMeme();startPuzzle('nsh');
      g.msg='help staff';g.msgT=1.4;beep(640,.05,'triangle',.02);
    }else if(id==='mel'&&g.sch.mel===0){
      g.sch.mel=1;playMeme();startPuzzle('mel');
      g.msg='help staff';g.msgT=1.4;beep(680,.05,'triangle',.02);
    }
  }
  function unlockSchool(id){
    if(id==='nsh'&&g.sch.nsh!==2){
      g.sch.nsh=2;queueUnlock('nsh');
      g.msg='nsh: bot unlock';g.msgT=2.1;trauma(.12);burst(p.x,p.y,'#79d7ff',16,95);beep(760,.07,'square',.024);
    }else if(id==='mel'&&g.sch.mel!==2){
      g.sch.mel=2;queueUnlock('mel');
      g.msg='mel: chem unlock';g.msgT=2.1;trauma(.12);burst(p.x,p.y,'#ffd58f',16,95);beep(720,.07,'square',.024);
    }
  }
  function toggleCatalyst(){
    if(!p.cat)return;
    p.catM=1-p.catM;
    g.msg='chem: '+(p.catM?'cor':'stick');
    g.msgT=.95;
    beep(p.catM?520:460,.04,'triangle',.02);
  }
  function objectiveText(){
    if(!p.mkOn)return 'cohon: mints '+g.homeGot+'/'+g.homeNeed;
    if(g.bd)return 'boss down';
    if(g.bs)return 'boss';
    if(g.pz&&g.pz.id==='nsh')return 'nsh puzzle';
    if(g.pz&&g.pz.id==='mel')return 'mel puzzle';
    if(g.sch.nsh===0)return 'go to nsh';
    if(g.sch.nsh===1)return 'nsh puzzle';
    if(g.sch.mel===0)return 'go mellon';
    if(g.sch.mel===1)return 'mel puzzle';
    return 'phase2';
  }
  function queueUnlock(id){
    if(g.uq.indexOf(id)<0)g.uq.push(id);
  }
  function popUnlockBook(){
    if(g.lvup||g.dead||g.pz||!g.uq.length)return;
    const id=g.uq.shift();
    let u=0;
    if(id==='nsh'&&!p.bot)u={n:'Bot Buddy',d:'orbit bot ally',f:()=>{p.bot=1;p.bx=p.x+20;p.by=p.y+4;p.bcd=.2;p.bRate=.5;p.bDmg=.55;p.bRange=430;}};
    else if(id==='mel'&&!p.cat)u={n:'Chemical Mode',d:'sticky/corrosive puddles',f:()=>{p.cat=1;p.catM=0;}};
    if(!u)return;
    g.choices=[u,u,u];
    g.lvup=1;
    g.cardT=0;
    g.msg='school unlock';
    g.msgT=1.4;
    beep(760,.07,'triangle',.028);
  }
  function territoryBoxHit(sx,sy){
    const ab=44,abGap=8,abX=W-18-ab,tY=14+ab+abGap;
    return sx>=abX&&sx<=abX+ab&&sy>=tY&&sy<=tY+ab;
  }
  function trauma(v){g.shake=clamp(g.shake+v,0,1.3)}
  function hitStop(v){g.stop=Math.max(g.stop,v)}

  function resize(){DPR=Math.max(1,Math.min(2,devicePixelRatio||1));W=Math.max(320,innerWidth|0);H=Math.max(560,innerHeight|0);c.width=(W*DPR)|0;c.height=(H*DPR)|0;x.setTransform(DPR,0,0,DPR,0,0);x.imageSmoothingEnabled=false;joy.y=H-88}
  function joyHit(cx,cy){const dx=cx-joy.x,dy=cy-joy.y;return dx*dx+dy*dy<(joy.r*1.8)*(joy.r*1.8)}
  function joySet(cx,cy){
    let dx=cx-joy.x,dy=cy-joy.y;
    const ln=Math.hypot(dx,dy)||1,m=joy.r;
    if(ln<JOY_CENTER_SNAP){dx=0;dy=0;}
    else if(ln>m){dx=dx/ln*m;dy=dy/ln*m}
    joy.tx=dx;joy.ty=dy;joy.ax=dx/m;joy.ay=dy/m;
  }
  function joyReset(){joy.tx=0;joy.ty=0;joy.ax=0;joy.ay=0}

  function pushFx(v){if(fx.length>=MAX_FX)return;fx.push(v)}
  function pushFood(v){
    if(food.length>=MAX_FOOD)return;
    food.push(v);
  }
  function pushBullet(v){
    if(b.length>=MAX_B)return;
    b.push(v);
  }
  function burst(px,py,col,n,s){
    const q=z.length>130?.5:z.length>90?.7:1;
    const cnt=Math.max(1,(n*q)|0);
    for(let i=0;i<cnt;i++){
      const a=Math.random()*Math.PI*2,sp=(s||70)*(0.4+Math.random());
      pushFx({x:px,y:py,vx:Math.cos(a)*sp,vy:Math.sin(a)*sp,t:rnd(.2,.6),c:col});
    }
  }
  function killZombie(i,col,n,s,mode){
    const m=z[i];
    const light=!!mode;
    if(m.k===3){g.bd=1;g.bs=0;g.msg='boss down';g.msgT=1.5;trauma(.24);beep(240,.12,'triangle',.03);}
    g.kills++;
    if(!light){
      hitStop(.03);
      trauma(.08);
      burst(m.x,m.y,col||'#ff9675',n||9,s||70);
      beep(280,.03,'square',.012);
    }else{
      burst(m.x,m.y,col||'#ff9675',Math.max(2,((n||9)*.35)|0),Math.max(20,(s||70)*.6));
    }
    const dropRoom=MAX_FOOD-food.length;
    if(dropRoom>0){
      const drops=light?(Math.random()<.25?1:0):(1+(Math.random()<.4?1:0));
      for(let k=0;k<Math.min(drops,dropRoom);k++){
        pushFood({x:m.x+rnd(-7,7),y:m.y+rnd(-7,7),v:rnd(5,8)|0,m:1,t:0});
      }
    }
    z.splice(i,1);
  }
  function markTerritory(){
    if(pudd.length>=MAX_PUDD)pudd.shift();
    pudd.push({x:p.x+p.gx*4,y:p.y+8,r:p.mkR,t:p.mkD,d:p.mkD,m:p.cat?p.catM:0});
    p.mkS=.32;
    p.mkT=p.mkI;
    g.msg='territory';
    g.msgT=.7;
    hitStop(.02);
    trauma(.05);
    burst(p.x,p.y+8,'#ffd56d',10,46);
    beep(560,.04,'triangle',.02);
  }

  function reset(full){
    g.dead=0;g.lvup=0;g.t=0;g.time=0;g.spawnT=0;g.nextSpawn=.8;g.kills=0;g.msg='';g.msgT=0;g.level=1;g.xp=0;g.nextXp=24;g.stop=0;g.shake=0;g.xpPulse=0;g.cardT=0;g.choices=[];g.homeGot=0;g.sch.nsh=0;g.sch.mel=0;g.pz=0;g.uq.length=0;g.inB='';g.bs=0;g.bd=0;
    p.x=260;p.y=MAP_H*.5;p.vx=0;p.vy=0;p.hp=100;p.maxHp=100;p.speed=185;p.fireCd=0;p.fireRate=.46;p.dmg=12;p.range=400;p.shots=1;p.magnet=88;p.face=1;p.rx=0;p.ry=0;p.flash=0;p.gx=1;p.gy=0;p.zc=0;p.zr=0;p.zt=0;p.zx=1;p.zy=0;p.zcd=0;p.zDur=1;p.zSpd=2.1;p.zLoad=1.5;p.zCool=5.5;p.zDmg=24;p.zDr=.55;p.mkOn=0;p.mkT=0;p.mkI=8.8;p.mkS=0;p.mkD=14;p.mkR=54;p.mkSl=.5;p.chDo=20;p.chBurst=14;p.cat=0;p.catM=0;p.bot=0;p.bx=p.x+20;p.by=p.y+4;p.ba=0;p.bcd=.2;p.bRate=.5;p.bDmg=.55;p.bRange=430;
    z.length=0;b.length=0;food.length=0;pudd.length=0;fx.length=0;
    keys.l=keys.r=keys.u=keys.d=keys.gr=0;touchMove=0;joyReset();
    g.msg='home: unlock territory';
    g.msgT=1.6;
    if(full){
      // middle mint patch
      for(let i=0;i<24;i++)pushFood({x:MID_X+rnd(-120,120),y:MID_Y+rnd(-120,120),v:7,m:1,t:0});
      // early trail to teach collection
      for(let i=0;i<10;i++)pushFood({x:330+i*58,y:MAP_H*.5+rnd(-60,60),v:5,m:1,t:0});
    }
  }

  function spawnZombie(){
    if(z.length>=MAX_Z)return;
    const a=Math.random()*Math.PI*2;
    const d=rnd(360,560);
    const base=1+g.time*.045;
    let hp=22+base*8+rnd(-4,8),sp=56+base*6+rnd(-6,10),r=rnd(12,18),dmg=8+base*.9,k=0;
    if(g.time>8&&Math.random()<.24){k=1;sp*=1.65;hp*=.66;r*=.82;dmg*=.82;}
    if(g.time>18&&Math.random()<.18){k=2;sp*=.74;hp*=2.15;r*=1.35;dmg*=1.28;}
    let zx=clamp(p.x+Math.cos(a)*d,20,MAP_W-20);
    let zy=clamp(p.y+Math.sin(a)*d,20,MAP_H-20);
    const sb=safeBuildingAt(zx,zy,10);
    if(sb){
      const dx=zx-sb.x,dy=zy-sb.y,ln=Math.hypot(dx,dy)||1;
      zx=sb.x+dx/ln*(sb.r+18);
      zy=sb.y+dy/ln*(sb.r+18);
    }
    z.push({x:zx,y:zy,r,hp,s:sp,dmg,vx:0,vy:0,ht:0,sl:0,ce:0,bm:0,bt:0,bi:'',k});
  }
  function spawnBoss(){
    if(g.bs||g.bd||z.length>=MAX_Z)return;
    const a=Math.random()*Math.PI*2,d=520,m={x:clamp(p.x+Math.cos(a)*d,40,MAP_W-40),y:clamp(p.y+Math.sin(a)*d,40,MAP_H-40),r:34,hp:560+g.time*10,s:44,dmg:22,vx:0,vy:0,ht:0,sl:0,ce:0,bm:0,bt:0,bi:'',k:3};
    pushOutsideSafe(m,28);z.push(m);g.bs=1;g.msg='boss!';g.msgT=1.2;beep(170,.15,'sawtooth',.03);trauma(.2);
  }
  function nearestZombie(){
    let best=0,bd=1e9;
    for(let i=0;i<z.length;i++){
      const dz=z[i],dx=dz.x-p.x,dy=dz.y-p.y,d=dx*dx+dy*dy;
      if(d<bd){bd=d;best=dz}
    }
    return best;
  }

  function shoot(){
    const t=nearestZombie();
    if(!t)return;
    let dx=t.x-p.x,dy=t.y-p.y,ln=Math.hypot(dx,dy)||1;
    if(ln>p.range)return;
    dx/=ln;dy/=ln;
    const n=p.shots,spread=.18;
    for(let i=0;i<n;i++){
      const off=n===1?0:(i-(n-1)/2)*spread;
      const cs=Math.cos(off),sn=Math.sin(off);
      const sx=dx*cs-dy*sn,sy=dx*sn+dy*cs;
      pushBullet({x:p.x,y:p.y,vx:sx*520,vy:sy*520,d:p.dmg,life:1.05,pier:1});
    }
    p.gx=dx;p.gy=dy;
    p.rx-=dx*6;p.ry-=dy*4;
    p.flash=.07;
    p.face=dx>=0?1:-1;
    burst(p.x+dx*16,p.y+dy*10,'#ffd56d',3,35);
    trauma(.025);
    beep(640,.04,'square',.018);
  }

  function addXp(v){
    g.xp+=v;
    while(g.xp>=g.nextXp){
      g.xp-=g.nextXp;
      g.level++;
      g.nextXp=(g.nextXp*1.36+9)|0;
      rollChoices();
      g.lvup=1;
      g.cardT=0;
      g.xpPulse=.65;
      g.msg='upgrade';
      g.msgT=2.1;
      hitStop(.06);
      trauma(.2);
      beep(860,.08,'triangle',.03);
      break;
    }
  }

  const UPS=[
    {n:'Rapid Fire',d:'faster shots',f:()=>p.fireRate=Math.max(.15,p.fireRate*.84),req:()=>1},
    {n:'Big Bites',d:'+6 dmg',f:()=>p.dmg+=6,req:()=>1},
    {n:'Speed Paws',d:'+24 speed',f:()=>p.speed+=24,req:()=>1},
    {n:'Extra Shot',d:'+1 shot',f:()=>p.shots=Math.min(5,p.shots+1),req:()=>1},
    {n:'Long Reach',d:'+120 range',f:()=>p.range+=120,req:()=>1},
    {n:'Snack Magnet',d:'+30 magnet',f:()=>p.magnet+=30,req:()=>1},
    {n:'Tough Fur',d:'+25 max hp',f:()=>{p.maxHp+=25;p.hp=Math.min(p.maxHp,p.hp+25)},req:()=>1},
    {n:'Quick Heal',d:'heal 35',f:()=>p.hp=Math.min(p.maxHp,p.hp+35),req:()=>1},
    {n:'Zoomies Time',d:'+0.25s zoom',f:()=>p.zDur=Math.min(2.6,p.zDur+.25),req:()=>1},
    {n:'Zoomies CD',d:'-0.7s cd',f:()=>p.zCool=Math.max(1.4,p.zCool-.7),req:()=>1},
    {n:'Zoomies Speed',d:'+0.35x spd',f:()=>p.zSpd=Math.min(4,p.zSpd+.35),req:()=>1},
    {n:'Zoomies Charge',d:'-0.2s load',f:()=>p.zLoad=Math.max(.55,p.zLoad-.2),req:()=>1},
    {n:'Territory CD',d:'-0.55s cd',f:()=>p.mkI=Math.max(3.2,p.mkI-.55),req:()=>p.mkOn},
    {n:'Territory Radius',d:'+12 radius',f:()=>p.mkR=Math.min(110,p.mkR+12),req:()=>p.mkOn},
    {n:'Territory Duration',d:'+4s life',f:()=>p.mkD=Math.min(40,p.mkD+4),req:()=>p.mkOn},
    {n:'Territory Slow',d:'+10% slow',f:()=>p.mkSl=Math.min(.88,p.mkSl+.1),req:()=>p.mkOn},
    {n:'Chemical Puddle',d:'+8 dps +6 burst',f:()=>{p.chDo=Math.min(58,p.chDo+8);p.chBurst=Math.min(42,p.chBurst+6)},req:()=>p.cat},
    {n:'Chemical Radius',d:'+10 radius',f:()=>p.mkR=Math.min(120,p.mkR+10),req:()=>p.cat},
    {n:'Chemical Tempo',d:'-0.45s cd',f:()=>p.mkI=Math.max(2.6,p.mkI-.45),req:()=>p.cat},
    {n:'Bot Rate',d:'faster bot',f:()=>p.bRate=Math.max(.18,p.bRate*.82),req:()=>p.bot},
    {n:'Bot Damage',d:'+20% bot dmg',f:()=>p.bDmg=Math.min(1.7,p.bDmg+.2),req:()=>p.bot},
    {n:'Bot Radar',d:'+70 bot range',f:()=>p.bRange=Math.min(820,p.bRange+70),req:()=>p.bot}
  ];

  function rollChoices(){
    const pool=UPS.filter(u=>!u.req||u.req());
    g.choices=[];
    for(let i=0;i<3&&pool.length;i++){
      const k=(Math.random()*pool.length)|0;
      g.choices.push(pool[k]);
      pool.splice(k,1);
    }
  }

  function takeChoice(i){
    if(!g.lvup||!g.choices[i])return;
    g.choices[i].f();
    g.lvup=0;
    g.msg=g.choices[i].n+' applied';
    g.msgT=1.4;
    g.xpPulse=.25;
    trauma(.08);
    burst(p.x,p.y,'#69f0c9',12,90);
    popUnlockBook();
  }

  function hitPlayer(d){
    if(p.zt>0)d*=p.zDr;
    p.hp-=d;
    trauma(.03);
    if(p.hp<=0){
      p.hp=0;g.dead=1;g.start=1;
      if(g.kills>g.best){g.best=g.kills|0;localStorage.ss_best=g.best}
      g.msg='swarmed';g.msgT=999;
      hitStop(.09);
      trauma(.42);
      beep(120,.22,'sawtooth',.05);
      burst(p.x,p.y,'#ff6f89',26,130);
    }
  }

  function update(dt){
    const rdt=dt;
    if(g.msgT>0)g.msgT-=rdt;
    if(g.stop>0){g.stop=Math.max(0,g.stop-rdt);dt*=.06;}
    if(g.shake>0)g.shake=Math.max(0,g.shake-rdt*2.2);
    if(g.xpPulse>0)g.xpPulse=Math.max(0,g.xpPulse-rdt*1.7);
    if(p.flash>0)p.flash=Math.max(0,p.flash-rdt*7);
    p.rx*=Math.max(0,1-rdt*18);
    p.ry*=Math.max(0,1-rdt*18);
    if(p.zcd>0)p.zcd=Math.max(0,p.zcd-rdt);
    if(p.mkS>0)p.mkS=Math.max(0,p.mkS-rdt);
    // Territory timer pauses during active zoomies so it never interrupts the dash.
    if(p.mkT>0&&p.zt<=0)p.mkT=Math.max(0,p.mkT-rdt);
    for(let i=pudd.length-1;i>=0;i--){const pd=pudd[i];pd.t-=dt;if(pd.t<=0)pudd.splice(i,1);}
    for(let i=fx.length-1;i>=0;i--){const f=fx[i];f.t-=dt;f.x+=f.vx*dt;f.y+=f.vy*dt;f.vy+=480*dt;if(f.t<=0)fx.splice(i,1)}

    if(!g.start||g.dead)return;
    if(g.lvup){g.cardT=Math.min(.9,g.cardT+rdt);return;}
    if(g.pz){g.t+=dt;return;}
    g.t+=dt;

    const nsh=school('nsh'),mel=school('mel');
    if(p.mkOn&&g.sch.nsh===0&&Math.hypot(p.x-nsh.x,p.y-nsh.y)<nsh.r)beginSchool('nsh');
    if(g.sch.nsh===2&&g.sch.mel===0&&Math.hypot(p.x-mel.x,p.y-mel.y)<mel.r)beginSchool('mel');
    popUnlockBook();

    // movement (keyboard + touch)
    const kx=(keys.r?1:0)-(keys.l?1:0),ky=(keys.d?1:0)-(keys.u?1:0);
    const joyMag=Math.hypot(joy.ax,joy.ay);
    let mx=kx,my=ky;
    if(touchMove&&joyMag>JOY_INPUT_DEAD){mx+=joy.ax;my+=joy.ay}
    let ln=Math.hypot(mx,my);
    if(ln>1){mx/=ln;my/=ln;}

    const hasInput=(Math.hypot(kx,ky)>.05||(touchMove&&joyMag>JOY_INPUT_DEAD))&&p.mkS<=0;
    if(p.mkOn&&p.mkT<=0&&p.mkS<=0&&p.zt<=0&&p.zr<=0&&p.zc<=0)markTerritory();
    if(p.zt<=0){
      if(!hasInput&&p.zcd<=0&&p.mkS<=0){
        p.zc=Math.min(p.zLoad,p.zc+dt);
        if(p.zc>.25){
          const q=p.zc/p.zLoad;
          p.rx+=(Math.random()*2-1)*.9*q*60*dt;
          p.ry+=(Math.random()*2-1)*.9*q*60*dt;
          trauma(.0007*q*60*dt);
        }
        if(p.zc>=p.zLoad&&!p.zr){
          p.zr=1;
          g.msg='zoomies ready';
          g.msgT=1.1;
          trauma(.08);
          beep(760,.05,'triangle',.024);
        }
      }else{
        if(p.zr){
          p.zt=p.zDur;
          p.zr=0;
          p.zc=0;
          const l2=ln||1;
          p.zx=mx/l2;
          p.zy=my/l2;
          hitStop(.04);
          trauma(.28);
          p.flash=.09;
          p.gx=p.zx;p.gy=p.zy;
          burst(p.x,p.y,'#9dffea',18,120);
          beep(980,.06,'square',.028);
        }else{
          p.zc=0;
        }
      }
    }

    if(p.zt>0){
      p.zt=Math.max(0,p.zt-dt);
      if(hasInput){
        p.zx=p.zx*.85+mx*.15;
        p.zy=p.zy*.85+my*.15;
        const n=Math.hypot(p.zx,p.zy)||1;
        p.zx/=n;p.zy/=n;
      }
      p.vx=p.zx*p.speed*p.zSpd;
      p.vy=p.zy*p.speed*p.zSpd;
      p.face=p.vx>=0?1:-1;
      p.rx-=p.zx*8*dt*60;
      p.ry-=p.zy*6*dt*60;
      if(Math.random()<.65)pushFx({x:p.x-rnd(-6,6),y:p.y-rnd(-6,6),vx:-p.vx*.12+rnd(-35,35),vy:-p.vy*.12+rnd(-35,35),t:rnd(.1,.25),c:'#8fffe5'});
      if(p.zt<=0){p.zcd=p.zCool;g.msg='zoomies cd';g.msgT=.65;beep(420,.04,'triangle',.016)}
    }else{
      p.vx=mx*p.speed;p.vy=my*p.speed;
      if(Math.abs(p.vx)>.5)p.face=p.vx>0?1:-1;
      if(p.mkS>0){
        p.vx=0;p.vy=0;
        p.rx+=Math.sin(g.t*45)*.5;
        if(Math.random()<.7)pushFx({x:p.x+rnd(-5,5),y:p.y+10+rnd(-3,3),vx:rnd(-14,14),vy:rnd(6,30),t:rnd(.12,.26),c:'#ffd56d'});
      }
    }

    p.x=clamp(p.x+p.vx*dt,12,MAP_W-12);
    p.y=clamp(p.y+p.vy*dt,12,MAP_H-12);
    const pSafeNow=safeBuildingAt(p.x,p.y,-6);
    if(!pSafeNow)g.time+=dt;
    const bid=pSafeNow?pSafeNow.id:'';
    g.inB=bid;

    if(p.bot){
      p.ba+=dt*2.3;
      const tx=p.x+Math.cos(p.ba)*34,ty=p.y+Math.sin(p.ba*1.17)*20;
      p.bx+= (tx-p.bx)*Math.min(1,dt*8);
      p.by+= (ty-p.by)*Math.min(1,dt*8);
      if(!pSafeNow)p.bcd-=dt;
      if(!pSafeNow&&p.bcd<=0){
        let t=0,bd=p.bRange*p.bRange;
        for(let i=0;i<z.length;i++){
          const m=z[i],dx=m.x-p.bx,dy=m.y-p.by,d2=dx*dx+dy*dy;
          if(d2<bd){bd=d2;t=m;}
        }
        if(t){
          const ln2=Math.hypot(t.x-p.bx,t.y-p.by)||1;
          pushBullet({x:p.bx,y:p.by,vx:(t.x-p.bx)/ln2*540,vy:(t.y-p.by)/ln2*540,d:p.dmg*p.bDmg,life:.9,pier:0,c:'#9de6ff'});
          p.bcd=p.bRate;
        }else p.bcd=.2;
      }
    }

    // auto-shoot
    p.fireCd-=dt;
    if(!pSafeNow&&p.fireCd<=0){p.fireCd=p.fireRate;shoot()}

    // spawn
    g.spawnT-=dt;
    if(g.sch.mel===2&&!g.bs&&!g.bd&&(g.kills>26||g.time>52))spawnBoss();
    if(g.spawnT<=0){
      g.spawnT=g.nextSpawn;
      g.nextSpawn=Math.max(.18,.78-g.time*.018);
      spawnZombie();
      if(!g.bs&&g.time>26&&Math.random()<.28)spawnZombie();
    }

    // bullets
    for(let i=b.length-1;i>=0;i--){
      const q=b[i];
      q.life-=dt;q.x+=q.vx*dt;q.y+=q.vy*dt;
      if(q.life<=0||q.x<-20||q.y<-20||q.x>MAP_W+20||q.y>MAP_H+20){b.splice(i,1);continue}
      for(let j=z.length-1;j>=0;j--){
        const m=z[j],dx=m.x-q.x,dy=m.y-q.y;
        if(dx*dx+dy*dy<(m.r+3)*(m.r+3)){
          m.hp-=q.d;
          m.ht=.09;
          m.vx+=q.vx*.07;
          m.vy+=q.vy*.07;
          q.pier--;
          if(m.hp<=0)killZombie(j,'#ff9675',9,70);
          if(q.pier<0){b.splice(i,1);break}
        }
      }
    }

    // zombies + contact damage
    let contact=0;
    let zoomHits=0,zoomKills=0;
    const pSafe=pSafeNow;
    for(let i=z.length-1;i>=0;i--){
      const m=z[i];
      let tx=p.x,ty=p.y;
      if(pSafe){
        if(m.bi!==pSafe.id){m.bi=pSafe.id;m.bm=0;m.bt=rnd(.9,1.7);}
        m.bt-=dt;
        if(m.bt<=0){
          if(m.bm===0){m.bm=1;m.bt=rnd(1.1,2.1);}
          else{m.bm=0;m.bt=rnd(.9,1.7);}
        }
        if(m.bm===0){
          const pdx=p.x-pSafe.x,pdy=p.y-pSafe.y,pl=Math.hypot(pdx,pdy)||1;
          tx=pSafe.x+pdx/pl*(pSafe.r+8);
          ty=pSafe.y+pdy/pl*(pSafe.r+8);
        }else{
          const bx=m.x-pSafe.x,by=m.y-pSafe.y,bl=Math.hypot(bx,by)||1;
          tx=m.x+bx/bl*220+(-by/bl)*Math.sin(g.t*2+i)*30;
          ty=m.y+by/bl*220+(bx/bl)*Math.sin(g.t*2+i)*30;
        }
      }else{
        m.bi='';m.bt=0;m.bm=0;
      }
      const dx=tx-m.x,dy=ty-m.y,ln=Math.hypot(dx,dy)||1;
      let sf=1,inPad=0,padMode=0;
      for(let k=0;k<pudd.length;k++){
        const pd=pudd[k],px=m.x-pd.x,py=m.y-pd.y;
        if(px*px+py*py<pd.r*pd.r){
          padMode=pd.m?1:0;
          const slow=pd.m?0.36:0.72;
          sf=Math.min(sf,1-slow);
          inPad=1;
          if(pd.m&&p.cat&&m.ce<=0){
            m.ce=.55;
            m.hp-=p.chBurst;
            burst(m.x,m.y,'#ffd58f',5,44);
          }
          break;
        }
      }
      if(p.bot){
        const bx=m.x-p.bx,by=m.y-p.by;
        if(bx*bx+by*by<20*20)sf=Math.min(sf,.65);
      }
      m.sl=inPad;
      if(inPad){
        const dot=(p.cat&&padMode)?p.chDo:0;
        if(dot>0)m.hp-=dot*dt;
        m.ht=Math.max(m.ht,.08);
        if(m.hp<=0){killZombie(i,'#f7d96b',8,60);continue;}
      }
      if(m.ce>0)m.ce=Math.max(0,m.ce-dt);
      m.vx*=Math.max(0,1-dt*8);
      m.vy*=Math.max(0,1-dt*8);
      m.ht=Math.max(0,m.ht-dt);
      m.x+=(dx/ln*m.s*sf+m.vx)*dt;
      m.y+=(dy/ln*m.s*sf+m.vy)*dt;
      if(pushOutsideSafe(m,6)){
        m.vx*=.4;
        m.vy*=.4;
      }
      const cdx=p.x-m.x,cdy=p.y-m.y,cln=Math.hypot(cdx,cdy)||1;
      if(cln<m.r+p.r-1){
        if(p.zt>0){
          m.hp-=p.zDmg;
          m.ht=.12;
          m.vx+=p.zx*280;
          m.vy+=p.zy*280;
          zoomHits++;
          if(m.hp<=0){
            killZombie(i,'#8fffe5',12,90,1);
            zoomKills++;
            continue;
          }
          contact+=m.dmg*.35;
          continue;
        }
        contact+=m.dmg;
      }
    }
    if(zoomHits>0){
      hitStop(Math.min(.04,.012*zoomHits));
      trauma(Math.min(.24,.04*zoomHits));
      g.xpPulse=Math.min(.6,g.xpPulse+.06*zoomHits);
      beep(260,.02,'square',.016);
      if(zoomKills>1)beep(310,.02,'square',.013);
    }
    if(contact>0)hitPlayer(contact*dt);

    // food pickups
    for(let i=food.length-1;i>=0;i--){
      const f=food[i],dx=p.x-f.x,dy=p.y-f.y,ln=Math.hypot(dx,dy)||1;
      if(ln<p.magnet){f.x+=dx/ln*240*dt;f.y+=dy/ln*240*dt}
      if(ln<p.r+8){
        addXp(f.v);food.splice(i,1);g.xpPulse=Math.min(.5,g.xpPulse+.11);burst(p.x,p.y,'#69f0c9',4,40);
        if(!p.mkOn){
          g.homeGot++;
          if(g.homeGot>=g.homeNeed){
            p.mkOn=1;p.mkT=.25;
            g.msg='territory: nsh';
            g.msgT=2.2;
            beep(820,.07,'triangle',.028);
            burst(p.x,p.y,'#ffd56d',16,95);
          }
        }
      }
    }

    if((keys.gr||touchMove)&&Math.random()<.04&&g.time>2){
      // tiny bonus eating trail for movement engagement
      pushFood({x:clamp(p.x+rnd(-20,20),12,MAP_W-12),y:clamp(p.y+rnd(-20,20),12,MAP_H-12),v:4,m:1,t:0});
    }
  }

  function cam(){return {x:clamp(p.x-W*.5,0,MAP_W-W),y:clamp(p.y-H*.5,0,MAP_H-H)}}

  function draw(){
    const sk=g.shake*g.shake;
    const sx=(Math.random()*2-1)*10*sk;
    const sy=(Math.random()*2-1)*10*sk;
    x.setTransform(DPR,0,0,DPR,sx,sy);
    const cm=cam();

    // bg
    const g1=x.createLinearGradient(0,0,0,H);g1.addColorStop(0,'#263f60');g1.addColorStop(.55,'#16273f');g1.addColorStop(1,'#0b111a');
    x.fillStyle=g1;x.fillRect(0,0,W,H);

    // grid doodle
    x.strokeStyle='rgba(63,96,132,.35)';x.lineWidth=1;
    const step=56,ox=-(cm.x%step),oy=-(cm.y%step);
    for(let yy=oy;yy<H;yy+=step){x.beginPath();x.moveTo(0,yy|0);x.lineTo(W,yy|0);x.stroke()}
    for(let xx=ox;xx<W;xx+=step){x.beginPath();x.moveTo(xx|0,0);x.lineTo(xx|0,H);x.stroke()}

    // middle mint zone tint
    const mx=MID_X-cm.x,my=MID_Y-cm.y;
    x.fillStyle='rgba(105,240,201,.07)';x.beginPath();x.arc(mx,my,210,0,Math.PI*2);x.fill();

    // school zones (phase 1)
    const inBuild=safeBuildingAt(p.x,p.y,-8);
    for(let i=0;i<SAFE_BUILDINGS.length;i++){
      const s=SAFE_BUILDINGS[i],sx=s.x-cm.x,sy=s.y-cm.y;
      if(sx<-s.r-30||sy<-s.r-30||sx>W+s.r+30||sy>H+s.r+30)continue;
      const done=s.id==='home'?0:g.sch[s.id]===2;
      const active=s.id==='home'?!p.mkOn:g.sch[s.id]===1;
      x.globalAlpha=done?.18:active?.14:.08;
      x.fillStyle=s.c;x.beginPath();x.arc(sx,sy,s.r,0,Math.PI*2);x.fill();
      x.globalAlpha=.65;
      x.strokeStyle=done?'#9effc8':s.c;x.lineWidth=2;x.beginPath();x.arc(sx,sy,s.r,0,Math.PI*2);x.stroke();
      x.globalAlpha=1;
      x.fillStyle='#dce8ff';x.font='600 12px Trebuchet MS,sans-serif';x.fillText(s.n,sx-s.r+10,sy-s.r-8);
      const bw=s.id==='home'?48:44,bh=30,bx=sx-bw*.5,by=sy-bh*.5;
      x.fillStyle='rgba(18,25,37,.9)';x.fillRect(bx,by,bw,bh);
      x.strokeStyle='rgba(165,190,220,.55)';x.lineWidth=1;x.strokeRect((bx+.5)|0,(by+.5)|0,bw-1,bh-1);
      x.fillStyle='rgba(248,234,164,.86)';x.fillRect((bx+6)|0,(by+6)|0,11,8);x.fillRect((bx+bw-17)|0,(by+6)|0,11,8);
      x.fillStyle='rgba(44,56,72,.95)';x.beginPath();x.arc(bx+11+Math.sin(g.t*2+i),by+11,1.7,0,Math.PI*2);x.fill();x.beginPath();x.arc(bx+bw-11+Math.sin(g.t*2+i+1),by+11,1.7,0,Math.PI*2);x.fill();
      if(g.start&&!g.dead){
        const wl=inBuild?WHI:WHO;
        const wt=wl[((g.t*.45+i*2)|0)%wl.length],wy=sy-s.r*.44,ww=wt.length*4.6+12;
        x.fillStyle='rgba(8,12,20,.82)';rr(sx-ww*.5,wy-9,ww,16,7);x.fill();
        x.fillStyle='rgba(220,240,255,.9)';x.font='600 9px Trebuchet MS,sans-serif';x.fillText(wt,sx-ww*.5+6,wy+3);
      }
    }

    // food
    for(let i=0;i<food.length;i++){
      const f=food[i],sx=f.x-cm.x,sy=f.y-cm.y;
      if(sx<-10||sy<-10||sx>W+10||sy>H+10)continue;
      x.fillStyle='#69f0c9';x.beginPath();x.arc(sx,sy,5,0,Math.PI*2);x.fill();
      x.fillStyle='#ceffef';x.fillRect((sx-1)|0,(sy-1)|0,2,2);
    }
    // territory puddles
    for(let i=0;i<pudd.length;i++){
      const pd=pudd[i],sx=pd.x-cm.x,sy=pd.y-cm.y;
      if(sx<-pd.r-20||sy<-pd.r-20||sx>W+pd.r+20||sy>H+pd.r+20)continue;
      const q=pd.t/pd.d;
      x.globalAlpha=.12+.1*q;
      let pf='#f4d96e',ps='#fff0a9';
      if(p.cat){pf=pd.m?'#53d93d':'#9fe65a';ps=pd.m?'#baff87':'#e4ff9a';}
      x.fillStyle=pf;
      x.beginPath();x.arc(sx,sy,pd.r,0,Math.PI*2);x.fill();
      x.globalAlpha=.2+.2*Math.sin((g.t+i)*5)*q;
      x.strokeStyle=ps;x.lineWidth=1.5;
      x.beginPath();x.arc(sx,sy,pd.r*.68+Math.sin((g.t+i)*4)*2,0,Math.PI*2);x.stroke();
      if(p.cat){
        x.globalAlpha=.18+.24*q;
        x.fillStyle=pd.m?'#dbff8f':'#f1ffb3';
        x.beginPath();x.arc(sx+Math.sin(g.t*4+i)*pd.r*.22,sy-pd.r*.16,2.4+Math.sin(g.t*7+i)*.7,0,Math.PI*2);x.fill();
        x.beginPath();x.arc(sx-pd.r*.18,sy+Math.sin(g.t*3+i*.7)*pd.r*.14,1.9+Math.sin(g.t*8+i*.4)*.5,0,Math.PI*2);x.fill();
        x.beginPath();x.arc(sx+pd.r*.12,sy+pd.r*.2,1.6+Math.sin(g.t*6+i*.5)*.4,0,Math.PI*2);x.fill();
      }
      x.globalAlpha=1;
    }

    // zombies
    for(let i=0;i<z.length;i++){
      const m=z[i],sx=m.x-cm.x,sy=m.y-cm.y;
      if(sx<-40||sy<-40||sx>W+40||sy>H+40)continue;
      const mc=m.k===3?'#a789ff':m.k===2?'#665a78':m.k===1?'#5687a1':(m.sl?'#70805a':'#4b667f');
      x.fillStyle=m.ht>0?'#9db4d1':mc;x.beginPath();x.arc(sx,sy,m.r,0,Math.PI*2);x.fill();
      x.fillStyle='#f0627c';x.fillRect((sx-4)|0,(sy-2)|0,3,3);x.fillRect((sx+1)|0,(sy-2)|0,3,3);
    }

    // bullets
    for(let i=0;i<b.length;i++){
      const q=b[i],sx=q.x-cm.x,sy=q.y-cm.y;
      x.fillStyle=q.c||'#ffd56d';
      x.fillRect((sx-2)|0,(sy-2)|0,4,4);
    }

    // player
    const psx=p.x-cm.x+p.rx,psy=p.y-cm.y+p.ry;
    const spr = Math.abs(p.vx)>=Math.abs(p.vy) ? (p.face>0?imgs.e:imgs.w) : (p.vy<0?(p.face>0?imgs.ne:imgs.nw):(p.face>0?imgs.se:imgs.sw));
    x.fillStyle='rgba(0,0,0,.35)';x.beginPath();x.ellipse(psx,psy+14,17,6,0,0,Math.PI*2);x.fill();
    if(spr&&spr.complete)x.drawImage(spr,psx-22,psy-18,44,30); else {x.fillStyle='#0b0f14';x.beginPath();x.arc(psx,psy,12,0,Math.PI*2);x.fill();x.fillStyle='#ef4f6c';x.fillRect((psx+3)|0,(psy-6)|0,7,3)}
    if(p.bot){
      const bx=p.bx-cm.x,by=p.by-cm.y;
      x.fillStyle='rgba(0,0,0,.25)';x.beginPath();x.ellipse(bx,by+8,11,4,0,0,Math.PI*2);x.fill();
      x.fillStyle='#88ddff';x.beginPath();x.arc(bx,by,9,0,Math.PI*2);x.fill();
      x.fillStyle='#16314a';x.fillRect((bx-3)|0,(by-2)|0,2,2);x.fillRect((bx+1)|0,(by-2)|0,2,2);
      x.strokeStyle='#dfffff';x.lineWidth=1.2;x.beginPath();x.arc(bx,by,12+Math.sin(g.t*9)*1.5,0,Math.PI*2);x.stroke();
    }
    if(p.mkS>0&&p.zt<=0){
      const dir=p.face>0?-1:1;
      const q=clamp(p.mkS/.32,0,1);
      const sx2=psx+dir*13,sy2=psy+8;
      const ex2=sx2+dir*(11+Math.sin(g.t*36)*2.2),ey2=sy2+7+Math.sin(g.t*22)*1.1;
      x.strokeStyle='rgba(248,220,112,'+(0.38+q*.45)+')';
      x.lineWidth=2;
      x.beginPath();
      x.moveTo(sx2,sy2);
      x.quadraticCurveTo((sx2+ex2)*.5,sy2+2,ex2,ey2);
      x.stroke();
      x.fillStyle='rgba(250,214,103,.72)';
      x.beginPath();x.arc(ex2+dir*2,ey2+2,2.1,0,Math.PI*2);x.fill();
      x.fillStyle='rgba(244,205,93,.38)';
      x.beginPath();x.ellipse(ex2+dir*5,ey2+7,5.2,2.7,0,0,Math.PI*2);x.fill();
    }
    if((p.zc>0||p.zcd>0)&&p.zt<=0){
      const q=p.zcd>0?0:Math.min(1,p.zc/p.zLoad),cd=q<=0?Math.max(0,1-p.zcd/p.zCool):0;
      const rr=18+q*8+Math.sin(g.t*22)*1.2;
      x.strokeStyle=p.zr?'#8fffe5':'#ffd56d';
      x.lineWidth=2+q*1.8;
      x.beginPath();x.arc(psx,psy,rr,-Math.PI*.5,-Math.PI*.5+Math.PI*2*q);x.stroke();
      if(p.zcd>0){
        x.strokeStyle='rgba(158,200,255,.7)';
        x.lineWidth=2;
        x.beginPath();x.arc(psx,psy,16,-Math.PI*.5,-Math.PI*.5+Math.PI*2*cd);x.stroke();
      }
    }
    if(p.zt>0){
      const q=p.zt/2;
      x.strokeStyle='rgba(143,255,229,.7)';
      x.lineWidth=2.5;
      x.beginPath();x.arc(psx,psy,20+Math.sin(g.t*30)*2+q*4,0,Math.PI*2);x.stroke();
      x.fillStyle='rgba(143,255,229,.16)';
      x.beginPath();x.ellipse(psx-p.zx*10,psy-p.zy*7,20,10,Math.atan2(p.zy,p.zx),0,Math.PI*2);x.fill();
    }
    if(p.flash>0){
      x.globalAlpha=p.flash/.07;
      x.fillStyle='#ffe598';
      x.beginPath();
      x.moveTo(psx+p.gx*16,psy+p.gy*8);
      x.lineTo(psx+p.gx*24-p.gy*5,psy+p.gy*24+p.gx*4);
      x.lineTo(psx+p.gx*24+p.gy*5,psy+p.gy*24-p.gx*4);
      x.closePath();
      x.fill();
      x.globalAlpha=1;
    }

    // particles
    for(let i=0;i<fx.length;i++){
      const f=fx[i],sx=f.x-cm.x,sy=f.y-cm.y;
      if(sx<-8||sy<-8||sx>W+8||sy>H+8)continue;
      x.globalAlpha=Math.max(0,Math.min(1,f.t*2.4));
      x.fillStyle=f.c;
      x.fillRect((sx)|0,(sy)|0,3,3);
    }
    x.globalAlpha=1;

    // HUD
    const ab=44,abGap=8,abX=W-18-ab,zY=14,tY=14+ab+abGap;
    const hudCompact=W<420;
    const hudH=104;
    let hpY=62,xpY=74;
    const barsW=Math.max(96,W-190);
    const hudBottom=10+hudH;
    x.fillStyle='rgba(7,10,16,.76)';x.fillRect(10,10,W-20,hudH);
      x.fillStyle='#eef4ff';x.font='700 17px Trebuchet MS,sans-serif';x.fillText('SCOTTY',20,32);
    if(hudCompact){
      const statsY=52;
      x.font='600 12px Trebuchet MS,sans-serif';
      x.fillStyle='#9ec8ff';x.fillText('T '+g.time.toFixed(1)+'s',20,statsY);
      x.fillStyle='#ffd56d';x.fillText('K '+g.kills,W*.4,statsY);
      x.textAlign='right';
      x.fillStyle='#dce8ff';x.fillText('Best '+g.best,W-24,statsY);
      x.textAlign='left';
      hpY=62;xpY=74;
    }else{
      x.font='600 14px Trebuchet MS,sans-serif';
      x.fillStyle='#9ec8ff';x.fillText('Time '+g.time.toFixed(1)+'s',20,54);
      x.fillStyle='#ffd56d';x.fillText('Kills '+g.kills,150,54);
      x.textAlign='right';
      x.fillStyle='#dce8ff';x.fillText('Best '+g.best,W-24,54);
      x.textAlign='left';
    }

    // hp
    x.fillStyle='#2a3346';x.fillRect(20,hpY,barsW,10);
    x.fillStyle='#ef4f6c';x.fillRect(20,hpY,barsW*(p.hp/p.maxHp),10);
    // xp
    x.fillStyle='#24374d';x.fillRect(20,xpY,barsW,8);
    x.fillStyle='#69f0c9';x.fillRect(20,xpY,barsW*(g.xp/g.nextXp),8);
    const ot=objectiveText();
    x.fillStyle='rgba(8,12,19,.62)';
    x.fillRect(14,hudBottom+4,W-28,26);
    x.fillStyle='#d7ffe8';
    x.font='600 12px Trebuchet MS,sans-serif';
    x.fillText(ot,22,hudBottom+21);

    if(g.start&&!g.dead){
      const drawAb=(by,col,prog,active,sec,kind)=>{
        x.fillStyle='rgba(8,12,19,.92)';x.fillRect(abX,by,ab,ab);
        x.strokeStyle=active?col:'rgba(129,157,187,.7)';x.lineWidth=2;x.strokeRect(abX+.5,by+.5,ab-1,ab-1);
        x.strokeStyle='rgba(72,88,109,.85)';x.lineWidth=3;
        x.beginPath();x.arc(abX+ab*.5,by+ab*.5,ab*.34,0,Math.PI*2);x.stroke();
        x.strokeStyle=col;
        x.beginPath();x.arc(abX+ab*.5,by+ab*.5,ab*.34,-Math.PI*.5,-Math.PI*.5+Math.PI*2*clamp(prog,0,1));x.stroke();
        x.fillStyle=col;
        if(kind<1){
          x.beginPath();
          x.moveTo(abX+ab*.49,by+ab*.19);
          x.lineTo(abX+ab*.35,by+ab*.53);
          x.lineTo(abX+ab*.49,by+ab*.53);
          x.lineTo(abX+ab*.39,by+ab*.82);
          x.lineTo(abX+ab*.67,by+ab*.41);
          x.lineTo(abX+ab*.51,by+ab*.41);
          x.closePath();x.fill();
        }else{
          x.beginPath();x.arc(abX+ab*.5,by+ab*.44,ab*.1,0,Math.PI*2);x.fill();
          x.beginPath();
          x.moveTo(abX+ab*.5,by+ab*.2);
          x.bezierCurveTo(abX+ab*.69,by+ab*.45,abX+ab*.64,by+ab*.67,abX+ab*.5,by+ab*.78);
          x.bezierCurveTo(abX+ab*.36,by+ab*.67,abX+ab*.31,by+ab*.45,abX+ab*.5,by+ab*.2);
          x.fill();
        }
        if(sec>0){
          x.fillStyle='#dce8ff';x.font='700 10px Trebuchet MS,sans-serif';
          x.fillText(sec.toFixed(1)+'s',abX+8,by+ab-6);
        }else if(active){
          x.fillStyle='rgba(255,255,255,.8)';x.beginPath();x.arc(abX+ab-8,by+8,3,0,Math.PI*2);x.fill();
        }
      };
      const zp=p.zcd>0?1-p.zcd/p.zCool:(p.zr?1:p.zc/p.zLoad);
      drawAb(zY,'#8fffe5',zp,p.zt>0,p.zcd>0?p.zcd:0,0);
      const tp=p.mkOn?(p.mkT>0?1-p.mkT/p.mkI:1):0;
      drawAb(tY,p.cat?(p.catM?'#8fdd73':'#d9e87a'):'#f4d96e',tp,p.mkS>0,p.mkOn&&p.mkT>0?p.mkT:0,1);
      if(p.cat){
        x.fillStyle='rgba(7,10,16,.75)';
        x.fillRect(abX-56,tY+12,50,20);
        x.fillStyle='#dce8ff';x.font='600 10px Trebuchet MS,sans-serif';
        x.fillText(p.catM?'corr':'stick',abX-50,tY+25);
      }
    }

    if(g.msgT>0){
      x.fillStyle='rgba(8,12,19,.74)';x.fillRect(14,hudBottom+34,W-28,28);
      x.fillStyle='#d7ffe8';x.font='600 13px Trebuchet MS,sans-serif';x.fillText(g.msg,22,hudBottom+53);
    }
    if(g.start&&!g.dead&&!g.lvup&&!g.pz){
      const kx=joy.x+joy.tx,ky=joy.y+joy.ty;
      x.fillStyle='rgba(7,11,17,.42)';
      x.beginPath();x.arc(joy.x,joy.y,joy.r+8,0,Math.PI*2);x.fill();
      x.strokeStyle='rgba(158,200,255,.45)';x.lineWidth=2;
      x.beginPath();x.arc(joy.x,joy.y,joy.r,0,Math.PI*2);x.stroke();
      x.fillStyle='rgba(105,240,201,'+(touchMove?.65:.42)+')';
      x.beginPath();x.arc(kx,ky,joy.kr,0,Math.PI*2);x.fill();
      x.strokeStyle='rgba(220,248,255,.65)';x.lineWidth=1.5;
      x.beginPath();x.arc(kx,ky,joy.kr,0,Math.PI*2);x.stroke();
    }

    if(!g.start){
      const ix=20,iy=H*.16,iw=W-40,ih=H*.68,tx=ix+16;
      x.fillStyle='rgba(6,9,14,.86)';x.fillRect(ix,iy,iw,ih);
      x.fillStyle='#fff';x.font='700 30px Trebuchet MS,sans-serif';x.fillText('what the dog doing',tx,iy+44);
      x.fillStyle='#d8e6ff';x.font='600 16px Trebuchet MS,sans-serif';
      x.fillStyle='#69f0c9';x.font='700 23px Trebuchet MS,sans-serif';x.fillText('tap/space start',tx,iy+178);
    }

    if(g.lvup&&!g.dead){
      x.fillStyle='rgba(6,10,15,.16)';x.fillRect(0,0,W,H);
      const ly=getChoiceLayout(),bx=ly.bx,by=ly.by,bw=ly.bw,bh=ly.bh,rects=ly.rects,mobile=ly.mobile;
      x.fillStyle='rgba(17,29,45,.95)';rr(bx,by,bw,bh,16);x.fill();
      x.strokeStyle='rgba(90,125,163,.8)';x.lineWidth=1.2;rr(bx+.5,by+.5,bw-1,bh-1,16);x.stroke();
      x.fillStyle='#ecf3ff';x.font=(mobile?'700 18px':'700 20px')+' Trebuchet MS,sans-serif';x.fillText('SKILL BOOK',bx+14,by+24);
      x.fillStyle='#9ec8ff';x.font='600 12px Trebuchet MS,sans-serif';x.fillText('choose',bx+14,by+39);

      for(let i=0;i<3;i++){
        const u=g.choices[i],r=rects[i];
        const a=clamp((g.cardT-i*.07)/.28,0,1),sc=.9+.1*eob(a);
        const ox=r.x+r.w*.5,oy=r.y+r.h*.5;
        x.save();
        x.translate(ox,oy);x.scale(sc,sc);x.translate(-ox,-oy);
        x.fillStyle='rgba(27,44,66,.96)';rr(r.x,r.y,r.w,r.h,10);x.fill();
        x.strokeStyle='rgba(116,150,186,.85)';x.lineWidth=1.2;rr(r.x+.5,r.y+.5,r.w-1,r.h-1,10);x.stroke();
        if(u){
          const icon=upIcon(u.n);
          const head=icon+' '+u.n;
          let fs=mobile?16:17;
          for(;fs>12;fs--){
            x.font='700 '+fs+'px Trebuchet MS,sans-serif';
            if(x.measureText(head).width<=r.w-22)break;
          }
          x.fillStyle='#eef5ff';x.fillText(head,r.x+12,r.y+30);
          x.fillStyle='#a9c3e2';x.font='600 12px Trebuchet MS,sans-serif';
          drawWrap(u.d,r.x+12,r.y+48,r.w-24,14,2);
        }
        x.restore();
      }
      x.fillStyle='#95bce8';x.font='600 12px Trebuchet MS,sans-serif';
      x.fillText('tap or 1/2/3',bx+14,by+bh-12);
    }
    if(g.pz&&!g.dead&&!g.lvup&&g.start){
      const l=puzzleLayout(),pz=g.pz;
      x.fillStyle='rgba(5,9,14,.5)';x.fillRect(0,0,W,H);
      x.fillStyle='rgba(16,24,37,.96)';rr(l.bx,l.by,l.bw,l.bh,14);x.fill();
      x.strokeStyle='rgba(106,145,185,.85)';x.lineWidth=1.2;rr(l.bx+.5,l.by+.5,l.bw-1,l.bh-1,14);x.stroke();
      x.fillStyle='#ecf3ff';x.font='700 19px Trebuchet MS,sans-serif';
      x.fillText(pz.id==='nsh'?'nsh':'mel',l.bx+14,l.by+27);
      if(pz.id==='nsh'){
        x.fillStyle='#dce8ff';x.font='600 12px Trebuchet MS,sans-serif';x.fillText('order',l.bx+14,l.by+66);
        for(let i=0;i<pz.seq.length;i++){
          const cx=l.bx+24+i*34,cy=l.by+86,done=i<pz.step;
          x.fillStyle=done?'#8cffc2':'#79d7ff';x.beginPath();x.arc(cx,cy,12,0,Math.PI*2);x.fill();
          x.fillStyle='#12243a';x.font='700 11px Trebuchet MS,sans-serif';x.fillText((pz.seq[i]+1)+'',cx-3,cy+4);
        }
      }else{
        const cols=['#8fd3ff','#ffd58f','#ff9fb7'];
        x.fillStyle='#dce8ff';x.font='600 12px Trebuchet MS,sans-serif';x.fillText('mix',l.bx+14,l.by+66);
        for(let i=0;i<pz.seq.length;i++){
          const cx=l.bx+24+i*30,cy=l.by+86,done=i<pz.step;
          x.fillStyle=cols[pz.seq[i]];x.beginPath();x.arc(cx,cy,10,0,Math.PI*2);x.fill();
          if(done){x.strokeStyle='#8cffc2';x.lineWidth=2;x.beginPath();x.arc(cx,cy,12,0,Math.PI*2);x.stroke();}
        }
      }
      for(let i=0;i<3;i++){
        const bt=l.btn[i];
        x.fillStyle=pz.id==='nsh'?'rgba(37,87,129,.96)':['#3c6588','#9a6f3f','#8e4f64'][i];
        rr(bt.x,bt.y,bt.w,bt.h,10);x.fill();
        x.strokeStyle='rgba(196,223,255,.72)';x.lineWidth=1.1;rr(bt.x+.5,bt.y+.5,bt.w-1,bt.h-1,10);x.stroke();
        x.fillStyle='#eef5ff';x.font='700 13px Trebuchet MS,sans-serif';
        x.fillText(pz.id==='nsh'?'terminal '+(i+1):['blue','amber','rose'][i],bt.x+9,bt.y+28);
      }
      x.fillStyle='#9ec8ff';x.font='600 11px Trebuchet MS,sans-serif';
      x.fillText('tap or 1/2/3',l.bx+14,l.by+l.bh-10);
    }

    if(g.dead){
      x.fillStyle='rgba(5,8,13,.86)';x.fillRect(24,H*.24,W-48,H*.5);
      x.fillStyle='#ff8298';x.font='700 33px Trebuchet MS,sans-serif';x.fillText('GAME OVER',W*.5-98,H*.38);
      x.fillStyle='#dce8ff';x.font='600 20px Trebuchet MS,sans-serif';x.fillText('Kills '+g.kills,W*.5-43,H*.47);
      x.fillText('Best '+g.best,W*.5-37,H*.53);
      x.fillStyle='#69f0c9';x.font='700 24px Trebuchet MS,sans-serif';x.fillText('tap/space retry',W*.5-78,H*.65);
    }
  }

  function frame(ts){if(!last)last=ts;let dt=(ts-last)*.001;last=ts;dt=Math.max(0,Math.min(.034,dt));update(dt);draw();requestAnimationFrame(frame)}

  function maybeStart(){if(!audio)audio=new (window.AudioContext||window.webkitAudioContext)();if(!g.start){g.start=1;reset(1);beep(430,.05,'triangle',.02)}}

  function pointerDown(e){
    if(touchId>=0&&touchId!==e.pointerId)return;
    touchId=e.pointerId;c.setPointerCapture(touchId);
    maybeStart();
    if(g.dead){reset(1);beep(360,.05,'triangle',.02);return}
    if(g.lvup){pickByPos(e.clientX,e.clientY);return}
    if(g.pz){
      const l=puzzleLayout();
      for(let i=0;i<3;i++){
        const bt=l.btn[i];
        if(e.clientX>=bt.x&&e.clientX<=bt.x+bt.w&&e.clientY>=bt.y&&e.clientY<=bt.y+bt.h){puzzleInput(i);return}
      }
      return;
    }
    if(g.start&&!g.dead&&p.cat&&territoryBoxHit(e.clientX,e.clientY)){toggleCatalyst();return}
    if(joyHit(e.clientX,e.clientY)){touchMove=1;joySet(e.clientX,e.clientY)}
  }
  function pointerMove(e){if(touchId!==e.pointerId||!g.start||g.dead||g.lvup)return;if(touchMove||joyHit(e.clientX,e.clientY)){touchMove=1;joySet(e.clientX,e.clientY)}}
  function pointerUp(e){if(touchId!==e.pointerId)return;touchMove=0;joyReset();if(c.hasPointerCapture(touchId))c.releasePointerCapture(touchId);touchId=-1}

  function pickByPos(sx,sy){
    if(!g.lvup)return;
    const rects=getChoiceLayout().rects;
    for(let i=0;i<rects.length;i++){
      const r=rects[i];
      if(sx>=r.x&&sx<=r.x+r.w&&sy>=r.y&&sy<=r.y+r.h){takeChoice(i);break}
    }
  }

  function keyDown(e){
    const k=e.code;
    if(k==='Space'||k==='ArrowUp'||k==='ArrowDown'||k==='ArrowLeft'||k==='ArrowRight')e.preventDefault();
    if(k==='Space'||k==='Enter')maybeStart();
    if(g.dead&&(k==='Space'||k==='Enter'||k==='KeyR')){reset(1);beep(360,.05,'triangle',.02);return}
    if(g.lvup){if(k==='Digit1')takeChoice(0);else if(k==='Digit2')takeChoice(1);else if(k==='Digit3')takeChoice(2);return}
    if(g.pz){
      if(k==='Digit1')puzzleInput(0);
      else if(k==='Digit2')puzzleInput(1);
      else if(k==='Digit3')puzzleInput(2);
      return;
    }
    if(!g.start||g.dead)return;
    if(k==='KeyQ'){toggleCatalyst();return}
    if(k==='KeyA'||k==='ArrowLeft')keys.l=1;
    else if(k==='KeyD'||k==='ArrowRight')keys.r=1;
    else if(k==='KeyW'||k==='ArrowUp')keys.u=1;
    else if(k==='KeyS'||k==='ArrowDown')keys.d=1;
    else if(k==='KeyE'||k==='ShiftLeft'||k==='ShiftRight')keys.gr=1;
  }

  function keyUp(e){
    const k=e.code;
    if(k==='KeyA'||k==='ArrowLeft')keys.l=0;
    else if(k==='KeyD'||k==='ArrowRight')keys.r=0;
    else if(k==='KeyW'||k==='ArrowUp')keys.u=0;
    else if(k==='KeyS'||k==='ArrowDown')keys.d=0;
    else if(k==='KeyE'||k==='ShiftLeft'||k==='ShiftRight')keys.gr=0;
  }

  addEventListener('resize',resize);
  addEventListener('keydown',keyDown);
  addEventListener('keyup',keyUp);
  c.addEventListener('pointerdown',pointerDown,{passive:1});
  c.addEventListener('pointermove',pointerMove,{passive:1});
  c.addEventListener('pointerup',pointerUp,{passive:1});
  c.addEventListener('pointercancel',pointerUp,{passive:1});

  resize();
  reset(1);
  requestAnimationFrame(frame);
})();
</script>
</body>
</html>
